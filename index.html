<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive English Stories</title>
    
    <!-- Enlace al Manifest para la PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Color de la barra de estado en móviles -->
    <meta name="theme-color" content="#111827">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos base para el cuerpo, optimizados para la vista de escritorio */
        :root {
            --story-font-size-multiplier: 1.0; /* Variable CSS para el tamaño de la fuente */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
        }
        /* En pantallas md y superiores, usamos flexbox para centrar el contenedor de la app */
        @media (min-width: 768px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 2rem;
            }
        }

        #install-app-btn {
            display: none; /* Oculto por defecto, se mostrará con JS si es instalable */
        }

       .hidden { display: none !important; }
        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2), 0 4px 6px -4px rgba(79, 70, 229, 0.2);
            border-color: #4A5568;
        }        
        .filter-btn { transition: all 0.2s ease-in-out; }
        .filter-btn.active { background-color: #4f46e5; color: white; border-color: #ffffff; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .word { position: relative; transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out, box-shadow 0.1s ease-in-out; padding: 2px 1px; border-radius: 3px; cursor: pointer; }
        .word.active {
            background-color: rgba(10, 10, 10, 0.4);
            box-shadow: 0 0 0 1.5px #8B5CF6;
            color: #FFFFFF;
        }
        .word.phrasal-verb {
            background-color: rgba(167, 139, 250, 0.15);
            padding: 2px 4px;
            white-space: nowrap;
        }
        .word.phrasal-verb.active {
            background-color: rgba(139, 92, 246, 0.2);
        }
        
        .play-button-shadow { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }

        .dynamic-tooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.95);
            color: #FBBF24;
            border: 1px solid #3B82F6;
            border-radius: 6px;
            padding: 4px 8px; /* Más angosto */
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; /* Transición más suave */
            backdrop-filter: blur(4px);
            max-width: 120px; /* Ancho máximo para que el texto se divida en líneas */
            text-align: center; /* Centrar texto si se divide */
            --vertical-transform: -140%; /* Variable para el desplazamiento vertical */
        }
        .dynamic-tooltip {
            transform: translate(-50%, -120%);
        }
        .dynamic-tooltip.visible {
            opacity: 1;
            transform: translate(-50%, var(--vertical-transform)); /* Usa la variable para la posición final */
        }
        .dynamic-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #3B82F6 transparent transparent transparent;
        }

        #story-text-en {
            font-size: calc(1.45rem * var(--story-font-size-multiplier));
            line-height: calc(1.5 * var(--story-font-size-multiplier));
        }
        @media (min-width: 768px) {
            #story-text-en {
                font-size: calc(1.5rem * var(--story-font-size-multiplier));
            }
        }


        #modal-content .grammar-section h3, #modal-content .vocabulary-section h3 {
            color: #a78bfa; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem;
            border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;
        }
        #modal-content .grammar-section p, #modal-content .vocabulary-section p { margin-bottom: 1rem; line-height: 1.6; color: #d1d5db; }
        #modal-content strong, #modal-content b { color: #c4b5fd; font-weight: 600; }
        #modal-content code { background-color: #374151; color: #f9fafb; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .story-status-badge {
            position: absolute; bottom: 0.5rem; right: 0.5rem; z-index: 10; padding: 0.15rem 0.6rem;
            font-size: 0.7rem; font-weight: 700; color: white; border-radius: 9999px; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .activity-progress-badge {
            padding: 2px 8px; font-size: 0.7rem; font-weight: 600; border-radius: 9999px; color: white;
        }
        .badge-gray { background-color: #4b5563; color: #d1d5db; }
        .badge-yellow { background-color: #ca8a04; } /* Adjusted yellow for better contrast */
        .badge-green { background-color: #16a34a; }

        .word-draggable {
            padding: 10px 18px;
            /* background-color: #374151; */ /* <-- ELIMINADO */
            border-radius: 8px;
            cursor: grab;
            transition: background-color 0.2s ease-in-out,
                        border-color 0.2s ease-in-out,
                        opacity 0.2s ease-in-out,
                        transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            user-select: none;
            border-bottom: 4px solid; /* <-- MODIFICADO */
            font-weight: 600;
            color: white;
        }
        .word-draggable.moving {
            opacity: 0 !important;
            transition: none !important; /* Desactiva transiciones temporalmente */
        }


        .wd-color-1 { background-color: #7f1d1d; border-bottom-color: #450a0a; }
        .wd-color-2 { background-color: #14532d; border-bottom-color: #052e16; }
        .wd-color-3 { background-color: #1e3a8a; border-bottom-color: #1e1b4b; }
        .wd-color-4 { background-color: #3730a3; border-bottom-color: #312e81; }
        .wd-color-5 { background-color: #581c87; border-bottom-color: #3b0764; }
        .wd-color-6 { background-color: #134e4a; border-bottom-color: #042f2e; }
        .wd-color-7 { background-color: #334155; border-bottom-color: #1e293b; }


        .word-draggable:active { cursor: grabbing; transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .word-draggable.dragging { opacity: 0.4; transform: scale(0.95); }
        .word-draggable.correct { background-color: #166534; border-color: #14532d; cursor: default; }
        #jumbled-drop-zone.drag-over { border-color: #8B5CF6; background-color: #374151; }
        .word-translation { display: block; font-size: 0.75rem; color: #a5b4fc; margin-top: 2px; font-style: italic; }

        #quiz-timer-container {
            width: 100%; background-color: #374151; border-radius: 9999px; overflow: hidden;
            height: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        #quiz-timer-bar {
            height: 100%; border-radius: 9999px; transition: width 1s linear, background-color 0.5s;
        }
        .quiz-option-btn {
            width: 100%; text-align: left; padding: 10px 16px; background-color: #4b5563; border-radius: 8px; 
            font-weight: 600; transition: all 0.2s ease-in-out; border-left: 5px solid transparent;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
        }
        .quiz-option-btn:not(:disabled):hover { background-color: #6b7280; transform: translateY(-2px); border-left-color: #8B5CF6; }
        .quiz-option-btn:disabled { opacity: 0.7; }
        .quiz-option-btn.correct-answer { background-color: #16a34a; border-left-color: #bbf7d0; color: white; animation: pulse-correct 0.8s; }
        .quiz-option-btn.wrong-answer { background-color: #dc2626; border-left-color: #fecaca; color: white; animation: shake 0.5s; }
        @keyframes pulse-correct { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        #memory-grid {
            display: grid;
            gap: 0.75rem; 
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            perspective: 1000px;
        }
        .memory-card {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        
        }
        .memory-card.is-flipped { transform: rotateY(180deg); }
        .memory-card.is-matched { cursor: default; animation: vanish-effect 0.6s ease-in 0.2s forwards; }
        @keyframes vanish-effect { to { opacity: 0; transform: scale(0.9); } }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 0.75rem; box-shadow: 0 4px 10px rgba(0,0,0,0.4); overflow: hidden;
        }
        .card-front { background: linear-gradient(135deg, #4f46e5, #8b5cf6); display: flex; align-items: center; justify-content: center; }
        .card-front-icon { width: 50%; height: 50%; color: rgba(255,255,255,0.8); }
        .card-back { background-color: #374151; transform: rotateY(180deg); display: flex; flex-direction: column; }
        .card-back-image { height: 80%; width: 100%; object-fit: cover; }
        .card-back-text-container {
            height: 20%; padding: 4px; display: flex; flex-direction: column; 
            justify-content: center; text-align: center; background-color: #1f2937;
        }
        .card-back-word { font-size: 0.8rem; font-weight: 700; line-height: 1.1; color: #e5e7eb; }
        .card-back-translation { font-size: 0.65rem; color: #a5b4fc; font-style: italic; }
        
        .letter-slot {
            width: 40px; height: 50px; background-color: #1f2937; border-bottom: 3px solid #4b5563; border-radius: 6px;
            display: inline-flex; justify-content: center; align-items: center; font-size: 1.5rem;
            font-weight: 700; text-transform: uppercase; transition: all 0.2s ease-in-out; user-select: none;
        }
        #fill-blanks-word-container.correct .letter-slot { background-color: #166534; border-color: #14532d; color: #dcfce7; }
        .letter-choice {
            width: 45px; height: 45px; background-color: #4b5563; border-radius: 8px;
            border-bottom: 3px solid #374151; font-weight: 600; font-size: 1.1rem; transition: all 0.15s ease-in-out;
        }
        .letter-choice:not(:disabled):hover { background-color: #6b7280; transform: translateY(-2px); }
        .letter-choice:disabled { opacity: 0.3; background-color: #374151; border-bottom-width: 1px; }
        #fill-blanks-delete-btn { padding: 0.5rem 1rem; background-color: #be123c; border-radius: 8px; font-weight: 600; }

        /* Estilos para el mini-juego de deletreo en el modal */
        .spelling-slot {
            width: 35px; height: 45px; background-color: #1f2937; border-bottom: 3px solid #4b5563; border-radius: 6px;
            display: inline-flex; justify-content: center; align-items: center; font-size: 1.5rem;
            font-weight: 700; text-transform: uppercase; transition: all 0.2s ease-in-out; user-select: none;
        }
        .spelling-choices button {
            width: 40px; height: 40px; background-color: #4b5563; border-radius: 8px;
            border-bottom: 3px solid #374151; font-weight: 600; font-size: 1.1rem; transition: all 0.15s ease-in-out;
        }
        .spelling-choices button:not(:disabled):hover {
            background-color: #6b7280; transform: translateY(-2px);
        }
        .spelling-choices button:disabled {
            opacity: 0.3; background-color: #374151; border-bottom-width: 1px;
        }

        #word-modal-spelling-slots.correct .spelling-slot {
            background-color: #166534; border-color: #14532d; color: #dcfce7;
        }

        
        /* Estilo para palabras aprendidas en la historia */
        .word.learned-word {
            background-color: rgba(250, 204, 21, 0.2);
            color: #facc15;
            border-radius: 4px;
            padding: 2px 4px;
        }

        @keyframes ken-burns-effect {
          0% { transform: scale(1.1) translate(0, 0); transform-origin: 50% 50%; }
          25% { transform: scale(1.15) translate(2%, -2%); transform-origin: top left; }
          50% { transform: scale(1.1) translate(-2%, 3%); transform-origin: bottom right; }
          75% { transform: scale(1.2) translate(3%, -1%); transform-origin: top right; }
          100% { transform: scale(1.1) translate(0, 0); transform-origin: 50% 50%; }
        }
        #story-image { animation: ken-burns-effect 30s ease-in-out infinite alternate; }

        /* Estilos para el nuevo modo de traducción */
        #translation-btn.active {
            background-color: #4f46e5;
            border-color: #a78bfa;
            color: white;
        }
        .word-block {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            background-color: #374151;
            border-radius: 0.375rem;
            padding: 2px 6px;
            margin: 1px 2px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            vertical-align: bottom;
            font-size: 1rem;
            
        }
        .word-block .word-en {
            font-weight: 500;
            color: white;
            line-height: 1.2;
        }
        .word-block .word-es {
            font-size: 0.65em;
            color: #a5b4fc;
            font-style: italic;
            line-height: 1.1;
        }
        .word-block.active {
            background-color: #4338ca;
            box-shadow: 0 0 0 2px #8B5CF6;
        }


        @media (max-width: 640px) {
            #game-modal-title { font-size: 1.125rem; }
            #game-modal-subtitle { font-size: 0.75rem; }
            #memory-grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 0.4rem; }
            .card-back-word { font-size: 0.7rem; }
            .card-back-translation { font-size: 0.6rem; }
            .letter-slot { width: 32px; height: 40px; font-size: 1.25rem; }
            .letter-choice { width: 38px; height: 38px; font-size: 1rem; }
            #fill-blanks-sentence { font-size: 2.1rem; }
        }


#app-container {
  
    perspective: 1500px; /* <-- AÑADE ESTA LÍNEA PARA EL EFECTO 3D */
    position: relative;
}



/* --- NUEVOS ESTILOS PARA ANIMACIÓN DE PÁGINA TIPO LIBRO 3D --- */
@keyframes flip-out-next {
    from { transform: rotateY(0deg); }
    to { transform: rotateY(-90deg); }
}
@keyframes flip-in-next {
    from { transform: rotateY(90deg); }
    to { transform: rotateY(0deg); }
}
@keyframes flip-out-prev {
    from { transform: rotateY(0deg); }
    to { transform: rotateY(90deg); }
}
@keyframes flip-in-prev {
    from { transform: rotateY(-90deg); }
    to { transform: rotateY(0deg); }
}

#story-view.page-flip-out-next {
    transform-origin: left center; /* La página gira desde la "bisagra" izquierda */
    animation: flip-out-next 0.4s ease-in forwards;
}
#story-view.page-flip-in-next {
    transform-origin: left center;
    animation: flip-in-next 0.4s ease-out;
}
#story-view.page-flip-out-prev {
    transform-origin: right center; /* La página gira desde la "bisagra" derecha */
    animation: flip-out-prev 0.4s ease-in forwards;
}
#story-view.page-flip-in-prev {
    transform-origin: right center;
    animation: flip-in-prev 0.4s ease-out;
}


/* --- NUEVOS ESTILOS DE BOTONES MÁS PROFESIONALES Y OPTIMIZADOS --- */

/* Estilo para los botones de Gramática, Vocabulario, etc. */
.static-glow-purple {
    /* 1. Fondo: Un gradiente índigo profundo y vibrante que reemplaza el bg-black/30. */
    background: linear-gradient(145deg, #4f46e5, #3730a3); /* De índigo-600 a índigo-800 */
    
    /* 2. Borde: Más grueso y de un color neón para un look moderno. */
    border: 2px solid #ffffff; /* violet-400 */
    
    /* 3. Sombra (Glow): Una sombra exterior pronunciada y una interior sutil para dar profundidad. */
    box-shadow: 0 0 15px 2px rgba(139, 92, 246, 0.5), /* Sombra exterior (el brillo) */
                inset 0 0 6px rgba(221, 214, 254, 0.3); /* Sombra interior (efecto cristal) */

    /* 4. Texto: Blanco, más grueso y con sombra para máxima legibilidad. */
    color: white !important; /* !important para asegurar que sobreescriba a text-white de Tailwind */
    font-weight: 800; /* Hacemos el texto extragrueso */
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.4);

    /* 5. Transformación: Lo hacemos resaltar un poco más. */
    transform: scale(1.02);
    
    /* 6. Transición: Suaviza todos los cambios para un efecto pulido. */
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Estilo para el botón de Actividades, con un look dorado/legendario. */
.static-glow-activities {
    background: linear-gradient(145deg, #f59e0b, #b45309); /* De ámbar-500 a ámbar-700 */
    border: 2px solid #ffffff; /* yellow-300 */
    box-shadow: 0 0 18px 3px rgba(250, 204, 21, 0.6), /* Sombra exterior dorada más intensa */
                inset 0 0 7px rgba(254, 249, 195, 0.4); /* Brillo interior */
    color: white !important;
    font-weight: 800;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    transform: scale(1.03);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}




.static-glow-purple, .static-glow-activities {
    position: relative; /* Necesario para posicionar el pseudo-elemento */
    z-index: 1; /* Asegura que el botón esté por encima del efecto */
   
}



/* --- NUEVOS ESTILOS PARA EFECTO DE ESTRELLAS (VERSIÓN 3) --- */
.star-particle {
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    width: 16px;
    height: 16px;

    /* Usa imagen base64 o ruta a tu PNG */
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="gold"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9"/></svg>');
    background-size: cover;

    will-change: transform, opacity;
    transform: translate(0, 0) scale(1);
    opacity: 1;

    animation: sparkle-out 1.6s ease-out forwards;
}


@keyframes sparkle-out {
    0% {    
        opacity: 1;
        transform: translate(var(--tx-start), var(--ty-start)) scale(1.1) rotate(0deg);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx-end), var(--ty-end)) scale(0) rotate(var(--rotation));
    }
}




 .word-draggable.hint-highlight {
            background-color: #f59e0b; /* amber-500 */
            border-color: #fcd34d; /* amber-300 */
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
        }

.word-draggable.hint-highlight {
            background-color: #f59e0b; /* amber-500 */
            border-color: #fcd34d; /* amber-300 */
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
        }

        /* === INICIA EL BLOQUE A AÑADIR === */
        #jumbled-bank-wrapper {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 0.5rem; 
            overflow: hidden; 
            margin-top: 1rem; /* Añade un poco de espacio */
            min-height: 150px; /* Asegura una altura mínima */
        }
        #jumbled-bank-wrapper::before {
            content: '';
            position: absolute;
            inset: 0;
            /* bg-gray-900 con 85% opacidad */
            background-color: rgba(17, 24, 39, 0.85); 
            z-index: 1;
        }
        #jumbled-word-bank {
            position: relative; /* Para que se ponga sobre el overlay */
            z-index: 2;
            padding: 1rem; /* Añade padding para que no toque los bordes */
        }



/* --- ESTILOS PARA EL JUEGO DE SOPA DE LETRAS (WORD SEARCH) --- */
#wordsearch-container {
    display: flex;
    flex-direction: column;
    
    height: 100%;
}
@media (min-width: 640px) {
    #wordsearch-container {
        flex-direction: row;
    }
}

#wordsearch-grid-wrapper {
    flex-grow: 1;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    min-height: 0;
}

#wordsearch-grid {
    display: grid;
    background-color: #1f2937;
    border: 2px solid #4b5563;
    border-radius: 0.75rem;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
    aspect-ratio: 1 / 1;
    max-width: 100%;
    max-height: 100%;
    padding: 0.5rem;
    gap: 2px;
    box-sizing: border-box;
}
.letter-cell {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: clamp(1rem, 5vw, 1.75rem); /* Letras grandes y responsivas */
    font-weight: 800;
    text-transform: uppercase;
    color: #d1d5db;
    background-color: #374151;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s ease-out;
}
.letter-cell:hover {
    background-color: #4f46e5;
    color: white;
}
.letter-cell.selecting {
    background-color: #8b5cf6;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.7);
}
.letter-cell.found {
    color: white;
    transform: scale(1.05);
}
/* Colores bonitos para resaltar palabras encontradas */
.letter-cell.found-0 { background: linear-gradient(45deg, #ec4899, #f472b6); }
.letter-cell.found-1 { background: linear-gradient(45deg, #84cc16, #a3e635); }
.letter-cell.found-2 { background: linear-gradient(45deg, #22d3ee, #67e8f9); }
.letter-cell.found-3 { background: linear-gradient(45deg, #f97316, #fb923c); }
.letter-cell.found-4 { background: linear-gradient(45deg, #14b8a6, #2dd4bf); }
.letter-cell.found-5 { background: linear-gradient(45deg, #fde047, #fef08a); color: #444; }
.letter-cell.found-6 { background: linear-gradient(45deg, #ef4444, #f87171); }
.letter-cell.found-7 { background: linear-gradient(45deg, #a78bfa, #c4b5fd); }

#wordsearch-sidebar {
    flex-shrink: 0;
    width: 100%;
   
    background-color: #111827;
    border-radius: 0.5rem;
    
}
@media (min-width: 640px) {
    #wordsearch-sidebar {
        width: 220px;
         max-height: none;   /* AÑADIDO: Quita el límite de altura en escritorio */
        overflow-y: visible;
    }
}
#wordsearch-word-list {
     /* --- INICIO DE LA CORRECCIÓN --- */
    display: grid; /* MODIFICADO: Usamos Grid para un diseño más compacto */
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); /* AÑADIDO: Crea columnas automáticas */
    gap: 0.35rem; /* MODIFICADO: Ajustamos el espaciado para la cuadrícula */
    /* --- FIN DE LA CORRECCIÓN --- */
}
@media (min-width: 640px) {
    #wordsearch-word-list {
         display: flex; /* Mantenemos flex para la vista de escritorio */
        flex-direction: column;
        gap: 0.75rem;
    }
}
.word-item {
    padding: 0.1rem 0.1rem;
    background-color: #374151;
    border-radius: 6px;
    border-left: 4px solid #4b5563;
    transition: all 0.2s ease-in-out;
    font-size: 0.3rem;
}
.word-item.found {
    border-left-color: #16a34a;
    background-color: #1f2937;
}
.word-item.found .word-en-ws {
    text-decoration: line-through;
    color: #6b7280;
}

/* --- AÑADE ESTE NUEVO ESTILO AQUÍ --- */
.phrase-part.part-found {
    background-color: #4f46e5; /* indigo-600 */
    color: #ffffff;
    padding: 1px 4px;
    border-radius: 4px;
    transition: all 0.3s ease-in-out;
}
/* -------------------------------------- */


.word-item.found .word-es-ws {
    color: #4b5563;
}
.word-en-ws {
    font-size: 0.6rem;
    font-weight: 700;
    color: #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
.word-es-ws {
    display: block;
    font-size: 0.7rem; /* MODIFICADO: Letra de traducción más pequeña */
    color: #a5b4fc;
    font-style: italic;
    margin-top: 1px; /* MODIFICADO: Reducido el margen superior */
}
#wordsearch-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 1rem;
    font-size: 1.2rem;
    color: #9ca3af;
}



#stl-reconstructed-wrapper {
    background-size: cover;
    background-position: center center;
}
#stl-reconstructed-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background-color: rgba(17, 24, 39, 0.7); /* bg-gray-900 con 70% opacidad */
    z-index: 5;
}


.stl-flying-fragment {
    position: absolute;
    z-index: 100;
    font: bold 15px "Inter", sans-serif;
    color: #4ade80; /* Verde de acierto */
    padding: 5px 10px;
    background-color: rgba(17, 24, 39, 0.7);
    border-radius: 8px;
    text-align: center;
    transition: all 1.2s cubic-bezier(0.5, 0, 0.75, 0); /* Transición suave */
    pointer-events: none;
    white-space: normal;
    text-shadow: 0 0 8px rgba(74, 222, 128, 0.7);
}


/* --- ESTILO PARA PÁRRAFOS COMPLETADOS EN LA HISTORIA --- */
#text-container.paragraph-completed-glow {
    /* Un degradado sutil que va desde el fondo oscuro a un índigo profundo. */
    background: linear-gradient(160deg, #111827 0%, #312e81 100%);
    
    /* Un "brillo" interior de color violeta para dar una sensación mágica. */
    box-shadow: inset 0 0 40px -10px rgba(167, 139, 250, 0.3);

    /* Una transición suave para que el efecto aparezca y desaparezca con elegancia. */
    transition: background 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
}

    </style>
</head>
<body class="text-white bg-gray-900">
    
 <div id="update-notification" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] bg-indigo-600 text-white py-3 px-5 rounded-lg shadow-2xl flex items-center gap-4 animate-pulse">
    <p class="font-semibold">¡Nueva versión disponible!</p>
    <button id="update-btn" class="bg-white text-indigo-700 font-bold py-1 px-4 rounded-md hover:bg-indigo-100 transition-colors">Actualizar</button>
</div>  
    <audio id="story-audio"></audio>
    <audio id="background-audio" loop></audio>
    
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-40 hidden"></div>
    <div id="modal-container" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 w-11/12 max-w-lg p-4 sm:p-6 hidden flex-col max-h-[85vh]">
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
            <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div id="modal-content" class="flex-grow overflow-y-auto pr-2 text-gray-300"></div>
        <div class="mt-6 text-right flex-shrink-0">
            <button id="modal-ok-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">OK</button>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div id="settings-modal-container" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 w-11/12 max-w-sm p-4 sm:p-6 hidden flex-col">
        <div class="flex items-center justify-between mb-6 flex-shrink-0">
            <h3 class="text-xl font-bold text-white">Configuración</h3>
            <button id="settings-modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div class="flex-grow space-y-6">
            <div class="flex items-center justify-between">
                <label class="text-gray-300 font-semibold">Tamaño de letra</label>
                <div class="flex items-center gap-2 bg-gray-900 rounded-full p-1">
                    <button id="decrease-font-btn" class="w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center text-lg font-bold">-</button>
                    <span id="font-size-display" class="w-16 text-center font-mono text-indigo-300">100%</span>
                    <button id="increase-font-btn" class="w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center text-lg font-bold">+</button>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <label for="autoplay-toggle" class="text-gray-300 font-semibold">Reproducción Automática</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
            </div>
            <!-- Aquí se pueden agregar más opciones de configuración en el futuro -->
        </div>
    </div>
    
    <div id="word-modal-container" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div id="word-modal-content" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm flex flex-col text-white max-h-[90vh]">
            <!-- Contenido principal del modal que puede hacer scroll -->
            <div id="word-modal-main-content" class="p-4 sm:p-5 flex-grow overflow-y-auto">
                <!-- Vista por Defecto: Título, Traducción, Imagen -->
                <div id="word-modal-default-view">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 id="word-modal-title" class="text-2xl font-bold text-indigo-400"></h3>
                        <span id="word-modal-pos" class="text-xs font-semibold px-2 py-0.5 bg-gray-600 text-gray-200 rounded-full"></span>
                    </div>
                    <p id="word-modal-translation" class="text-lg text-gray-300 mb-3"></p>
                    <div id="word-modal-breakdown" class="hidden py-3 border-t border-b border-gray-700 mb-3"></div>
                    <div class="p-2 h-48 flex items-center justify-center bg-gray-900 rounded-lg">
                        <img id="word-modal-image" src="" alt="Word image" class="max-w-full max-h-full object-contain rounded-md hidden">
                        <p id="word-modal-image-loader" class="text-gray-400 animate-pulse">Buscando imagen...</p>
                    </div>
                </div>
    
                <!-- Vista del Juego de Deletreo (Aparece aquí cuando se activa) -->
                <div id="word-modal-spelling-view" class="hidden flex flex-col items-center justify-center gap-4 text-center">
                    <div class="w-full mb-4">
                        <div class="p-2 h-40 bg-gray-900 rounded-lg flex items-center justify-center">
                            <img id="word-modal-spelling-image" src="" alt="Word image" class="max-w-full max-h-full object-contain rounded-md hidden">
                        </div>
                        <p id="word-modal-spelling-translation" class="text-lg text-center text-gray-300 mt-2 font-semibold"></p>
                    </div>
                    <p class="text-sm text-gray-400 font-semibold">Completa la palabra:</p>
                    <div id="word-modal-spelling-slots" class="flex flex-wrap justify-center gap-2"></div>
                    <div id="word-modal-spelling-choices" class="spelling-choices max-w-xs w-full flex flex-wrap justify-center items-center gap-2 mt-4"></div>
                    <button id="word-modal-spelling-delete-btn" class="w-24 mt-2 flex items-center justify-center gap-2 py-2 px-4 bg-red-700 hover:bg-red-800 rounded-lg">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        <span>Borrar</span>
                    </button>
                </div>
            </div>
    
            <!-- Botones (Footer) -->
            <div id="word-modal-footer" class="grid grid-cols-2 gap-2 p-2 bg-gray-800/50 flex-shrink-0 border-t border-gray-700">
                 <button id="word-modal-listen-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a1 1 0 011 1v8a1 1 0 11-2 0V5a1 1 0 011-1zM13 4a1 1 0 011 1v8a1 1 0 11-2 0V5a1 1 0 011-1z"></path><path fill-rule="evenodd" d="M2 8a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm15 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zM5 8a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>Escuchar</button>
                 <button id="word-modal-continue-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-green-600 hover:bg-green-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>Continuar</button>
                 <button id="word-modal-learn-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>Aprender</button>
                 <button id="word-modal-ok-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors">OK</button>
            </div>
        </div>
    </div>
        
    <template id="jumbled-sentence-template">
        <div class="h-full flex flex-col text-center gap-1">
            <div class="flex-shrink-0 flex justify-between items-center max-w-3xl mx-auto w-full">
                <div>
                    <p class="text-base text-gray-300 mb-1 text-left">Ordena las palabras para formar la oración correcta:</p>
                    <p id="jumbled-progress" class="font-mono text-indigo-300 text-sm text-left"></p>
                </div>
                <button id="jumbled-hint-btn" class="flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-full text-sm font-bold transition-all disabled:bg-gray-600 disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                    <span>Pistas: <span id="jumbled-hints-left">3</span></span>
                </button>
            </div>
            <div id="jumbled-timer-container" class="w-full max-w-3xl mx-auto my-2" style="background-color: #374151; border-radius: 9999px; overflow: hidden; height: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);">
                <div id="jumbled-timer-bar" style="height: 100%; border-radius: 9999px; transition: width 0.5s linear, background-color 0.5s ease;"></div>
            </div>
            <div id="jumbled-drop-zone" class="min-h-[100px] w-full max-w-3xl mx-auto bg-gray-900/50 border-2 border-dashed border-gray-600 rounded-lg p-3 flex flex-wrap items-center justify-start gap-2 transition-colors"></div>
            <div id="jumbled-bank-wrapper" class="flex-grow flex items-center justify-center">
                <div id="jumbled-word-bank" class="max-w-3xl mx-auto flex flex-wrap items-center justify-center gap-4"></div>
            </div>
            <div id="jumbled-feedback" class="h-14 flex items-center justify-center"></div>
            <div class="flex-shrink-0 flex items-center justify-center gap-4 mt-auto">
                <button id="jumbled-check-btn" class="px-8 py-3 text-lg bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Comprobar</button>
                <button id="jumbled-next-btn" class="hidden px-8 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>
    <template id="quiz-game-template">
        <div class="h-full max-w-2xl mx-auto flex flex-col justify-between gap-2">
            <div class="flex-shrink-0 space-y-3">
                <div id="quiz-timer-container"><div id="quiz-timer-bar"></div></div>
                <div>
                    <p id="quiz-progress" class="text-center font-mono text-indigo-300 text-sm mb-2"></p>
<h3 id="quiz-question" class="text-3xl md:text-4xl font-bold text-center text-white"></h3>
                    <p id="quiz-question-sub" class="text-center text-gray-400 mt-1"></p>
                </div>
            </div>
             <div id="quiz-options" class="flex-grow flex flex-col justify-center items-center gap-2 sm:gap-3 py-2"></div>
            <div class="flex-shrink-0 h-16 flex flex-col items-center justify-center gap-2">
                <div id="quiz-feedback" class="h-6"></div>
                <button id="quiz-next-btn" class="hidden px-10 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>
    <template id="memory-game-template">
        <div class="h-full flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center mb-4 text-sm font-mono">
                <span>Pares: <span id="memory-pairs-found">0</span>/<span id="memory-total-pairs">0</span></span>
                <span>Fallos: <span id="memory-mismatches">0</span></span>
            </div>
            <div id="memory-loading-overlay" class="absolute inset-0 bg-gray-800/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center">
                <svg class="animate-spin h-10 w-10 text-indigo-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-lg font-semibold">Cargando imágenes...</p>
                <p class="text-sm text-gray-400" id="memory-loading-progress">0%</p>
            </div>
            <div id="memory-grid" class="flex-grow"></div>
        </div>
    </template>
    <template id="fill-blanks-template">
        <div class="h-full flex flex-col text-center gap-4">
            <div class="flex-shrink-0">
                <p id="fill-blanks-progress" class="font-mono text-indigo-300 text-sm mb-4"></p>
                <p id="fill-blanks-sentence" class="text-xl md:text-2xl leading-relaxed text-gray-300"></p>
                <p id="fill-blanks-translation" class="hidden mt-2 text-base italic text-gray-400 p-2 bg-black/20 rounded-lg"></p>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center gap-4 py-2">
                <div id="fill-blanks-choices" class="max-w-md w-full flex flex-wrap justify-center items-center gap-2"></div>
                <button id="fill-blanks-delete-btn" class="w-24 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span>Borrar</span>
                </button>
            </div>
            <div class="flex-shrink-0 h-20 flex flex-col items-center justify-center gap-2">
                <div id="fill-blanks-feedback" class="h-6"></div>
                <button id="fill-blanks-next-btn" class="hidden px-10 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>


  <template id="stop-the-line-template">
    <div class="h-full flex flex-col p-2 sm:p-4 text-center gap-4">
        
        <div id="stl-reconstructed-wrapper" class="relative flex-shrink-0 h-[30%] bg-gray-900 rounded-lg p-3 border-2 border-gray-700 flex flex-col overflow-hidden">
            
             <video id="stl-background-video" class="absolute inset-0 w-full h-full object-cover z-0 hidden" autoplay loop muted playsinline></video>
            
            <div class="relative z-10 flex-shrink-0 flex justify-between items-center bg-black/40 backdrop-blur-sm rounded-full px-3 py-1 mb-2">
                <span id="stl-paragraph-info" class="text-xs font-bold text-indigo-300">Párrafo 1</span>
                <span id="stl-failures-info" class="text-xs font-bold text-red-400">Intentos: 8/8</span>
            </div>
            <div id="stl-reconstructed-paragraph" class="relative z-10 flex-grow overflow-y-auto text-left text-gray-300 min-h-0"></div>
        </div>
        
        <div class="flex-grow flex flex-col min-h-0 gap-4">
            <div id="stl-timer-container" class="w-full h-2.5 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                <div id="stl-timer-bar" class="h-full bg-green-500 rounded-full transition-all duration-1000 linear"></div>
            </div>

            <div class="relative w-full h-full flex-grow bg-gray-900 rounded-lg border-2 border-gray-700 overflow-hidden">
                <canvas id="stl-canvas" class="w-full h-full"></canvas>
            </div>
            
            <div class="flex-shrink-0 flex items-center justify-center gap-4">
                 <button id="stl-hint-btn" class="w-1/2 max-w-xs py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition-all text-sm disabled:bg-gray-600 disabled:opacity-70">
                    Ayuda (<span id="stl-hints-left">3</span>)
                 </button>
                 <button id="stl-stop-btn" class="w-1/2 max-w-xs py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-all text-lg">¡DETENER!</button>
            </div>
        </div>

    </div>
</template>



<template id="ball-shot-template">
    <div class="h-full w-full flex flex-col items-center justify-center p-2 sm:p-4 gap-4">
        <div class="w-full max-w-3xl flex-shrink-0 flex items-center justify-between bg-gray-800 p-3 rounded-lg border border-gray-700">
            <div>
                <p class="text-sm text-gray-400">Traduce esta palabra:</p>
                <h3 id="ball-shot-current-word" class="text-2xl sm:text-3xl font-bold text-yellow-300"></h3>
            </div>
            <p id="ball-shot-progress" class="font-mono text-indigo-300 text-lg"></p>
        </div>

        <div class="w-full flex-grow relative bg-gray-900 rounded-lg border-2 border-gray-700 overflow-hidden">
            <canvas id="ball-shot-canvas" class="w-full h-full"></canvas>
            <div id="ball-shot-feedback" class="absolute inset-0 flex items-center justify-center pointer-events-none text-4xl font-extrabold"></div>
        </div>
        
        <div class="w-full max-w-3xl flex-shrink-0 flex items-center gap-4">
            <div class="flex-grow flex flex-col gap-2">
                <label for="ball-shot-power-bar" class="text-xs font-semibold uppercase tracking-wider text-gray-400">Fuerza</label>
                <div class="w-full h-6 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                    <div id="ball-shot-power-bar" class="h-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full transition-all duration-100" style="width: 0%;"></div>
                </div>
            </div>
            <button id="ball-shot-shoot-btn" class="px-8 py-5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg text-lg transition-transform active:scale-95">Lanzar</button>
            <button id="ball-shot-next-btn" class="hidden px-8 py-5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-lg">Siguiente</button>
        </div>
    </div>
</template>

    <template id="wordsearch-game-template">
        <div id="wordsearch-loading">
            <svg class="animate-spin h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p>Creando el tablero...</p>
        </div>
        <div id="wordsearch-container" class="hidden">
            <div id="wordsearch-grid-wrapper">
                <div id="wordsearch-grid"></div>
            </div>
            <div id="wordsearch-sidebar">
                <p id="wordsearch-progress" class="text-center font-mono text-indigo-300 text-sm mb-1"></p>
                <div id="wordsearch-word-list"></div>
            </div>
        </div>
    </template>

    <div id="app-container" class="w-full h-screen bg-gray-800 md:max-w-3xl md:h-[90vh] md:max-h-[850px] md:rounded-2xl md:shadow-2xl md:border md:border-gray-700 relative overflow-hidden transition-all duration-300">
        <div id="main-menu" class="h-full flex flex-col bg-gray-900">
            <div class="w-full p-4 md:p-6 flex flex-col flex-grow min-h-0">
                <!-- Container for top-right buttons -->
                    <div class="absolute top-0 right-0 flex items-center px-1 gap-2">
                        <!-- Botón de Mute para el Menú Principal -->
                        <button id="main-menu-mute-btn" class="p-1.5 bg-gray-700/50 backdrop-blur-sm rounded-full hover:bg-gray-600/70 transition-colors shadow-lg">
                            <svg id="main-menu-sound-on-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                            <svg id="main-menu-sound-off-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17L7 7m10 0L7 17"></path></svg>
                        </button>
                        <!-- Botón de Descarga PWA -->
                        <button id="install-app-btn" class="bg-indigo-600 text-white font-semibold py-1 px-1 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors flex items-center text-xs">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Descargar App</span>
                        </button>
                    </div>
                <header class="text-center mb-2 relative">
                    
                    
                    <img src="banner.png" alt="Story Books Banner" class="mx-auto  w-full max-w-[5rem]">
                    <p class="text-gray-400 text-xs mt-1">Select a story to begin</p>
                </header>
                <div id="filter-container" class="flex flex-wrap justify-center gap-2 md:gap-3 mb-2">
                    <button data-filter="todos" class="filter-btn active px-2 py-1 text-sm font-semibold bg-gray-800 rounded-full border border-white">Todos</button>
                    <button data-filter="fundamental" class="filter-btn px-2 py-1 text-sm font-semibold  rounded-full border border-white ">Fundamental</button>
                    <button data-filter="básico" class="filter-btn px-2 py-1 text-sm font-semibold  rounded-full border border-white">Básico</button>
                    <button data-filter="intermedio" class="filter-btn px-2 py-1 text-sm font-semibold  rounded-full border border-white">Intermedio</button>
                    <button data-filter="avanzado" class="filter-btn px-2 py-1 text-sm font-semibold rounded-full border border-white">Avanzado</button>
                    <button data-filter="infantiles" class="filter-btn px-2 py-1 text-sm font-semibold  rounded-full border border-white">Infantiles</button>
                    <button data-filter="noticias" class="filter-btn px-2 py-1 text-sm font-semibold rounded-full border border-white">Noticias</button>
                    <button data-filter="otros" class="filter-btn px-2 py-1 text-sm font-semibold  rounded-full border border-white">Otros</button>
                </div>
                <main id="story-list" class="flex flex-col gap-6 overflow-y-auto pb-24 flex-grow"></main>
                <p id="loading-stories" class="text-center text-gray-400">Loading stories...</p>
            </div>
            <footer id="main-menu-footer" class="absolute bottom-0 left-0 right-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm border-t border-gray-700 z-10">
                <div>
                    <div class="max-w-xl mx-auto p-2 flex items-center justify-around text-center text-xs text-gray-400">
                        <a href="https://chat.whatsapp.com/FjsQxrL3qnu32P8mdZHY0C" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Comunidad</span></a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=URL_DE_TU_APP" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z"></path></svg><span>Compartir</span></a>
                        <a href="https://youtu.be/ujZtS_EEVgA" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Tutorial</span></a>
                        <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                            <input type="hidden" name="cmd" value="_s-xclick" /><input type="hidden" name="hosted_button_id" value="NXEPDCBPD64S2" /><input type="hidden" name="currency_code" value="USD" />
                            <button type="submit" class="flex flex-col items-center hover:text-white transition-colors text-xs text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg><span>Donar</span></button>
                        </form>
                    </div>

                  
                    <div class="text-center py-1 text-[0.6rem] text-gray-600">
                        NARRION &copy; 2025 all rights reserved
                    </div>
                </div>
            </footer>
        </div>

        <div id="story-view" class="hidden h-full flex-col">
            <div class="h-[45%] relative overflow-hidden z-20">
                <header class="absolute top-0 left-0 right-0 z-20 p-0 sm:p-4 flex items-center justify-between gap-2 sm:gap-4 bg-gradient-to-b from-black/60 to-transparent">
<button id="back-btn" class="flex-shrink-0 p-2 bg-gradient-to-br from-indigo-500 to-purple-600 backdrop-blur-sm rounded-full hover:from-gray-500 hover:to-gray-600 transition-colors shadow-lg">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
  </svg>
</button>
                    <div class="flex items-center gap-2">
                        <button id="activities-btn" class="flex items-center gap-1.5 text-[0.7rem] font-semibold tracking-wider uppercase bg-blue-600/90 text-white px-4 py-[0.25rem] rounded-full backdrop-blur-sm border border-white hover:bg-blue-700 transition-colors duration-300 shadow-sm font-sans"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg><span>Actividades</span></button>
                        <button id="mute-btn" class="flex-shrink-0 p-1.5 bg-gray-700/50 backdrop-blur-sm rounded-full hover:bg-gray-600/70 transition-colors shadow-lg">
                            <svg id="sound-on-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                            <svg id="sound-off-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17L7 7m10 0L7 17"></path></svg>
                        </button>
                        <button id="settings-btn" class="flex-shrink-0 p-1.5 bg-gray-700/50 backdrop-blur-sm rounded-full hover:bg-gray-600/70 transition-colors shadow-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                    </div>
                </header>
                <div id="inline-translation-container" class="absolute inset-0 z-10 hidden items-center justify-center p-8 pointer-events-none">
    <div class="relative bg-black/70 backdrop-blur-md border border-gray-600 rounded-lg p-3 max-h-[80%] w-full max-w-md overflow-y-auto text-base italic text-gray-300 pointer-events-auto">
        
        <button id="close-translation-btn" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-white hover:bg-white/10 rounded-full transition-colors z-10">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
        <p id="inline-translation-text" class="pr-6 pt-2"></p>
    </div>
</div>
                <video id="story-video" class="w-full h-full object-cover hidden" autoplay loop muted playsinline></video>
                <img id="story-image" src="" alt="Story image" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 p-1 sm:p-4 flex flex-col items-start gap-3 bg-gradient-to-t from-black/70 to-transparent">
                    <div id="karaoke-display" class="w-full text-center h-5 flex items-center justify-center"><span id="karaoke-word" class="text-white text-xl font-semibold px-4 py-0 bg-black/50 rounded-lg transition-opacity duration-150 ease-in-out opacity-0"></span></div>
                    <div class="flex flex-wrap items-center justify-start gap-2">
                        <button id="grammar-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border  transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span>Gramática</span></button>
                        <button id="vocabulary-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border  transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"></path></svg><span>Vocabulario</span></button>
                        <button id="translation-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border  transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13-4-4-4 4M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Traducción</span></button>
                    </div>
                </div>
            </div>
<div id="text-container" class="h-1/2 flex-1 bg-gray-800 overflow-y-auto p-4 sm:p-6 pb-32 relative">
                <h2 id="story-title-view" class="text-center text-[0.8rem] font-bold text-indigo-400 uppercase tracking-widest mb-2"></h2>
                <p id="story-text-en" class="leading-relaxed text-gray-300"></p>
            </div>
            <footer class="absolute bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-sm border-t border-white/10 z-20">
                <div class="w-full max-w-xl mx-auto p-1 sm:p-4 flex flex-col items-center justify-center gap-1 relative">
                    <div id="speed-tooltip" class="absolute bottom-full mb-2 bg-gray-900 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none"></div>
                    <div class="w-full relative h-4 bg-black/30 rounded-full overflow-hidden border border-white/20">
                        <div id="progress-bar-fill" class="absolute top-0 left-0 h-full bg-indigo-500 transition-all duration-300 ease-linear"></div>
                        <div id="story-progress-text" class="absolute inset-0 flex items-center justify-center text-[0.6rem] font-bold text-shadow"></div>
                    </div>
                    <div class="w-full flex items-center justify-between">
                        <div class="w-1/4 flex justify-start"><button id="prev-page-btn" class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 sm:w-16 sm:h-16 rounded-full shadow-lg transform hover:scale-105 transition-transform flex items-center justify-center"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.5L2.5 12L12 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21.5 2.5L12 12L21.5 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                        <div class="flex-1 flex items-center justify-center gap-2">
    
    <button id="prev-word-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Palabra anterior">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <button id="decrease-speed-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Más lento"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
    <button id="play-pause-btn" class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 sm:w-16 sm:h-16 rounded-full shadow-lg play-button-shadow transform hover:scale-105 transition-transform flex items-center justify-center" disabled><svg id="play-icon" class="w-7 h-7 sm:w-8 sm:h-8 ml-1" viewBox="0 0 24 24" fill="currentColor"><path d="M6.3 20.7c-.4 0-.8-.1-1.1-.4-.6-.5-.9-1.2-.9-1.9V5.6c0-.7.3-1.4.9-1.9.6-.5 1.4-.6 2.1-.3l12.4 7.2c.7.4 1.1 1.1 1.1 1.9s-.4 1.5-1.1 1.9L7.3 20.4c-.3.2-.7.3-1 .3Z"/></svg><svg id="pause-icon" class="w-7 h-7 sm:w-8 sm:h-8 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M8 4h2v16H8V4zm6 0h2v16h-2V4z"/></svg></button>
    <button id="increase-speed-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Más rápido"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m-6-6h12"></path></svg></button>

    <button id="next-word-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Siguiente palabra">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 18L15 12L9 6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

</div>
                        <div class="w-1/4 flex justify-end"><button id="next-page-btn" class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 sm:w-16 sm:h-16 rounded-full shadow-lg transform hover:scale-105 transition-transform flex items-center justify-center"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.5L21.5 12L12 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.5 2.5L12 12L2.5 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                    </div>
                    <div class="text-center text-[0.6rem] text-gray-500">
                        NARRION &copy; 2025 all rights reserved
                    </div>
                </div>
            </footer>
        </div>

        <div id="activities-view" class="hidden h-full flex flex-col bg-gray-900">
            <header class="p-4 flex-shrink-0 bg-gray-800 border-b border-gray-700 flex items-center gap-4 z-10 shadow-md">
                <button id="activities-back-btn" class="p-2 hover:bg-gray-700 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div>
                    <h2 id="activities-title" class="text-xl font-bold text-white">Actividades</h2>
                    <p id="activities-subtitle" class="text-sm text-gray-400"></p>
                </div>
            </header>
            <main id="activities-list" class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-4"></main>
            <footer class="flex-shrink-0 bg-gray-900 border-t border-gray-700 text-center py-1 text-[0.6rem] text-gray-600">
                NARRION &copy; 2025 all rights reserved
           </footer>
        </div>

        <div id="game-view" class="hidden h-full flex flex-col bg-gray-900">
            <header class="flex items-center justify-between p-3 border-b border-gray-700 flex-shrink-0 bg-gray-800 z-10 shadow-md">
                <div class="flex items-center gap-2">
                     <button id="game-back-btn" class="p-2 hover:bg-gray-700 rounded-full transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div>
                        <h2 id="game-view-title" class="text-lg font-bold text-indigo-400"></h2>
                        <p id="game-view-subtitle" class="text-xs text-gray-400"></p>
                    </div>
                </div>
                <div id="game-score-display" class="text-base font-bold text-white"></div>
            </header>
            <main id="game-area" class="flex-grow p-4 sm:p-6 overflow-y-auto relative"></main>
            <footer class="flex-shrink-0 bg-gray-900 border-t border-gray-700 text-center py-1 text-[0.6rem] text-gray-600">
                NARRION &copy; 2025 all rights reserved
           </footer>
        </div>
    </div>
    
<script src="games.js"></script>
<script>
    
document.addEventListener('DOMContentLoaded', () => {

    // --- LÓGICA PARA PWA ---
    // 1. Registrar el Service Worker
    if ('serviceWorker' in navigator) {
    let newWorker;

    function showUpdatePrompt() {
        const notification = document.getElementById('update-notification');
        const updateButton = document.getElementById('update-btn');
        notification.classList.remove('hidden');
        updateButton.addEventListener('click', () => {
            newWorker.postMessage({ action: 'skipWaiting' });
            notification.classList.add('hidden');
        });
    }

    window.addEventListener('load', () => {
        const swVersion = 'v26';
        navigator.serviceWorker.register('/sw.js').then(reg => {
            
            reg.addEventListener('updatefound', () => {
                console.log('Nueva versión del Service Worker encontrada. Instalando...');
                newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                           showUpdatePrompt();
                        }
                    }
                });
            });
        });

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
                console.log("Nuevo Service Worker activado. Recargando página...");
                window.location.reload();
                refreshing = true;
            }
        });
    });
}

    // 2. Lógica para el botón de instalación
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Previene que el mini-infobar aparezca en Chrome
        e.preventDefault();
        // Guarda el evento para que pueda ser disparado más tarde.
        deferredPrompt = e;
        // Muestra nuestro botón de instalación personalizado.
        installBtn.style.display = 'flex';
    });

    installBtn.addEventListener('click', async () => {
        // Oculta nuestro botón, ya que el diálogo del navegador aparecerá.
        installBtn.style.display = 'none';
        // Muestra el diálogo de instalación.
        deferredPrompt.prompt();
        // Espera a que el usuario responda.
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`Respuesta del usuario: ${outcome}`);
        // Ya no necesitamos el evento.
        deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => {
        // Si la app se instala, oculta el botón y limpia la referencia.
        installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('App instalada con éxito!');
    });
    // --- FIN LÓGICA PWA ---


    const App = {
        // ... (todo el SoundManager, config, state, elements se mantiene igual)

        processData(data, key) {
    let result = '';
    for (let i = 0; i < data.length; i++) {
        result += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return result;
},


        SoundManager: {
            _parent: null,
            sounds: {},
            backgroundMusic: null,
            init(parent) {
                this._parent = parent;
                const soundFiles = ['click.mp3', 'congrats.flac', 'ok.mp3', 'select.wav', 'wrong.wav'];
                soundFiles.forEach(file => {
                    const name = file.split('.')[0];
                    this.sounds[name] = new Audio(`sounds/${file}`);
                    this.sounds[name].preload = 'auto';
                });
                this.backgroundMusic = this._parent.elements.backgroundAudio;
                this.backgroundMusic.src = 'sounds/bg.mp3';
                this.backgroundMusic.volume = 0.3; // <-- Volumen de la música de fondo ajustado
            },
            play(name) {
                const sound = this.sounds[name];
                if (sound) {
                    sound.pause();
                    sound.currentTime = 0;
                    sound.play().catch(e => console.error(`Error playing sound '${name}':`, e));
                }
            },
            playBgMusic() {
                if (this._parent.state.isMuted) return;

                const playPromise = this.backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        if (error.name === "NotAllowedError") {
                            console.log("Background music autoplay was prevented. Waiting for user interaction.");
                            const playOnInteraction = () => {
                                if (!this._parent.state.isMuted) {
                                    this.backgroundMusic.play().catch(e => console.error("Could not play BG music after interaction:", e));
                                }
                            };
                            window.addEventListener('click', playOnInteraction, { once: true });
                            window.addEventListener('touchstart', playOnInteraction, { once: true });
                        } else {
                            console.error("Error playing background music:", error);
                        }
                    });
                }
            },
            pauseBgMusic() {
                if (this.backgroundMusic) {
                    this.backgroundMusic.pause();
                }
            },
            applyMuteState(isMuted) {
                // Ahora solo afecta a la música de fondo
                this.backgroundMusic.muted = isMuted;

                if (isMuted) {
                    this.pauseBgMusic();
                } else {
                    this.playBgMusic();
                }
            }
        },

        config: {
            API_BASE_URL: 'https://narrion.saturninocok.workers.dev',
            PEXELS_WORKER_URL: 'https://px.saturninocok.workers.dev',
            PIXABAY_WORKER_URL: 'https://pixa.saturninocok.workers.dev',
            STORAGE_KEY: 'storyProgressData_v2',
            SETTINGS_KEY: 'storyAppSettings_v1', // Nueva clave para la configuración
            PLAYBACK_SPEEDS: [0.75, 1.0, 1.25, 1.5],
        },

        state: {
            allStories: [],
            currentStory: null,
            currentPageIndex: 0,
            marksData: [],
            glossary: new Map(),
            phrasalVerbMap: new Map(),
            currentWordIndex: -1,
            isPlaying: false,
            animationFrameId: null,
            storyWords: [],
            pageWordStartIndices: [],
            learningList: [],
            currentSpeedIndex: 1,
            activeGame: null, 
            fontSizeMultiplier: 1.0,
            learnedWords: {},
            isAutoplayEnabled: false,
            isMuted: false,
            isTranslationModeActive: false,
            isAnimating: false, 
             tempCompletedParagraphs: [],
        },

        elements: {},
        


        decodeAudioPath(encodedPath, key) {
    // Primero, decodificamos de Base64
    const decodedB64 = atob(encodedPath);
    let result = '';
    for (let i = 0; i < decodedB64.length; i++) {
        result += String.fromCharCode(decodedB64.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return result;
},


        init() {
            this.cacheDomElements();
            this.SoundManager.init(this);
            this.SettingsManager.init(this); 
            this.SpellingGame.init(this);
            this.WordNavigator.init(this);
            this.bindEventListeners();
            this.fetchStories();
        },

        cacheDomElements() {
            this.elements = {
                mainMenu: document.getElementById('main-menu'),
                storyView: document.getElementById('story-view'),
                activitiesView: document.getElementById('activities-view'),
                gameView: document.getElementById('game-view'),
                storyListContainer: document.getElementById('story-list'),
                loadingStoriesEl: document.getElementById('loading-stories'),
                filterContainer: document.getElementById('filter-container'),
                backBtn: document.getElementById('back-btn'),
                storyProgressTextEl: document.getElementById('story-progress-text'),
                progressBarFillEl: document.getElementById('progress-bar-fill'),
                storyImageEl: document.getElementById('story-image'),
                storyVideoEl: document.getElementById('story-video'),
                storyTextEnEl: document.getElementById('story-text-en'),
                storyAudio: document.getElementById('story-audio'),
                backgroundAudio: document.getElementById('background-audio'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                prevPageBtn: document.getElementById('prev-page-btn'),
                nextPageBtn: document.getElementById('next-page-btn'),
                decreaseSpeedBtn: document.getElementById('decrease-speed-btn'),
                increaseSpeedBtn: document.getElementById('increase-speed-btn'),
                speedTooltip: document.getElementById('speed-tooltip'),
                storyTitleViewEl: document.getElementById('story-title-view'),
                karaokeWordEl: document.getElementById('karaoke-word'),
                grammarBtn: document.getElementById('grammar-btn'),
                vocabularyBtn: document.getElementById('vocabulary-btn'),
                translationBtn: document.getElementById('translation-btn'),
                activitiesBtn: document.getElementById('activities-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                muteBtn: document.getElementById('mute-btn'),
                soundOnIcon: document.getElementById('sound-on-icon'),
                soundOffIcon: document.getElementById('sound-off-icon'),
                // Elementos del nuevo botón de mute en el menú principal
                mainMenuMuteBtn: document.getElementById('main-menu-mute-btn'),
                mainMenuSoundOnIcon: document.getElementById('main-menu-sound-on-icon'),
                mainMenuSoundOffIcon: document.getElementById('main-menu-sound-off-icon'),
                activitiesList: document.getElementById('activities-list'),
                activitiesTitle: document.getElementById('activities-title'),
                activitiesSubtitle: document.getElementById('activities-subtitle'),
                activitiesBackBtn: document.getElementById('activities-back-btn'),
                gameArea: document.getElementById('game-area'),
                gameBackBtn: document.getElementById('game-back-btn'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalContainer: document.getElementById('modal-container'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                modalOkBtn: document.getElementById('modal-ok-btn'),
                settingsModalContainer: document.getElementById('settings-modal-container'),
                settingsModalCloseBtn: document.getElementById('settings-modal-close-btn'),
                increaseFontBtn: document.getElementById('increase-font-btn'),
                decreaseFontBtn: document.getElementById('decrease-font-btn'),
                fontSizeDisplay: document.getElementById('font-size-display'),
                autoplayToggle: document.getElementById('autoplay-toggle'),
                wordModalContainer: document.getElementById('word-modal-container'),
                wordModalDefaultView: document.getElementById('word-modal-default-view'),
                wordModalSpellingView: document.getElementById('word-modal-spelling-view'),
                wordModalTitle: document.getElementById('word-modal-title'),
                wordModalTranslation: document.getElementById('word-modal-translation'),
                wordModalImage: document.getElementById('word-modal-image'),
                wordModalImageLoader: document.getElementById('word-modal-image-loader'),
                wordModalPos: document.getElementById('word-modal-pos'),
                inlineTranslationContainer: document.getElementById('inline-translation-container'),
                inlineTranslationText: document.getElementById('inline-translation-text'),
                closeTranslationBtn: document.getElementById('close-translation-btn'),
                 prevWordBtn: document.getElementById('prev-word-btn'),
                nextWordBtn: document.getElementById('next-word-btn'),
                
            };
        },

        bindEventListeners() {
            this.elements.playPauseBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.state.isPlaying ? this.AudioPlayer.pause() : this.AudioPlayer.play(); });
            this.elements.backBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showScreen('main'); });
            this.elements.activitiesBackBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showScreen('story'); });
            this.elements.gameBackBtn.addEventListener('click', () => {
                this.SoundManager.play('click');
                if (this.state.activeGame && typeof this.state.activeGame.close === 'function') {
                    this.state.activeGame.close();
                } else {
                    this.showScreen('activities');
                }
            });
            
            // Listeners para modales
            const closeGenericModal = () => { this.SoundManager.play('click'); this.Modals.closeGeneric(); };
            const closeSettingsModal = () => { this.SoundManager.play('click'); this.Modals.closeSettings(); };
            this.elements.modalOverlay.addEventListener('click', () => { closeGenericModal(); closeSettingsModal(); });
            this.elements.modalCloseBtn.addEventListener('click', closeGenericModal);
            this.elements.modalOkBtn.addEventListener('click', () => { this.SoundManager.play('ok'); closeGenericModal(); });
            this.elements.settingsModalCloseBtn.addEventListener('click', closeSettingsModal);
            
            // Listeners de botones de la historia
            this.elements.settingsBtn.addEventListener('click', () => { this.SoundManager.play('select'); this.Modals.openSettings(); });
            this.elements.muteBtn.addEventListener('click', () => this.SettingsManager.toggleMute());
            this.elements.mainMenuMuteBtn.addEventListener('click', () => this.SettingsManager.toggleMute()); // Ambos botones controlan el mismo estado
            this.elements.activitiesBtn.addEventListener('click', () => { this.SoundManager.play('select'); this.ActivityManager.showActivitiesView(); });
            this.elements.grammarBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showGrammar(); });
            this.elements.vocabularyBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showVocabulary(); });
            this.elements.translationBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.toggleTranslationView(); });
            
             this.elements.closeTranslationBtn.addEventListener('click', () => {
        this.SoundManager.play('click');
        // Ahora llama a la nueva función que solo cierra el panel
        this.closeInlineTranslationPanel(); 
    });

        


            // Listeners del reproductor
            this.elements.storyAudio.addEventListener('ended', () => this.handlePageEnd());
            this.elements.nextPageBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.changePage(1); });
            this.elements.prevPageBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.changePage(-1); });
            this.elements.decreaseSpeedBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.AudioPlayer.changeSpeed(-1); });
            this.elements.increaseSpeedBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.AudioPlayer.changeSpeed(1); });
            
            // Listeners de configuración
            this.elements.decreaseFontBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.SettingsManager.changeFontSize(-1); });
            this.elements.increaseFontBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.SettingsManager.changeFontSize(1); });
            this.elements.autoplayToggle.addEventListener('change', () => this.SettingsManager.toggleAutoplay());

            // Listener del filtro
            this.elements.filterContainer.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    this.SoundManager.play('click');
                    this.elements.filterContainer.querySelector('.filter-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    this.renderStories(e.target.dataset.filter);
                }
            });

            this.elements.prevWordBtn.addEventListener('click', () => this.WordNavigator.navigate(-1));
            this.elements.nextWordBtn.addEventListener('click', () => this.WordNavigator.navigate(1));
        },
        



        createSparkleEffect(buttonElement) {
    if (!buttonElement) return;

    const rect = buttonElement.getBoundingClientRect();
    const startX = rect.left + rect.width / 2;
    const startY = rect.top + rect.height / 2;
    const particleCount = 12; // Menos partículas, más fluido
    const appContainer = document.getElementById('app-container');

    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'star-particle';

        const angle = Math.random() * Math.PI * 2;
        const radius = 40 + Math.random() * 70; // Campo de movimiento reducido
        const endX = Math.cos(angle) * radius;
        const endY = Math.sin(angle) * radius;
        const rotation = Math.random() * 720 - 360;

        // Variables CSS para animación por transform
        particle.style.setProperty('--tx-start', `0px`);
        particle.style.setProperty('--ty-start', `0px`);
        particle.style.setProperty('--tx-end', `${endX}px`);
        particle.style.setProperty('--ty-end', `${endY}px`);
        particle.style.setProperty('--rotation', `${rotation}deg`);

        // Posicionamos el punto inicial
        particle.style.left = `${startX}px`;
        particle.style.top = `${startY}px`;

        appContainer.appendChild(particle);

        // Limpieza automática tras animación
        setTimeout(() => {
            particle.remove();
        }, 1700); // un poco más que la animación (1.6s)
    }
},


       handlePageEnd() {
            if (this.state.animationFrameId) {
                cancelAnimationFrame(this.state.animationFrameId);
                this.state.animationFrameId = null;
            }

            const isLastPage = this.state.currentPageIndex === this.state.currentStory.p.length - 1;

            if (this.state.isAutoplayEnabled) {
                if (!isLastPage) {
                    this.changePage(1);
                } else {
                    this.AudioPlayer.stop();
                    // USA LA NUEVA CLASE ESTÁTICA
                    this.elements.activitiesBtn.classList.add('static-glow-activities');
                    this.createSparkleEffect(this.elements.activitiesBtn); // <-- ¡AÑADE ESTA LÍNEA!
                }
            } else {
                this.AudioPlayer.stop();
                if (isLastPage) {
                    // USA LA NUEVA CLASE ESTÁTICA
                    this.elements.activitiesBtn.classList.add('static-glow-activities');
                    this.createSparkleEffect(this.elements.activitiesBtn); // <-- ¡Y AÑADE ESTA OTRA LÍNEA AQUÍ!
                }
            }
            
            // --- INICIO DE LA ACTUALIZACIÓN CON LAS NUEVAS CLASES ---
             // Aplica el brillo estático a los botones
    const buttonsToGlow = [this.elements.grammarBtn, this.elements.vocabularyBtn, this.elements.translationBtn];
    buttonsToGlow.forEach(btn => {
        btn.classList.add('static-glow-purple');
        // ¡Llamamos a nuestra nueva función de efecto para cada botón!
        this.createSparkleEffect(btn);
    });

    if (!isLastPage) {
        this.elements.nextPageBtn.classList.add('static-glow-purple');
        // Y también para el botón de siguiente página
        this.createSparkleEffect(this.elements.nextPageBtn);
    }
            // --- FIN DE LA ACTUALIZACIÓN ---
        },

        showScreen(name) {
    const screens = ['mainMenu', 'storyView', 'activitiesView', 'gameView'];
    screens.forEach(screen => this.elements[screen]?.classList.add('hidden'));
    
    let targetScreen;
    switch(name) {
        case 'main': targetScreen = this.elements.mainMenu; break;
        case 'story': targetScreen = this.elements.storyView; break;
        case 'activities': targetScreen = this.elements.activitiesView; break;
        case 'game': targetScreen = this.elements.gameView; break;
    }
    targetScreen?.classList.remove('hidden');

    if (name === 'main') {
        this.AudioPlayer.stop(true);
        this.state.currentStory = null; 
        this.state.currentSpeedIndex = 1;
        
        

        // Reseteamos el brillo de los botones al salir a la lista de historias
        const buttonsToReset = [this.elements.grammarBtn, this.elements.vocabularyBtn, this.elements.translationBtn];
        buttonsToReset.forEach(btn => btn.classList.remove('static-glow-purple'));
        this.elements.activitiesBtn.classList.remove('static-glow-activities');

        
        if (this.state.isTranslationModeActive) {
            this.state.isTranslationModeActive = false;
            this.elements.translationBtn.classList.remove('active');
            this.elements.inlineTranslationContainer.classList.add('hidden');
        }
        this.renderStories();
    }
},
        
        async fetchStories() {
            try {
                const response = await fetch(`${this.config.API_BASE_URL}/data`, { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                this.state.allStories = Array.isArray(data.story) ? data.story : [];

                this.elements.loadingStoriesEl.classList.add('hidden');
                this.renderStories();

            } catch (e) {
                this.elements.loadingStoriesEl.textContent = 'Error al cargar las historias.';
                this.elements.loadingStoriesEl.classList.add('text-red-400');
                console.error("Fetch stories failed:", e);
            }
        },

        // index.html -> dentro del objeto App

async fetchAndShowStory(storyId) {
    this.SoundManager.play('select');
    this.showScreen('story');
    this.elements.activitiesBtn.classList.remove('glowing-activities-btn');
    
    this.elements.activitiesBtn.disabled = true;
    this.elements.grammarBtn.disabled = true;
    this.elements.vocabularyBtn.disabled = true;
    this.elements.translationBtn.disabled = true;
    this.elements.playPauseBtn.disabled = true;
    this.elements.storyTextEnEl.innerHTML = '<p class="text-center text-gray-400 animate-pulse">Cargando historia...</p>';
    this.elements.storyTitleViewEl.textContent = 'Cargando...';

    try {
        const storySummary = this.state.allStories.find(s => s.id == storyId);
        if (!storySummary) throw new Error("Story not found in list.");
        
        const response = await fetch(`${this.config.API_BASE_URL}/stories/${storyId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const storyDataObject = Array.isArray(data.story) ? data.story[0] : data.story;

        // --- INICIO DE LA MODIFICACIÓN PARA DEBUGGING ---
     
        if (storyDataObject) {
        }
        // --- FIN DE LA MODIFICACIÓN PARA DEBUGGING ---

        if (!storyDataObject) throw new Error("Invalid story data from API.");

        this.state.currentStory = { ...storySummary, ...storyDataObject };
        
        if (storyDataObject.meta && storyDataObject.meta.assetType) {
            this.state.currentStory.assetType = storyDataObject.meta.assetType;
        }

        if (this.state.currentStory.g) {
            this.ProgressManager.setTotalGames(storyId, this.state.currentStory.g.length);
        }
        
        const storyTitle = storyDataObject.meta && storyDataObject.meta.t ? storyDataObject.meta.t : storySummary.title;
        const { t: title } = this.Utils.parseTitle(storyTitle);
        this.state.currentStory.cleanTitle = title;
        
        this.createGlossary(this.state.currentStory.gloss_str);
        this.createPhrasalVerbMap(this.state.currentStory.ph_str);

        try {
            const SC = "narr9"; 
            const marksResponse = await fetch(`${this.config.API_BASE_URL}/marks/${this.state.currentStory.cleanTitle}`);
            const encodedMarksText = await marksResponse.text();
            const decodedJsonText = this.processData(encodedMarksText, SC);
            const sanitizedJsonText = decodedJsonText.replace(/['’]/g, '');
            this.state.marksData = JSON.parse(sanitizedJsonText);
            const decodedAudioPath = this.decodeAudioPath(this.state.currentStory.encodedAudioPath, SC);
            this.elements.storyAudio.src = decodedAudioPath;
            this.processAudioMarkers();
            this.elements.playPauseBtn.disabled = false;
        } catch (e) {
            this.state.marksData = [];
            this.elements.playPauseBtn.disabled = true;
            console.error("Error loading or decoding audio data via worker:", e);
        }
        
        this.state.currentPageIndex = 0;
        this.state.currentSpeedIndex = 1;
        this.elements.storyAudio.playbackRate = this.config.PLAYBACK_SPEEDS[this.state.currentSpeedIndex];
        this.AudioPlayer.updateSpeedButtons();
        this.renderCurrentPage();

        this.elements.activitiesBtn.disabled = false;
        this.elements.grammarBtn.disabled = false;
        this.elements.vocabularyBtn.disabled = false;
        this.elements.translationBtn.disabled = false;

    } catch (error) {
        console.error("FALLO AL CARGAR LA HISTORIA:", error);
        this.showScreen('main');
    }
},
        
        // index.html -> Reemplaza todo el objeto ProgressManager
// highlight-start
// index.html -> Reemplaza todo el objeto ProgressManager
// index.html -> Reemplaza todo el objeto ProgressManager
ProgressManager: {
    _parent: null,
    init(parent) { this._parent = parent; },
    getAllProgress() { try { const data = localStorage.getItem(this._parent.config.STORAGE_KEY); return data ? JSON.parse(data) : {}; } catch (e) { console.error("Error reading progress", e); return {}; } },
    saveAllProgress(data) { try { localStorage.setItem(this._parent.config.STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("Error saving progress", e); } },
    
    setTotalGames(storyId, total) { const allProgress = this.getAllProgress(); if (!allProgress[storyId]) { allProgress[storyId] = { activities: {} }; } allProgress[storyId].totalGames = total; this.saveAllProgress(allProgress); },
    
    getProgress(storyId, gameId = null) { 
        const allProgress = this.getAllProgress(); 
        const storyProgress = allProgress[storyId]; 
        if (!storyProgress) return null; 
        return gameId ? (storyProgress.activities ? storyProgress.activities[gameId] : null) : storyProgress; 
    },

    saveProgress(storyId, gameId, progress, errors) {
        const allProgress = this.getAllProgress();
        if (!allProgress[storyId]) { allProgress[storyId] = { activities: {} }; }
        if (!allProgress[storyId].activities) { allProgress[storyId].activities = {}; }
        
        // Para "Stop The Line", no sobreescribimos los párrafos completados, solo el progreso general.
        // highlight-start
        if (gameId === 6) {
            if (!allProgress[storyId].activities[gameId]) {
                allProgress[storyId].activities[gameId] = { progress: 0, errors: 0, completedParagraphs: [] };
            }
            allProgress[storyId].activities[gameId].progress = progress;
        } else {
            const oldData = allProgress[storyId].activities[gameId] || { progress: 0, errors: 0 };
            if (progress >= oldData.progress) { allProgress[storyId].activities[gameId] = { progress, errors }; }
        }
        // highlight-end

        this.checkAndCalculateFinalScore(storyId, allProgress);
        this.saveAllProgress(allProgress);
        if (!this._parent.elements.activitiesView.classList.contains('hidden') && this._parent.state.currentStory.id == storyId) {
            this._parent.ActivityManager.showActivitiesView();
        }
    },

    // NUEVA FUNCIÓN: Guarda el índice de un párrafo completado para el juego "Stop The Line".
    // highlight-start
    // index.html -> App.ProgressManager
// REEMPLAZA ESTA FUNCIÓN COMPLETA
saveCompletedParagraph(storyId, gameId, paragraphIndex) {
    if (gameId !== 6) return;
    const allProgress = this.getAllProgress();

    // Asegurarse de que la estructura base exista
    if (!allProgress[storyId]) {
        allProgress[storyId] = { activities: {} };
    }
    if (!allProgress[storyId].activities[gameId]) {
        allProgress[storyId].activities[gameId] = { progress: 0, errors: 0, completedParagraphs: [] };
    }
    
    const gameProgress = allProgress[storyId].activities[gameId];

    // Añadir el párrafo completado si no existe ya
    if (!gameProgress.completedParagraphs.includes(paragraphIndex)) {
        gameProgress.completedParagraphs.push(paragraphIndex);
    }

    // --- INICIO DE LA CORRECCIÓN CLAVE ---
    // Ahora, calculamos y actualizamos el porcentaje de progreso de la actividad
    // highlight-start
    const storyData = this._parent.state.allStories.find(s => s.id == storyId);
    // Para obtener el total de párrafos, accedemos a la historia completa cargada en el estado
    const totalParagraphs = this._parent.state.currentStory ? this._parent.state.currentStory.p.length : (storyData ? storyData.p_count : 0);

    if (totalParagraphs > 0) {
        const newProgress = Math.round((gameProgress.completedParagraphs.length / totalParagraphs) * 100);
        gameProgress.progress = newProgress; // Actualizamos la propiedad 'progress'
    }
    // highlight-end
    // --- FIN DE LA CORRECCIÓN CLAVE ---

    this.saveAllProgress(allProgress);
},
    // highlight-end

    // NUEVA FUNCIÓN: Obtiene la lista de párrafos completados.
    // highlight-start
    getCompletedParagraphs(storyId, gameId) {
        if (gameId !== 6) return [];
        const gameProgress = this.getProgress(storyId, gameId);
        return gameProgress ? (gameProgress.completedParagraphs || []) : [];
    },
    // highlight-end

    checkAndCalculateFinalScore(storyId, allProgress) {
        const storyData = this._parent.state.allStories.find(s => s.id == storyId);
        const storyProgress = allProgress[storyId];
        if (!storyProgress || !storyProgress.activities) return;
        const totalGames = storyProgress.totalGames || (storyData && storyData.g ? storyData.g.length : 0);
        if (totalGames === 0) return;
        const completedActivities = Object.values(storyProgress.activities).filter(a => a.progress === 100);
        if (completedActivities.length === totalGames) {
            const totalErrors = Object.values(storyProgress.activities).reduce((sum, activity) => sum + (activity.errors || 0), 0);
            storyProgress.finalPoints = Math.max(0, 100 - (totalErrors * 5));
        } else {
            delete storyProgress.finalPoints;
        }
    },
    
    computeStoryOverallProgress(storyId) {
        const storyProgress = this.getProgress(storyId);
        if (!storyProgress || !storyProgress.activities) return 0;
        const totalGamesInStory = storyProgress.totalGames || 0;
        if (totalGamesInStory === 0) return 0;
        const progressSum = Object.values(storyProgress.activities).reduce((sum, activity) => sum + (activity.progress || 0), 0);
        return Math.round(progressSum / totalGamesInStory);
    }
},
// highlight-end

        renderStories(filter = 'todos') {
            const filtered = this.state.allStories.filter(s => filter === 'todos' || s.difficulty.toLowerCase() === filter);
            if (filtered.length === 0 && this.state.allStories.length > 0) {
                this.elements.storyListContainer.innerHTML = `<p class="text-gray-400 text-center">No hay historias en esta categoría.</p>`;
                return;
            }
            const difficultyColors = { 
                fundamental: 'bg-blue-600', 
                básico: 'bg-green-600', 
                intermedio: 'bg-yellow-600', 
                avanzado: 'bg-red-600', 
                infantiles: 'bg-pink-600',
                noticias: 'bg-teal-600',
                otros: 'bg-purple-600' 
            };
            
            this.elements.storyListContainer.innerHTML = filtered.map(story => {
                const { t: title, s: subtitle } = this.Utils.parseTitle(story.title);
                const placeholderPath = `https://placehold.co/224x224/1f2937/ffffff?text=No+Img`;

                let imagePath;
                if (story.assetType === 'video') {
                    imagePath = `./data/${title}/vd/1.jpg`;
                } else {
                    imagePath = `./data/${title}/img/1.jpg`;
                }

                const storyProgress = this.ProgressManager.getProgress(story.id);
                const overallProgress = this.ProgressManager.computeStoryOverallProgress(story.id);
                let statusBadgeHTML = '';
                if (storyProgress && storyProgress.finalPoints !== undefined) {
                    statusBadgeHTML = `<div class="story-status-badge badge-green">Completado: ${storyProgress.finalPoints}/100 pts</div>`;
                } else if (overallProgress > 0) {
                    statusBadgeHTML = `<div class="story-status-badge badge-yellow">${overallProgress}%</div>`;
                } else {
                    statusBadgeHTML = `<div class="story-status-badge badge-gray">No iniciado</div>`;
                }

                return `<div class="story-card bg-gray-800 rounded-lg overflow-hidden flex cursor-pointer transition-all duration-300 flex-shrink-0" data-story-id="${story.id}">
                            <div class="flex-shrink-0 w-28 relative">
                                <img src="${imagePath}" alt="${title}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='${placeholderPath}';">
                                ${statusBadgeHTML}
                            </div>
                            <div class="p-2 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold text-white">${title}</h3>
                                <p class="text-sm text-gray-400 mb-1">${subtitle}</p>
                                <div class="flex items-center gap-x-3 gap-y-1 flex-wrap mt-auto">
                                    <span class="text-[10px] font-semibold px-2  rounded-full text-white ${difficultyColors[story.difficulty.toLowerCase()] || 'bg-gray-600'}">${story.difficulty}</span>
                                    <span class="text-xs text-gray-300 bg-gray-700 px-3 py-1 rounded-md">Tema: ${story.theme}</span>
                                </div>
                            </div>
                        </div>`;
            }).join('');
            
            this.elements.storyListContainer.querySelectorAll('.story-card').forEach(card => 
                card.addEventListener('click', () => this.fetchAndShowStory(card.dataset.storyId))
            );
        },
        
       AudioPlayer: {
             _parent: null,
             init(parent) { this._parent = parent; },
             async play() {
                if (this._parent.state.marksData.length === 0 || !this._parent.state.currentStory) return;

                const audioEl = this._parent.elements.storyAudio;
                const currentPageIndex = this._parent.state.currentPageIndex;
                const pageWordStartIndex = this._parent.state.pageWordStartIndices[currentPageIndex];
                
                const isLastPage = currentPageIndex === this._parent.state.currentStory.p.length - 1;
                const pageWordEndIndex = isLastPage 
                    ? this._parent.state.marksData.length - 1 
                    : this._parent.state.pageWordStartIndices[currentPageIndex + 1] - 1;

                const startOfPageTime = this._parent.state.marksData[pageWordStartIndex]?.start;
                const endOfPageTime = this._parent.state.marksData[pageWordEndIndex]?.end;
                
                // If playback is finished for the current page, reset to the beginning of the page
                if (!this._parent.state.isPlaying && endOfPageTime && audioEl.currentTime >= endOfPageTime - 0.1) {
                    audioEl.currentTime = startOfPageTime;
                }

                try {
                    await audioEl.play();
                    this._parent.state.isPlaying = true;
                    this._parent.elements.playIcon.classList.add('hidden');
                    this._parent.elements.pauseIcon.classList.remove('hidden');
                    this._parent.state.animationFrameId = requestAnimationFrame(() => this._parent.updateHighlight());
                } catch (error) {
                    if (error.name !== 'AbortError') console.error("Error al reproducir audio:", error);
                }
             },
             pause() { 
                this._parent.elements.storyAudio.pause(); 
                this._parent.state.isPlaying = false; 
                this._parent.elements.playIcon.classList.remove('hidden'); 
                this._parent.elements.pauseIcon.classList.add('hidden'); 
                if (this._parent.state.animationFrameId) cancelAnimationFrame(this._parent.state.animationFrameId); 
             },
             stop(resetTime = false) { 
                this.pause(); 
                if (resetTime && this._parent.elements.storyAudio.duration) this._parent.elements.storyAudio.currentTime = 0; 
                const activeWord = document.querySelector('.word.active'); 
                if (activeWord) activeWord.classList.remove('active'); 
                this._parent.elements.karaokeWordEl.style.opacity = '0'; 
                this._parent.state.currentWordIndex = -1; 
             },
            // CÓDIGO CORREGIDO (DESPUÉS)
            playWord(globalWordIndex, endGlobalWordIndex = -1) {
                const startMark = this._parent.state.marksData[globalWordIndex];
                if (!startMark) return;
                const endMark = (endGlobalWordIndex !== -1 && endGlobalWordIndex < this._parent.state.marksData.length) ? this._parent.state.marksData[endGlobalWordIndex] : startMark;
                
                // Pausamos cualquier reproducción en curso para evitar solapamientos
                this.pause();

                setTimeout(() => { 
                    this._parent.elements.storyAudio.currentTime = startMark.start;
                    const playPromise = this._parent.elements.storyAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            if (error.name !== 'AbortError') console.error("Error al reproducir audio de palabra:", error);
                        });
                    }
                    const duration = (endMark.end - startMark.start) * 1000; 
                    setTimeout(() => { 
                        // --- INICIO DE LA CORRECCIÓN ---
                        // Eliminamos la condición "if". Ahora siempre pausará el audio después de reproducir el segmento.
                        this._parent.elements.storyAudio.pause(); 
                        // --- FIN DE LA CORRECCIÓN ---
                    }, duration + 100); 
                }, 50);
            },
            changeSpeed(direction) { 
                const newIndex = this._parent.state.currentSpeedIndex + direction; 
                if (newIndex >= 0 && newIndex < this._parent.config.PLAYBACK_SPEEDS.length) { 
                    this._parent.state.currentSpeedIndex = newIndex; 
                    const newSpeed = this._parent.config.PLAYBACK_SPEEDS[newIndex];
                    this._parent.elements.storyAudio.playbackRate = newSpeed; 
                    this.updateSpeedButtons(); 
                    const message = `Velocidad: ${newSpeed.toFixed(2)}x`;
                    this._parent.Utils.showSpeedTooltip(message);
                } 
            },
            updateSpeedButtons() { 
                this._parent.elements.decreaseSpeedBtn.disabled = this._parent.state.currentSpeedIndex === 0; 
                this._parent.elements.increaseSpeedBtn.disabled = this._parent.state.currentSpeedIndex === this._parent.config.PLAYBACK_SPEEDS.length - 1; 
            },
        },
        
        renderCurrentPage() {
    if (!this.state.currentStory) return;

    // --- INICIO DE LA NUEVA LÓGICA: VERIFICAR SI EL PÁRRAFO ESTÁ COMPLETADO ---
    const storyId = this.state.currentStory.id;
    const completedParagraphs = this.ProgressManager.getCompletedParagraphs(storyId, 6);
    const isParagraphCompleted = completedParagraphs.includes(this.state.currentPageIndex);
    
    const textContainer = document.getElementById('text-container');
    // Aplica o quita la clase de brillo al contenedor de texto
    textContainer.classList.toggle('paragraph-completed-glow', isParagraphCompleted);
    // --- FIN DE LA NUEVA LÓGICA ---
    
    this.AudioPlayer.stop();
    this.elements.karaokeWordEl.textContent = '';
    this.elements.karaokeWordEl.style.opacity = '0';
    const pageData = this.state.currentStory.p[this.state.currentPageIndex];
    let enText = pageData.c.split('||')[0].replace(/\[\[|\]\]/g, '');

    if (this.state.currentStory.assetType === 'video') {
        this.elements.storyImageEl.classList.add('hidden');
        this.elements.storyVideoEl.classList.remove('hidden');
        const videoSrc = `./data/${this.state.currentStory.cleanTitle}/vd/${this.state.currentPageIndex + 1}.mp4`;
        if (this.elements.storyVideoEl.src !== videoSrc) this.elements.storyVideoEl.src = videoSrc;
    } else {
        this.elements.storyVideoEl.classList.add('hidden');
        this.elements.storyImageEl.classList.remove('hidden');
        this.elements.storyImageEl.src = `./data/${this.state.currentStory.cleanTitle}/img/${this.state.currentPageIndex + 1}.jpg`;
        this.elements.storyImageEl.onerror = () => this.elements.storyImageEl.src = `https://placehold.co/800x800/1e293b/ffffff?text=No+Image`;
    }

    this.elements.storyTitleViewEl.textContent = this.state.currentStory.cleanTitle;
    this.wrapWordsInSpans(enText.trim(), this.state.currentPageIndex);
    textContainer.scrollTop = 0; // Reutilizamos la variable textContainer

    // ==========================================================
    // --- MODIFICACIÓN MEJORADA: BOTÓN DE JUEGO CONDICIONAL ---
    // ==========================================================
    
    // Eliminar cualquier botón antiguo para evitar duplicados
    const oldButton = textContainer.querySelector('.play-phrase-btn');
    if (oldButton) oldButton.remove();

    // Crear el botón, pero su estado dependerá de si el párrafo está completado
    const phraseButton = document.createElement('button');
    phraseButton.className = 'play-phrase-btn block mx-auto mt-6 mb-2 px-4 py-2 text-[0.7rem] font-semibold rounded-full shadow-lg transition-all';

    if (isParagraphCompleted) {
        // Párrafo completado: Mostrar botón desactivado
        phraseButton.textContent = '✅ Párrafo Completado';
        phraseButton.classList.add('bg-gray-600', 'text-gray-400', 'cursor-default');
        phraseButton.disabled = true;
    } else {
        // Párrafo no completado: Mostrar botón para jugar
        phraseButton.textContent = 'Jugar con esta frase';
        phraseButton.classList.add('bg-indigo-900', 'hover:bg-indigo-700', 'transform', 'hover:scale-205');
        phraseButton.addEventListener('click', () => {
            this.SoundManager.play('select');
            const gameData = this.state.currentStory.g.find(g => g.id === 6);
            if (gameData) {
                this.ActivityManager.startGame(6, this.state.currentPageIndex);
            } else {
                console.error("Juego 'Stop the Line' (id: 6) no encontrado en los datos de la historia.");
            }
        });
    }

    textContainer.appendChild(phraseButton);
    // ========================================================
    // --- FIN DE LA MODIFICACIÓN MEJORADA ---
    // ========================================================

    const totalPages = this.state.currentStory.p.length;
    const progressPercentage = ((this.state.currentPageIndex + 1) / totalPages) * 100;
    this.elements.storyProgressTextEl.textContent = `Página ${this.state.currentPageIndex + 1} de ${totalPages}`;
    this.elements.progressBarFillEl.style.width = `${progressPercentage}%`;
    this.elements.prevPageBtn.disabled = this.state.currentPageIndex === 0;
    this.elements.nextPageBtn.disabled = this.state.currentPageIndex === totalPages - 1;
},

        toggleTranslationView() {
            this.state.isTranslationModeActive = !this.state.isTranslationModeActive;
            this.elements.translationBtn.classList.toggle('active', this.state.isTranslationModeActive);

            if (this.state.isTranslationModeActive) {
                const pageData = this.state.currentStory.p[this.state.currentPageIndex];
                const [, esText] = pageData.c.split('||');
                if (esText && esText.trim()) {
                    this.elements.inlineTranslationText.textContent = esText.trim();
                    this.elements.inlineTranslationContainer.classList.remove('hidden');
                    this.elements.inlineTranslationContainer.classList.add('flex');
                }
            } else {
                this.elements.inlineTranslationContainer.classList.add('hidden');
                this.elements.inlineTranslationContainer.classList.remove('flex');
            }
            this.renderCurrentPage();
        },

        closeInlineTranslationPanel() {
    // Esta función solo oculta el contenedor, sin cambiar el estado de la traducción.
    this.elements.inlineTranslationContainer.classList.add('hidden');
    this.elements.inlineTranslationContainer.classList.remove('flex');
},

       changePage(direction) {
            // Al cambiar de página, quitamos las clases de brillo estático para restaurar los botones.
            const buttonsToReset = [this.elements.grammarBtn, this.elements.vocabularyBtn, this.elements.translationBtn, this.elements.nextPageBtn];
            buttonsToReset.forEach(btn => btn.classList.remove('static-glow-purple')); // <-- CAMBIO AQUÍ

            // También nos aseguramos de quitar el brillo del botón de actividades
            this.elements.activitiesBtn.classList.remove('static-glow-activities'); // <-- CAMBIO AQUÍ


             // --- INICIO DE LA MODIFICACIÓN: ELIMINAR BOTÓN DE JUEGO ---
            const oldButton = document.querySelector('.play-phrase-btn');
            if (oldButton) oldButton.remove();
            // --- FIN DE LA MODIFICACIÓN ---

            // Prevenir clics múltiples mientras la animación está en curso
            if (this.state.isAnimating) return;
            // ... el resto de la función se mantiene igual ...
            const totalPages = this.state.currentStory.p.length;
            const newIndex = this.state.currentPageIndex + direction;

            if (newIndex >= 0 && newIndex < totalPages) {
                this.state.isAnimating = true;
                const animationDuration = 400; // Coincide con 0.4s del CSS

                const outClass = direction === 1 ? 'page-flip-out-next' : 'page-flip-out-prev';
                const inClass = direction === 1 ? 'page-flip-in-next' : 'page-flip-in-prev';

                this.elements.storyView.classList.add(outClass);

                setTimeout(() => {
                    this.state.currentPageIndex = newIndex;
                    this.renderCurrentPage();
                    const firstWordIndex = this.state.pageWordStartIndices[this.state.currentPageIndex] || 0;
                    if (this.state.marksData.length > 0 && this.state.marksData[firstWordIndex]) {
                        this.elements.storyAudio.currentTime = this.state.marksData[firstWordIndex].start;
                        this.AudioPlayer.play();
                    }
                    
                    this.elements.storyView.classList.remove(outClass);
                    this.elements.storyView.classList.add(inClass);

                    setTimeout(() => {
                        this.elements.storyView.classList.remove(inClass);
                        this.state.isAnimating = false;
                    }, animationDuration);

                }, animationDuration);
            }
        },

        createGlossary(glossStr = '') {
            const baseGlossary = new Map([
                ['a', { translation: 'un / una', pos: 'det' }], ['an', { translation: 'un / una', pos: 'det' }],
                ['the', { translation: 'el / la / los / las', pos: 'det' }], ['is', { translation: 'es / está', pos: 'v' }],
                ['are', { translation: 'son / están', pos: 'v' }], ['was', { translation: 'fue / era / estaba', pos: 'v' }],
                ['were', { translation: 'fueron / eran / estaban', pos: 'v' }], ['i', { translation: 'yo', pos: 'pron' }],
                ['you', { translation: 'tú / usted / ustedes', pos: 'pron' }], ['he', { translation: 'él', pos: 'pron' }],
                ['she', { translation: 'ella', pos: 'pron' }], ['it', { translation: 'ello / eso', pos: 'pron' }],
                ['we', { translation: 'nosotros', pos: 'pron' }], ['they', { translation: 'ellos / ellas', pos: 'pron' }],
                ['in', { translation: 'en / dentro de', pos: 'prep' }], ['on', { translation: 'en / sobre', pos: 'prep' }],
                ['at', { translation: 'en / a', pos: 'prep' }], ['to', { translation: 'a / para', pos: 'prep' }],
                ['of', { translation: 'de', pos: 'prep' }], ['for', { translation: 'para / por', pos: 'prep' }],
                ['and', { translation: 'y', pos: 'conj' }], ['but', { translation: 'pero', pos: 'conj' }],
                ['or', { translation: 'o', pos: 'conj' }], ['not', { translation: 'no', pos: 'adv' }],
                ['with', { translation: 'con', pos: 'prep' }], ['from', { translation: 'de / desde', pos: 'prep' }]
            ]);
            const storyGlossary = new Map();
            if (glossStr) {
                glossStr.split('|').forEach(p => {
                    const [en, es, pos] = p.split(':');
                    if (en && es) storyGlossary.set(en.trim().toLowerCase(), { translation: es.trim(), pos: pos ? pos.trim() : '' });
                });
            }
            this.state.glossary = new Map([...baseGlossary, ...storyGlossary]);
        },

        createPhrasalVerbMap(phrasalStr = '') {
            this.state.phrasalVerbMap.clear();
            if (!phrasalStr) return;
            phrasalStr.split('|').forEach(p => {
                const parts = p.split(':');
                if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                    this.state.phrasalVerbMap.set(parts[0].trim().toLowerCase(), { translation: parts[1].trim() });
                }
            });
        },
        // Reemplaza la función completa processAudioMarkers en index.html
        // Reemplaza esta función en index.html
       processAudioMarkers() {
            if (!this.state.currentStory || !this.state.marksData || !this.state.marksData.length === 0) {
                this.state.storyWords = [];
                this.state.pageWordStartIndices = [];
                return;
            }
            const allTextTokens = [];
            this.state.currentStory.p.forEach(page => {
                let cleanText = page.c.split('||')[0].replace(/\[\[|\]\]/g, '');
                const pageTokens = cleanText.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(part => part.trim() !== '' && /[\p{L}\p{N}']+/u.test(part));
                allTextTokens.push(...pageTokens);
            });

            const finalAlignedMarks = [];
            let markIndex = 0;
            const rawMarks = this.state.marksData;

            const cleanForFuzzyCompare = (str) => {
                return str.toLowerCase()
                          .replace(/ñ/g, 'a') 
                          .normalize("NFD")
                          .replace(/[\u0300-\u036f]/g, "") 
                          // --- INICIO DE LA MODIFICACIÓN ---
                          .replace(/[aeiou'’-]/g, ""); // Se añadió el guion '-' aquí
                          // --- FIN DE LA MODIFICACIÓN ---
            };

            for (const textToken of allTextTokens) {
                if (markIndex >= rawMarks.length) {
                    console.warn("Se acabaron los marcadores de audio, pero aún hay texto.", { textToken });
                    break;
                }
                const firstMarkInGroup = rawMarks[markIndex];
                let lastMarkInGroup = firstMarkInGroup;
                let builtWordFromMarks = firstMarkInGroup.word;
                let marksConsumed = 1;
                
                const fuzzyTextToken = cleanForFuzzyCompare(textToken);
                
                while (true) {
                    const fuzzyBuiltWord = cleanForFuzzyCompare(builtWordFromMarks);

                    if (fuzzyBuiltWord === fuzzyTextToken) break;
                    
                    const nextMarkIndex = markIndex + marksConsumed;
                    if (nextMarkIndex >= rawMarks.length) break;
                    
                    const potentialNextWord = builtWordFromMarks + rawMarks[nextMarkIndex].word;
                    const fuzzyPotential = cleanForFuzzyCompare(potentialNextWord);
                    
                    if (!fuzzyTextToken.startsWith(fuzzyPotential)) break;
                    
                    builtWordFromMarks = potentialNextWord;
                    lastMarkInGroup = rawMarks[nextMarkIndex];
                    marksConsumed++;
                }

                finalAlignedMarks.push({
                    word: textToken,
                    start: firstMarkInGroup.start,
                    end: lastMarkInGroup.end,
                });
                markIndex += marksConsumed;
            }

            if (markIndex < rawMarks.length) console.warn("Sobraron marcadores de audio después de procesar todo el texto.");
            
            this.state.marksData = finalAlignedMarks;
            this.state.storyWords = this.state.marksData.map(m => m.word);
            this.state.pageWordStartIndices = [];
            let globalWordCount = 0;
            this.state.currentStory.p.forEach(page => {
                this.state.pageWordStartIndices.push(globalWordCount);
                const cleanText = page.c.split('||')[0].replace(/\[\[|\]\]/g, '');
                const pageTokens = cleanText.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(part => part.trim() !== '' && /[\p{L}\p{N}']+/u.test(part));
                globalWordCount += pageTokens.length;
            });
        },
        wrapWordsInSpans(text, pageIndex) {
            this.elements.storyTextEnEl.innerHTML = '';
            const sortedPVs = Array.from(this.state.phrasalVerbMap.keys()).sort((a, b) => b.split(' ').length - a.split(' ').length);
            const tokens = text.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(Boolean);
            const isTokenConsumed = new Array(tokens.length).fill(false);
            let localWordCounter = 0;
            for (let i = 0; i < tokens.length; i++) {
                if (isTokenConsumed[i]) continue;
                let matchFound = false;
                if (/[\p{L}\p{N}']+/u.test(tokens[i])) {
                    for (const pv of sortedPVs) {
                        const pvWords = pv.split(' '); let tempTokenIndex = i; let tempPvWordIndex = 0; const matchedTokensIndices = [];
                        while (tempTokenIndex < tokens.length && tempPvWordIndex < pvWords.length) {
                            if (isTokenConsumed[tempTokenIndex]) break;
                            if (/[\p{L}\p{N}']+/u.test(tokens[tempTokenIndex])) { if (tokens[tempTokenIndex].toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '') === pvWords[tempPvWordIndex]) { matchedTokensIndices.push(tempTokenIndex); tempPvWordIndex++; } else break; }
                            tempTokenIndex++;
                        }
                        if (tempPvWordIndex === pvWords.length) {
                            matchFound = true; 
                            const span = document.createElement('span');
                            const firstTokenIndex = matchedTokensIndices[0]; const lastTokenIndex = matchedTokensIndices[matchedTokensIndices.length - 1];
                            const phrasalVerbText = tokens.slice(firstTokenIndex, lastTokenIndex + 1).join('');
                            span.dataset.text = pv;
                            const startGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter;
                            localWordCounter += pvWords.length;
                            const endGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter - 1;
                            span.dataset.startGlobalIndex = startGlobalIndex; span.dataset.endGlobalIndex = endGlobalIndex;
                            
                            const phrasalData = this.state.phrasalVerbMap.get(pv.toLowerCase());
                            const translationText = (phrasalData && phrasalData.translation) ? phrasalData.translation : '...';

                            if (this.state.isTranslationModeActive) {
                                span.className = 'word word-block phrasal-verb';
                                span.innerHTML = `<span class="word-en pointer-events-none">${phrasalVerbText}</span><span class="word-es pointer-events-none">${translationText}</span>`;
                            } else {
                                span.className = 'word phrasal-verb';
                                span.textContent = phrasalVerbText;
                                span.addEventListener('mouseenter', (event) => { this.Utils.showDynamicTooltip(event.target, translationText); });
                            }

                            span.addEventListener('click', (e) => this.handleWordClick(e));
                            this.elements.storyTextEnEl.appendChild(span);
                            for (let j = firstTokenIndex; j <= lastTokenIndex; j++) isTokenConsumed[j] = true;
                            i = lastTokenIndex; break;
                        }
                    }
                }
                if (!matchFound) {
                    const part = tokens[i]; isTokenConsumed[i] = true;
                    if (/[\p{L}\p{N}']+/u.test(part)) {
                        const span = document.createElement('span');
                        const startGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter;
                        span.dataset.startGlobalIndex = startGlobalIndex; localWordCounter++;
                        const endGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter - 1;
                        span.dataset.endGlobalIndex = endGlobalIndex;
                        const cleanWord = part.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                        
                        if (this.state.isTranslationModeActive) {
                            span.className = 'word word-block';
                            const glossData = this.state.glossary.get(cleanWord);
                            const translation = (glossData && glossData.translation) ? glossData.translation.split('/')[0].trim() : '';
                            span.innerHTML = `<span class="word-en pointer-events-none">${part}</span><span class="word-es pointer-events-none">${translation}</span>`;
                        } else {
                            span.className = 'word';
                            span.textContent = part;
                            span.addEventListener('mouseenter', (event) => { 
                                const cleanWordHover = event.target.textContent.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, ''); 
                                const glossData = this.state.glossary.get(cleanWordHover); 
                                const translationText = (glossData && glossData.translation) ? glossData.translation : '...'; 
                                this.Utils.showDynamicTooltip(event.target, translationText); 
                            });
                        }
                        
                        const learnedWordsForStory = this.state.learnedWords[this.state.currentStory?.id] || [];
                        if (learnedWordsForStory.includes(cleanWord)) {
                            span.classList.add('learned-word');
                        }
                        span.addEventListener('click', (e) => this.handleWordClick(e));
                        this.elements.storyTextEnEl.appendChild(span);
                    } else this.elements.storyTextEnEl.appendChild(document.createTextNode(part));
                }
            }
        },


        handleWordClick(event) {
            const wordEl = event.target.closest('.word'); if (!wordEl) return; 
            this.AudioPlayer.pause();
            const startGlobalIndex = parseInt(wordEl.dataset.startGlobalIndex, 10);
            const endGlobalIndex = parseInt(wordEl.dataset.endGlobalIndex, 10) || startGlobalIndex;
            
            this.AudioPlayer.playWord(startGlobalIndex, endGlobalIndex); 

            if (wordEl.classList.contains('phrasal-verb')) {
                const phrasalText = wordEl.dataset.text;
                const phrasalData = this.state.phrasalVerbMap.get(phrasalText.toLowerCase());
                const breakdown = phrasalText.split(' ').map(word => { const cleanWord = word.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, ''); const glossData = this.state.glossary.get(cleanWord); return { word: word, translation: glossData ? glossData.translation : '...' }; });
                this.Modals.openWord(phrasalText, phrasalData.translation, 'ph. v.', startGlobalIndex, endGlobalIndex, breakdown, wordEl);
            } else {
                const wordText = this.state.isTranslationModeActive ? wordEl.querySelector('.word-en').textContent : wordEl.textContent;
                const cleanWord = wordText.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                const glossData = this.state.glossary.get(cleanWord);
                this.Modals.openWord(wordText, glossData ? glossData.translation : 'Traducción no encontrada', glossData ? glossData.pos : '', startGlobalIndex, endGlobalIndex, null, wordEl);
            }
        },

        updateHighlight() {
            if (!this.state.isPlaying) return;
            const currentTime = this.elements.storyAudio.currentTime;
            const newWordIndex = this.state.marksData.findIndex(mark => currentTime >= mark.start && currentTime < mark.end);
            if (newWordIndex !== -1 && this.state.storyWords[newWordIndex]) { const currentWordText = this.state.storyWords[newWordIndex]; if (this.elements.karaokeWordEl.textContent !== currentWordText) { this.elements.karaokeWordEl.textContent = currentWordText; this.elements.karaokeWordEl.style.opacity = '1'; } } else { this.elements.karaokeWordEl.style.opacity = '0'; }
            if (newWordIndex !== -1 && newWordIndex !== this.state.currentWordIndex) {
                document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
                const isOnCurrentPage = newWordIndex >= this.state.pageWordStartIndices[this.state.currentPageIndex] && (this.state.currentPageIndex === this.state.currentStory.p.length - 1 || newWordIndex < this.state.pageWordStartIndices[this.state.currentPageIndex + 1]);
                if (isOnCurrentPage) {
                    let newWordEl = null;
                    for (const wordSpan of this.elements.storyTextEnEl.querySelectorAll('.word')) { const start = parseInt(wordSpan.dataset.startGlobalIndex, 10); const end = parseInt(wordSpan.dataset.endGlobalIndex, 10) || start; if (newWordIndex >= start && newWordIndex <= end) { newWordEl = wordSpan; break; } }
                    if (newWordEl) {
                        newWordEl.classList.add('active');
                        newWordEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if(!this.state.isTranslationModeActive) { // Only show tooltips if translation mode is off
                            setTimeout(() => { 
                                if (!this.state.isPlaying || !newWordEl.classList.contains('active')) return;
                                let translationText = '...';
                                if (newWordEl.classList.contains('phrasal-verb')) {
                                    const phrasalData = this.state.phrasalVerbMap.get(newWordEl.dataset.text.toLowerCase());
                                    if (phrasalData?.translation) translationText = phrasalData.translation;
                                } else {
                                    const cleanWord = this.state.storyWords[newWordIndex].toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                                    const glossData = this.state.glossary.get(cleanWord);
                                    if (glossData?.translation) translationText = glossData.translation;
                                }
                                this.Utils.showDynamicTooltip(newWordEl, translationText);
                            }, 100);
                        }
                    }
                }
                this.state.currentWordIndex = newWordIndex;
            }
            const lastWordOfPageGlobalIndex = (this.state.pageWordStartIndices[this.state.currentPageIndex + 1] || this.state.marksData.length) - 1;
            if (lastWordOfPageGlobalIndex >= 0 && currentTime >= (this.state.marksData[lastWordOfPageGlobalIndex]?.end || 0)) { 
                this.handlePageEnd();
            } else { 
                this.state.animationFrameId = requestAnimationFrame(() => this.updateHighlight()); 
            }
        },
        
        showGrammar() { if (!this.state.currentStory) return; const pageData = this.state.currentStory.p[this.state.currentPageIndex]; const grammarHTML = pageData.grammar || '<p>No hay notas de gramática para esta página.</p>'; this.Modals.openGeneric('Notas de Gramática', grammarHTML); },
        
        showVocabulary() {
            if (!this.state.currentStory) return;
            const pageData = this.state.currentStory.p[this.state.currentPageIndex];
            if (!pageData.voca) { this.Modals.openGeneric('Vocabulario', '<p>No hay vocabulario para esta página.</p>'); return; }
            const vocabList = pageData.voca.split('|').map(item => { const [en, es] = item.split(':'); return { en: en.trim(), es: es.trim() }; });
            
            let imageSrc = '';
            if (this.state.currentStory.assetType !== 'video') {
                imageSrc = this.elements.storyImageEl.src;
            }

            let contentHTML = imageSrc ? `<img src="${imageSrc}" alt="Story thumbnail" class="w-full h-32 object-cover rounded-lg mb-4">` : '';
            contentHTML += `<div id="vocab-list-container" class="space-y-2 max-h-64 overflow-y-auto pr-2">`;
            vocabList.forEach(item => { 
                contentHTML += `<div class="flex justify-between items-center bg-gray-700 p-2 rounded-md text-sm cursor-pointer hover:bg-gray-600 transition-colors vocab-item" data-word="${item.en}">
                                    <span class="font-semibold text-white pointer-events-none">${item.en}</span>
                                    <span class="text-gray-400 pointer-events-none">${item.es}</span>
                                </div>`; 
            });
            contentHTML += '</div>';
            this.Modals.openGeneric('Vocabulario del Párrafo', contentHTML);
        },
        
        Utils: {
            parseTitle: (s) => { const match = s.match(/^(.*?)<(.*?)>$/); return match ? {t: match[1].trim(), s: match[2].trim()} : {t: s.trim(), s: ''}; },
            getFullPartOfSpeech: (shortPos) => ({ 'n': 'Sustantivo', 'v': 'Verbo', 'adj': 'Adjetivo', 'adv': 'Adverbio', 'prep': 'Preposición', 'conj': 'Conjunción', 'det': 'Determinante', 'pron': 'Pronombre', 'int': 'Interjección', 'ph. v.': 'Verbo Frasal' }[shortPos.toLowerCase()] || shortPos.toUpperCase()),
            showDynamicTooltip(targetElement, text) {
                // Desvanece y elimina tooltips antiguos
                document.querySelectorAll('.dynamic-tooltip.visible').forEach(oldTooltip => {
                    if (oldTooltip.parentElement) {
                        oldTooltip.classList.remove('visible');
                        setTimeout(() => oldTooltip.remove(), 300);
                    }
                });

                const tooltip = document.createElement('div');
                tooltip.className = 'dynamic-tooltip';
                tooltip.textContent = text;
                document.body.appendChild(tooltip);

                const rect = targetElement.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 + (window.scrollX || 0)}px`;
                tooltip.style.top = `${rect.top + (window.scrollY || 0)}px`;
                
                // Añade un desplazamiento vertical aleatorio para evitar solapamientos
                const verticalOffset = -140 - (Math.random() * 25);
                tooltip.style.setProperty('--vertical-transform', `${verticalOffset}%`);

                requestAnimationFrame(() => tooltip.classList.add('visible'));

                const removeTooltip = () => {
                    if (tooltip.parentElement) {
                        tooltip.classList.remove('visible');
                        setTimeout(() => tooltip.remove(), 300);
                    }
                };
                
                targetElement.addEventListener('mouseleave', removeTooltip, { once: true });
                setTimeout(removeTooltip, 3000); // Aumentado a 3 segundos
            },
            speedTooltipTimeout: null,
            showSpeedTooltip(message) {
                const tooltip = App.elements.speedTooltip; 
                if (!tooltip) return;
                if (this.speedTooltipTimeout) clearTimeout(this.speedTooltipTimeout);
                tooltip.textContent = message;
                tooltip.classList.remove('opacity-0');
                this.speedTooltipTimeout = setTimeout(() => {
                    tooltip.classList.add('opacity-0');
                }, 1500);
            },
        },

        Modals: {
            _parent: null,
            _vocabClickHandler: null,
            init(parent) { this._parent = parent; },
            openGeneric(title, contentHTML) { 
                this._parent.AudioPlayer.pause(); 
                this._parent.elements.modalTitle.textContent = title; 
                this._parent.elements.modalContent.innerHTML = contentHTML; 

                if (title === 'Vocabulario del Párrafo') {
                    const vocabContainer = this._parent.elements.modalContent.querySelector('#vocab-list-container');
                    if (vocabContainer) {
                        this._vocabClickHandler = this._handleVocabItemClick.bind(this);
                        vocabContainer.addEventListener('click', this._vocabClickHandler);
                    }
                }

                this._parent.elements.modalOverlay.classList.remove('hidden'); 
                this._parent.elements.modalContainer.classList.remove('hidden');
                this._parent.elements.modalContainer.classList.add('flex');
            },
            closeGeneric() { 
                this._parent.elements.modalOverlay.classList.add('hidden'); 
                this._parent.elements.modalContainer.classList.add('hidden');
                this._parent.elements.modalContainer.classList.remove('flex');
                
                if (this._vocabClickHandler) {
                    const vocabContainer = this._parent.elements.modalContent.querySelector('#vocab-list-container');
                    if (vocabContainer) {
                        vocabContainer.removeEventListener('click', this._vocabClickHandler);
                    }
                    this._vocabClickHandler = null;
                }
            },
            _handleVocabItemClick(e) {
                const vocabItem = e.target.closest('.vocab-item');
                if (!vocabItem) return;

                this._parent.SoundManager.play('click');
                const wordToFind = vocabItem.dataset.word.toLowerCase();
                const wordSpans = this._parent.elements.storyTextEnEl.querySelectorAll('.word');
                
                let targetSpan = null;
                for (const span of wordSpans) {
                    const spanText = span.textContent.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                    if (spanText === wordToFind) {
                        targetSpan = span;
                        break;
                    }
                }

                if (targetSpan) {
                    this.closeGeneric(); 
                    setTimeout(() => {
                        this._parent.handleWordClick({ target: targetSpan });
                    }, 150);
                } else {
                    console.warn(`Word span for "${wordToFind}" not found on the current page.`);
                    this._parent.SoundManager.play('wrong');
                    vocabItem.classList.add('shake');
                    setTimeout(() => vocabItem.classList.remove('shake'), 800);
                }
            },
            openSettings() {
                this._parent.AudioPlayer.pause();
                this._parent.elements.modalOverlay.classList.remove('hidden');
                this._parent.elements.settingsModalContainer.classList.remove('hidden');
                this._parent.elements.settingsModalContainer.classList.add('flex');
            },
            closeSettings() {
                this._parent.elements.modalOverlay.classList.add('hidden');
                this._parent.elements.settingsModalContainer.classList.add('hidden');
                this._parent.elements.settingsModalContainer.classList.remove('flex');
            },
            async openWord(word, translation, pos, startGlobalIndex, endGlobalIndex, breakdown, wordEl) {
                this._parent.elements.wordModalTitle.textContent = word;
                this._parent.elements.wordModalTranslation.textContent = translation;
                this._parent.elements.wordModalContainer.classList.add('flex');
                this._parent.elements.wordModalContainer.classList.remove('hidden');
                if (pos) { this._parent.elements.wordModalPos.textContent = this._parent.Utils.getFullPartOfSpeech(pos); this._parent.elements.wordModalPos.classList.remove('hidden'); }
                else { this._parent.elements.wordModalPos.classList.add('hidden'); }
                const breakdownContainer = document.getElementById('word-modal-breakdown');
                if (breakdown && breakdown.length > 0) { breakdownContainer.classList.remove('hidden'); breakdownContainer.innerHTML = '<div class="space-y-1.5">' + breakdown.map(item => `<div class="flex justify-between items-baseline text-sm"><span class="font-semibold text-gray-200">${item.word}</span><span class="text-indigo-300 italic">${item.translation}</span></div>`).join('') + '</div>'; } else { breakdownContainer.classList.add('hidden'); breakdownContainer.innerHTML = ''; }
                this._parent.elements.wordModalImage.classList.add('hidden'); this._parent.elements.wordModalImage.src = '';
                this._parent.elements.wordModalImageLoader.classList.remove('hidden'); this._parent.elements.wordModalImageLoader.textContent = 'Buscando imagen...';
                
                const cleanAndGetBtn = (id) => { const oldBtn = document.getElementById(id); const newBtn = oldBtn.cloneNode(true); oldBtn.parentNode.replaceChild(newBtn, oldBtn); return newBtn; };
                cleanAndGetBtn('word-modal-ok-btn').addEventListener('click', () => { this._parent.SoundManager.play('ok'); this.closeWord(); });
                cleanAndGetBtn('word-modal-learn-btn').addEventListener('click', () => { 
                    this._parent.SoundManager.play('click');
                    this._parent.SpellingGame.start(word, wordEl, startGlobalIndex, endGlobalIndex);
                });
                cleanAndGetBtn('word-modal-continue-btn').addEventListener('click', () => { this._parent.SoundManager.play('ok'); this.closeWord(); if (this._parent.state.marksData[startGlobalIndex]) { this._parent.elements.storyAudio.currentTime = this._parent.state.marksData[startGlobalIndex].start; this._parent.AudioPlayer.play(); } });
                cleanAndGetBtn('word-modal-listen-btn').addEventListener('click', () => { this._parent.SoundManager.play('click'); this._parent.AudioPlayer.playWord(startGlobalIndex, endGlobalIndex); });

                const imageUrl = await this._parent.fetchWordImage(word, translation);
                if (imageUrl) { this._parent.elements.wordModalImage.src = imageUrl; this._parent.elements.wordModalImage.onload = () => { this._parent.elements.wordModalImage.classList.remove('hidden'); this._parent.elements.wordModalImageLoader.classList.add('hidden'); }; }
                else { this._parent.elements.wordModalImageLoader.textContent = 'Imagen no encontrada.'; }
            },
            closeWord() { 
                this._parent.elements.wordModalContainer.classList.add('hidden');
                this._parent.SpellingGame.cleanup();
            },
        },
        
        SpellingGame: {
            _parent: null,
            init(parent) { this._parent = parent; },
            currentTargetWord: '',
            targetWordEl: null,
            startGlobalIndex: -1,
            endGlobalIndex: -1,
            userInput: [],
            hintIndices: [],

            start(word, wordEl, startGlobalIndex, endGlobalIndex) {
                this._parent.elements.wordModalDefaultView.classList.add('hidden');
                
                // Populate the spelling view with image and translation from the default view
                const mainImageEl = this._parent.elements.wordModalImage;
                const mainTranslationEl = this._parent.elements.wordModalTranslation;
                
                const spellingImageEl = document.getElementById('word-modal-spelling-image');
                const spellingTranslationEl = document.getElementById('word-modal-spelling-translation');

                if (mainImageEl.src && !mainImageEl.classList.contains('hidden')) {
                    spellingImageEl.src = mainImageEl.src;
                    spellingImageEl.classList.remove('hidden');
                } else {
                    spellingImageEl.classList.add('hidden');
                    spellingImageEl.src = '';
                }
                spellingTranslationEl.textContent = mainTranslationEl.textContent;

                this._parent.elements.wordModalSpellingView.classList.remove('hidden');
                
                this.currentTargetWord = word.replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                this.targetWordEl = wordEl;
                this.startGlobalIndex = startGlobalIndex;
                this.endGlobalIndex = endGlobalIndex;

                // Lógica para las pistas (letras pre-rellenadas)
                let hintIndices = new Set();
                if (this.currentTargetWord.length > 3) { // Solo dar pistas para palabras más largas
                    while (hintIndices.size < 2) {
                        hintIndices.add(Math.floor(Math.random() * this.currentTargetWord.length));
                    }
                }
                this.hintIndices = Array.from(hintIndices);

                // Inicializar la entrada del usuario con las pistas
                this.userInput = new Array(this.currentTargetWord.length).fill(null);
                this.hintIndices.forEach(index => {
                    this.userInput[index] = this.currentTargetWord[index].toUpperCase();
                });
                
                this.createSlots();
                this.createChoices();
                this.bindGameListeners();
            },

            createSlots() {
                const slotsContainer = document.getElementById('word-modal-spelling-slots');
                slotsContainer.innerHTML = '';
                slotsContainer.classList.remove('correct', 'shake');
                for (let i = 0; i < this.currentTargetWord.length; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'spelling-slot';
                    if (this.hintIndices.includes(i)) {
                        slot.textContent = this.currentTargetWord[i].toUpperCase();
                        slot.classList.add('text-indigo-400', 'border-indigo-500'); // Estilo para pistas
                    }
                    slotsContainer.appendChild(slot);
                }
            },

            createChoices() {
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                choicesContainer.innerHTML = '';
                const wordLetters = this.currentTargetWord.toLowerCase().split('');

                // Crear una copia de las letras para poder modificarlas
                let lettersForChoices = [...wordLetters];
                
                // Quitar las letras de las pistas del pool de opciones
                this.hintIndices.forEach(index => {
                    const hintLetter = this.currentTargetWord[index].toLowerCase();
                    const indexToRemove = lettersForChoices.indexOf(hintLetter);
                    if (indexToRemove > -1) {
                        lettersForChoices.splice(indexToRemove, 1);
                    }
                });

                const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                const distractors = [];
                // Añadir letras distractoras
                while (distractors.length < 4 && distractors.length < 12 - lettersForChoices.length) {
                    const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                    if (!wordLetters.includes(randomLetter) && !distractors.includes(randomLetter)) {
                        distractors.push(randomLetter);
                    }
                }
                const choices = [...lettersForChoices, ...distractors];
                // Barajar las opciones
                for (let i = choices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [choices[i], choices[j]] = [choices[j], choices[i]];
                }

                choices.forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter.toUpperCase();
                    choicesContainer.appendChild(button);
                });
            },
            
            bindGameListeners() {
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                choicesContainer.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                        this.handleLetterChoice(e.target);
                    }
                };
                const deleteBtn = document.getElementById('word-modal-spelling-delete-btn');
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                newDeleteBtn.onclick = () => this.handleDelete();
            },

            handleLetterChoice(button) {
                // Contar cuántas letras ha introducido el usuario (excluyendo pistas)
                const userFilledSlots = this.userInput.filter(l => l !== null).length;

                if (userFilledSlots < this.currentTargetWord.length) {
                    let nextEmptyIndex = this.userInput.findIndex(slot => slot === null);
                    if (nextEmptyIndex !== -1) {
                        this.userInput[nextEmptyIndex] = button.textContent;
                        button.disabled = true;
                        this.updateSlots();
                        if (this.userInput.filter(l => l).length === this.currentTargetWord.length) {
                            this.checkWord();
                        }
                    }
                }
            },

            handleDelete() {
                let lastFilledIndex = -1;
                // Encontrar el último índice que fue llenado por el usuario (no una pista)
                for (let i = this.userInput.length - 1; i >= 0; i--) {
                    if (this.userInput[i] !== null && !this.hintIndices.includes(i)) {
                        lastFilledIndex = i;
                        break;
                    }
                }

                if (lastFilledIndex !== -1) {
                    const letterToRemove = this.userInput[lastFilledIndex];
                    this.userInput[lastFilledIndex] = null;
                    
                    const choicesContainer = document.getElementById('word-modal-spelling-choices');
                    const buttonToEnable = Array.from(choicesContainer.children).find(btn => btn.textContent === letterToRemove && btn.disabled);
                    if (buttonToEnable) buttonToEnable.disabled = false;
                    
                    this.updateSlots();
                }
            },

            updateSlots() {
                const slots = document.getElementById('word-modal-spelling-slots').children;
                for (let i = 0; i < slots.length; i++) {
                    // Solo actualizar los slots que no son pistas
                    if (!this.hintIndices.includes(i)) {
                        slots[i].textContent = this.userInput[i] || '';
                    }
                }
            },

            checkWord() {
                const isCorrect = this.userInput.join('').toLowerCase() === this.currentTargetWord.toLowerCase();
                const slotsContainer = document.getElementById('word-modal-spelling-slots');
                
                if (isCorrect) {
                    this._parent.SoundManager.play('congrats');
                    slotsContainer.classList.add('correct');
                    this._parent.SettingsManager.addLearnedWord(this._parent.state.currentStory.id, this.currentTargetWord);
                    this.targetWordEl.classList.add('learned-word');
                    setTimeout(() => this.highlightAndSpeak(), 500);
                    setTimeout(() => this._parent.Modals.closeWord(), 1800);
                } else {
                    this._parent.SoundManager.play('wrong');
                    slotsContainer.classList.add('shake');
                    setTimeout(() => {
                        slotsContainer.classList.remove('shake');
                        this.resetGame();
                    }, 800);
                }
            },
            
            highlightAndSpeak() {
                this.targetWordEl.style.transition = 'background-color 0.2s, transform 0.2s';
                this.targetWordEl.style.backgroundColor = 'rgba(79, 70, 229, 0.5)';
                this.targetWordEl.style.transform = 'scale(1.1)';
                this._parent.AudioPlayer.playWord(this.startGlobalIndex, this.endGlobalIndex);
                setTimeout(() => {
                    this.targetWordEl.style.backgroundColor = '';
                    this.targetWordEl.style.transform = '';
                }, 800);
            },

            resetGame() {
                // Solo limpiar las letras que el usuario introdujo
                this.userInput.forEach((letter, index) => {
                    if (!this.hintIndices.includes(index)) {
                        this.userInput[index] = null;
                    }
                });

                this.updateSlots();
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                Array.from(choicesContainer.children).forEach(btn => btn.disabled = false);
            },

            cleanup() {
                this._parent.elements.wordModalDefaultView.classList.remove('hidden');
                this._parent.elements.wordModalSpellingView.classList.add('hidden');

                // Clean up game elements
                document.getElementById('word-modal-spelling-slots').innerHTML = '';
                document.getElementById('word-modal-spelling-choices').innerHTML = '';
                document.getElementById('word-modal-spelling-image').src = '';
                document.getElementById('word-modal-spelling-image').classList.add('hidden');
                document.getElementById('word-modal-spelling-translation').textContent = '';

                // Reset state
                this.currentTargetWord = '';
                this.targetWordEl = null;
                this.startGlobalIndex = -1;
                this.endGlobalIndex = -1;
                this.userInput = [];
                this.hintIndices = [];
            }
        },

        SettingsManager: {
            _parent: null,
            init(parent) {
                this._parent = parent;
                this.loadSettings();
            },
            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem(this._parent.config.SETTINGS_KEY));
                    if (settings) {
                        this._parent.state.fontSizeMultiplier = settings.fontSizeMultiplier || 1.0;
                        this._parent.state.learnedWords = settings.learnedWords || {};
                        this._parent.state.isAutoplayEnabled = settings.isAutoplayEnabled || false;
                        this._parent.state.isMuted = settings.isMuted || false;
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                    this._parent.state.fontSizeMultiplier = 1.0;
                    this._parent.state.learnedWords = {};
                    this._parent.state.isAutoplayEnabled = false;
                    this._parent.state.isMuted = false;
                }
                this.applyFontSize();
                this.applyAutoplaySetting();
                this.applyMuteSetting();
            },
            saveSettings() {
                try {
                    const settings = {
                        fontSizeMultiplier: this._parent.state.fontSizeMultiplier,
                        learnedWords: this._parent.state.learnedWords,
                        isAutoplayEnabled: this._parent.state.isAutoplayEnabled,
                        isMuted: this._parent.state.isMuted
                    };
                    localStorage.setItem(this._parent.config.SETTINGS_KEY, JSON.stringify(settings));
                } catch (e) {
                    console.error("Error saving settings:", e);
                }
            },
            addLearnedWord(storyId, word) {
                if (!this._parent.state.learnedWords[storyId]) {
                    this._parent.state.learnedWords[storyId] = [];
                }
                const cleanWord = word.toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                if (!this._parent.state.learnedWords[storyId].includes(cleanWord)) {
                    this._parent.state.learnedWords[storyId].push(cleanWord);
                    this.saveSettings();
                }
            },
            changeFontSize(direction) {
                let newSize = this._parent.state.fontSizeMultiplier + (direction * 0.1);
                newSize = Math.max(0.7, Math.min(1.5, newSize));
                this._parent.state.fontSizeMultiplier = newSize;
                this.applyFontSize();
                this.saveSettings();
            },
            applyFontSize() {
                const multiplier = this._parent.state.fontSizeMultiplier;
                document.documentElement.style.setProperty('--story-font-size-multiplier', multiplier);
                this._parent.elements.fontSizeDisplay.textContent = `${Math.round(multiplier * 100)}%`;
            },
            toggleAutoplay() {
                this._parent.SoundManager.play('click');
                this._parent.state.isAutoplayEnabled = this._parent.elements.autoplayToggle.checked;
                this.saveSettings();
            },
            applyAutoplaySetting() {
                if (this._parent.elements.autoplayToggle) {
                    this._parent.elements.autoplayToggle.checked = this._parent.state.isAutoplayEnabled;
                }
            },
            toggleMute() {
                this._parent.SoundManager.play('click');
                this._parent.state.isMuted = !this._parent.state.isMuted;
                this.applyMuteSetting();
                this.saveSettings();
            },
            applyMuteSetting() {
                const isMuted = this._parent.state.isMuted;
                this._parent.SoundManager.applyMuteState(isMuted);

                // Actualizar icono del botón de mute en la vista de la historia
                if (isMuted) {
                    this._parent.elements.soundOnIcon.classList.add('hidden');
                    this._parent.elements.soundOffIcon.classList.remove('hidden');
                } else {
                    this._parent.elements.soundOnIcon.classList.remove('hidden');
                    this._parent.elements.soundOffIcon.classList.add('hidden');
                }
                // Actualizar icono del botón de mute en el menú principal
                if (this._parent.elements.mainMenuSoundOnIcon) {
                     if (isMuted) {
                        this._parent.elements.mainMenuSoundOnIcon.classList.add('hidden');
                        this._parent.elements.mainMenuSoundOffIcon.classList.remove('hidden');
                    } else {
                        this._parent.elements.mainMenuSoundOnIcon.classList.remove('hidden');
                        this._parent.elements.mainMenuSoundOffIcon.classList.add('hidden');
                    }
                }
            }
        },



        WordNavigator: {
            _parent: null,
            init(parent) {
                this._parent = parent;
            },
            navigate(direction) {
                this._parent.SoundManager.play('click');
                this._parent.AudioPlayer.pause();

                const state = this._parent.state;
                if (!state.currentStory || state.marksData.length === 0) return;

                // 1. Determina los límites de las palabras en la página actual
                const currentPageIndex = state.currentPageIndex;
                const pageStartIdx = state.pageWordStartIndices[currentPageIndex];
                const isLastPage = currentPageIndex === state.currentStory.p.length - 1;
                const pageEndIdx = isLastPage ? state.marksData.length - 1 : state.pageWordStartIndices[currentPageIndex + 1] - 1;

                // 2. Calcula el nuevo índice de la palabra
                let currentIdx = state.currentWordIndex;
                // Si no hay ninguna palabra seleccionada, empieza desde el inicio o final de la página
                if (currentIdx < pageStartIdx || currentIdx > pageEndIdx) {
                    currentIdx = (direction === 1) ? pageStartIdx - 1 : pageEndIdx + 1;
                }

                let newIndex = currentIdx + direction;

                // 3. Verifica que el nuevo índice esté dentro de los límites de la página
                if (newIndex < pageStartIdx || newIndex > pageEndIdx) {
                    return; // No hace nada si se llega al límite
                }

                // 4. Actualiza el estado con el nuevo índice
                state.currentWordIndex = newIndex;

                // 5. Encuentra el elemento <span> correspondiente a la nueva palabra
                let newWordEl = null;
                for (const wordSpan of this._parent.elements.storyTextEnEl.querySelectorAll('.word')) {
                    const start = parseInt(wordSpan.dataset.startGlobalIndex, 10);
                    const end = parseInt(wordSpan.dataset.endGlobalIndex, 10) || start;
                    if (newIndex >= start && newIndex <= end) {
                        newWordEl = wordSpan;
                        break;
                    }
                }
                
                if (newWordEl) {
                    // 6. Resalta la nueva palabra
                    document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
                    newWordEl.classList.add('active');
                    newWordEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // 7. Muestra el tooltip con la traducción
                    let translationText = '...';
                    if (newWordEl.classList.contains('phrasal-verb')) {
                        const phrasalData = state.phrasalVerbMap.get(newWordEl.dataset.text.toLowerCase());
                        if (phrasalData?.translation) translationText = phrasalData.translation;
                    } else {
                        const cleanWord = state.storyWords[newIndex].toLowerCase().replace(/^[.,;!?:“”"-]+|[.,;!?:“”"-]+$/g, '');
                        const glossData = state.glossary.get(cleanWord);
                        if (glossData?.translation) translationText = glossData.translation;
                    }
                    this._parent.Utils.showDynamicTooltip(newWordEl, translationText);

                    // 8. Reproduce el audio de la palabra
                    const startIdx = parseInt(newWordEl.dataset.startGlobalIndex, 10);
                    const endIdx = parseInt(newWordEl.dataset.endGlobalIndex, 10) || startIdx;
                    this._parent.AudioPlayer.playWord(startIdx, endIdx);
                }
            }
        },

         async fetchWordImage(word, translation) {
            // Si la historia es de categoría "infantiles", usamos Pixabay con la palabra en español
            if (this.state.currentStory && this.state.currentStory.difficulty.toLowerCase() === 'infantiles') {
                // La traducción puede tener varias opciones (ej: "casa / hogar"), tomamos solo la primera.
                const firstTranslation = translation.split('/')[0].trim();
                return await this._fetchPixabayImage(firstTranslation);
            }
            // Para el resto de categorías, usamos Pexels con la palabra en inglés
            else {
                return await this._fetchPexelsImage(word);
            }
        },

        async _fetchPexelsImage(word) {
            try {
                const response = await fetch(`${this.config.PEXELS_WORKER_URL}/search?query=${encodeURIComponent(word)}&per_page=1`);
                if (!response.ok) throw new Error(`Error from Pexels worker: ${response.statusText}`);
                const data = await response.json();
                return data.photos && data.photos.length > 0 ? data.photos[0].src.medium : null;
            } catch (error) {
                console.error("Error fetching image from Pexels:", error);
                return null;
            }
        },
        
        async _fetchPixabayImage(wordInSpanish) {
            try {
                // Hacemos la llamada al nuevo worker de Pixabay
                const response = await fetch(`${this.config.PIXABAY_WORKER_URL}?query=${encodeURIComponent(wordInSpanish)}`);
                if (!response.ok) throw new Error(`Error from Pixabay worker: ${response.statusText}`);
                const data = await response.json();
                // La estructura de respuesta de Pixabay es diferente. Las imágenes están en 'hits'.
                return data.hits && data.hits.length > 0 ? data.hits[0].webformatURL : null;
            } catch (error) {
                console.error("Error fetching image from Pixabay:", error);
                return null;
            }
        },

        ActivityManager: {
            _parent: null,
            init(parent) { this._parent = parent; },
            _getBadgeForScore(score) {
                if (score === null || score === undefined || score < 1) return '<span class="activity-progress-badge badge-gray">No iniciado</span>';
                if (score < 100) return `<span class="activity-progress-badge badge-yellow">${score}%</span>`;
                return `<span class="activity-progress-badge badge-green">Completado</span>`;
            },
           // index.html -> dentro de ActivityManager

// REEMPLAZAR LA FUNCIÓN COMPLETA showActivitiesView
// index.html -> dentro de ActivityManager
// REEMPLAZAR LA FUNCIÓN COMPLETA showActivitiesView
// REEMPLAZA ESTA FUNCIÓN COMPLETA en index.html (dentro de App.ActivityManager)

// index.html -> Reemplaza esta función completa en App.ActivityManager

// index.html -> Reemplaza esta función completa en App.ActivityManager

// index.html -> Reemplaza esta función completa en App.ActivityManager

showActivitiesView() {
    const currentStory = this._parent.state.currentStory;
    
    console.log("3. INTENTANDO MOSTAR LISTA DE ACTIVIDADES.");
    
    if (!currentStory || !currentStory.g || !currentStory.g.length === 0) { 
        this._parent.Modals.openGeneric('Actividades', '<p>No hay actividades disponibles para esta historia.</p>'); 
        return; 
    }
    
    this._parent.AudioPlayer.pause();
    const { t: title } = this._parent.Utils.parseTitle(currentStory.meta.t);
    this._parent.elements.activitiesSubtitle.textContent = title;

    // --- INICIO DE LA MODIFICACIÓN ---

    // 1. En contentHTML, ponemos el texto "Publicidad" y el DIV contenedor del banner al INICIO.
    //    Usamos 'text-[0.6rem]' (letra muy pequeña), 'text-gray-500' y 'text-center'.
    let contentHTML = ``;

    // 2. Mantenemos tu lógica actual para generar las tarjetas de los juegos
    currentStory.g.forEach(game => {
        const { t: gameTitle } = this._parent.Utils.parseTitle(game.t);
        let progress = 0;
        let activityData;

        if (game.id === 6) { 
            const totalParagraphs = currentStory.p.length;
            const completedParagraphs = this._parent.ProgressManager.getCompletedParagraphs(currentStory.id, game.id).length;
            if (totalParagraphs > 0) {
                progress = Math.round((completedParagraphs / totalParagraphs) * 100);
            }
        } else { 
            activityData = this._parent.ProgressManager.getProgress(currentStory.id, game.id);
            progress = activityData ? activityData.progress : 0;
        }

        const badgeHTML = this._getBadgeForScore(progress);
        const descriptions = { 
            1: "Ordena las palabras para formar frases de la historia.", 
            2: "Pon a prueba tu comprensión con estas preguntas.", 
            3: "Encuentra los pares de palabras y sus traducciones.", 
            4: "Usa las letras para rellenar el espacio en blanco.", 
            5: "Encuentra las 8 palabras del vocabulario escondidas en el tablero.",
            6: "Detén la línea en el momento justo para ordenar el párrafo.",
            7: "Encesta en la canasta con la traducción correcta."
        };

        contentHTML += `<div class="p-4 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors game-selector relative shadow-lg flex items-start gap-4" data-game-id="${game.id}">
                            <img src="act${game.id}.png" alt="${gameTitle}" class="flex-shrink-0 w-16 h-16 rounded-lg">
                            <div class="flex-grow min-w-0">
                                <div class="flex justify-between items-start gap-2">
                                    <h4 class="font-bold text-white text-lg truncate">${gameTitle}</h4>
                                    ${badgeHTML} </div>
                                <p class="text-sm text-gray-400 mt-1">${descriptions[game.id] || "Un nuevo desafío te espera."}</p>
                            </div>
                        </div>`;
    });

    // 3. Insertamos el HTML (banner primero, luego los juegos) en el DOM.
    this._parent.elements.activitiesList.innerHTML = contentHTML;

    

    // 5. El resto de tu función se mantiene igual.
    this._parent.elements.activitiesList.querySelectorAll('.game-selector').forEach(el => { el.onclick = () => { const gameId = parseInt(el.dataset.gameId, 10); this.startGame(gameId); }; });
    this._parent.showScreen('activities');
},
            // REEMPLAZA TU FUNCIÓN startGame ACTUAL CON ESTA VERSIÓN CORREGIDA

           // REEMPLAZAR FUNCIÓN COMPLETA
// index.html -> Reemplazar la función startGame en ActivityManager
// highlight-start
// REEMPLAZAR FUNCIÓN COMPLETA
// index.html -> Reemplazar la función startGame en ActivityManager
// index.html -> Reemplazar la función startGame en ActivityManager
// CÓDIGO CORREGIDO
startGame(gameId, paragraphIndex = null) {
    this._parent.SoundManager.play('select');
    const gameData = this._parent.state.currentStory.g.find(g => g.id === gameId);
    if (!gameData) { console.error(`Juego con id ${gameId} no encontrado.`); return; }
    
    this._parent.showScreen('game');
    
    const storyId = this._parent.state.currentStory.id;
    let gameModule;

    const dependencies = {
        saveProgress: this._parent.ProgressManager.saveProgress.bind(this._parent.ProgressManager),
        fetchImage: (word, translation) => this._parent.fetchWordImage(word, translation),
        playSound: (name) => this._parent.SoundManager.play(name),
        currentStory: this._parent.state.currentStory,
        glossary: this._parent.state.glossary,
        marksData: this._parent.state.marksData,
         pageWordStartIndices: this._parent.state.pageWordStartIndices,
        playFragmentAudio: (start, end) => this._parent.AudioPlayer.playWord(start, end),
        saveCompletedParagraph: (sId, gId, pIndex) => this._parent.ProgressManager.saveCompletedParagraph(sId, gId, pIndex),
        getCompletedParagraphs: (sId, gId) => this._parent.ProgressManager.getCompletedParagraphs(sId, gId),
    };

    dependencies.onClose = () => {
        this._parent.state.activeGame = null;
        this._parent.ActivityManager.showActivitiesView();
    };

    switch(gameId) {
        case 1: gameModule = JumbledSentencesGame; gameModule.init(gameData, this._parent.state.glossary, storyId, dependencies); break;
        case 2: gameModule = QuizGame; gameModule.init(gameData, storyId, dependencies); break;
        case 3: 
            gameModule = MemoryCardsGame;
            dependencies.playWordAudio = (globalIndex) => this._parent.AudioPlayer.playWord(globalIndex);
            dependencies.createSparkleEffect = (element) => this._parent.createSparkleEffect(element);
            gameModule.init(gameData, storyId, dependencies); 
            break;
        case 4: gameModule = FillTheBlanksGame; gameModule.init(gameData, storyId, dependencies); break;
        case 5:
            gameModule = WordSearchGame;
            dependencies.playWordAudio = (globalIndex) => this._parent.AudioPlayer.playWord(globalIndex);
            gameModule.init(gameData, storyId, dependencies);
            break;
        case 6: 
            gameModule = StopTheLineGame;
            if (paragraphIndex !== null) {
                dependencies.onClose = () => {
                    this._parent.state.activeGame = null;
                    this._parent.showScreen('story');
                    // highlight-start
                    // AÑADE ESTA LÍNEA PARA FORZAR LA ACTUALIZACIÓN
                    this._parent.renderCurrentPage(); 
                    // highlight-end
                };
            }
            gameModule.init(gameData, storyId, dependencies, paragraphIndex);
            break;
        case 7: // <-- AÑADIR ESTE BLOQUE
            gameModule = BallShotGame;
            gameModule.init(gameData, storyId, dependencies);
            break;
        default: 
            this._parent.Modals.openGeneric('Próximamente', '<p>Este juego aún no está implementado.</p>');
            this._parent.showScreen('activities');
            return;
    }
    
    this._parent.state.activeGame = gameModule;
}
// highlight-end
        }
    };
    
    App.ProgressManager.init(App);
    App.AudioPlayer.init(App);
    App.Modals.init(App);
    App.ActivityManager.init(App);
    App.init();
    window.App = App;
});
</script>
</body>
</html>

