<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive English Stories</title>
    
    <!-- Enlace al Manifest para la PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Color de la barra de estado en móviles -->
    <meta name="theme-color" content="#111827">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos base para el cuerpo, optimizados para la vista de escritorio */
        :root {
            --story-font-size-multiplier: 1.0; /* Variable CSS para el tamaño de la fuente */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #111827; 
        }
        /* En pantallas md y superiores, usamos flexbox para centrar el contenedor de la app */
        @media (min-width: 768px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 2rem;
            }
        }

        #install-app-btn {
            display: none; /* Oculto por defecto, se mostrará con JS si es instalable */
        }

        .hidden { display: none; }
        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2), 0 4px 6px -4px rgba(79, 70, 229, 0.2);
            border-color: #4A5568;
        }        
        .filter-btn { transition: all 0.2s ease-in-out; }
        .filter-btn.active { background-color: #4f46e5; color: white; border-color: #6d28d9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .word { position: relative; transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out, box-shadow 0.1s ease-in-out; padding: 2px 1px; border-radius: 3px; cursor: pointer; }
        .word.active {
            background-color: rgba(10, 10, 10, 0.4);
            box-shadow: 0 0 0 1.5px #8B5CF6;
            color: #FFFFFF;
        }
        .word.phrasal-verb {
            background-color: rgba(167, 139, 250, 0.15);
            padding: 2px 4px;
            white-space: nowrap;
        }
        .word.phrasal-verb.active {
            background-color: rgba(139, 92, 246, 0.2);
        }
        
        .play-button-shadow { box-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }

        .dynamic-tooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.9);
            color: #FBBF24;
            border: 1px solid #3B82F6;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 9999;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .dynamic-tooltip {
            transform: translate(-50%, -120%);
        }
        .dynamic-tooltip.visible {
            opacity: 1;
            transform: translate(-50%, -140%);
        }
        .dynamic-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: #3B82F6 transparent transparent transparent;
        }

        #story-text-en {
            font-size: calc(1.25rem * var(--story-font-size-multiplier));
            line-height: calc(1.6 * var(--story-font-size-multiplier));
        }
        @media (min-width: 768px) {
            #story-text-en {
                font-size: calc(1.5rem * var(--story-font-size-multiplier));
            }
        }


        #modal-content .grammar-section h3, #modal-content .vocabulary-section h3 {
            color: #a78bfa; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem;
            border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;
        }
        #modal-content .grammar-section p, #modal-content .vocabulary-section p { margin-bottom: 1rem; line-height: 1.6; color: #d1d5db; }
        #modal-content strong, #modal-content b { color: #c4b5fd; font-weight: 600; }
        #modal-content code { background-color: #374151; color: #f9fafb; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }

        .story-status-badge {
            position: absolute; bottom: 0.5rem; right: 0.5rem; z-index: 10; padding: 0.15rem 0.6rem;
            font-size: 0.7rem; font-weight: 700; color: white; border-radius: 9999px; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .activity-progress-badge {
            padding: 2px 8px; font-size: 0.7rem; font-weight: 600; border-radius: 9999px; color: white;
        }
        .badge-gray { background-color: #4b5563; color: #d1d5db; }
        .badge-yellow { background-color: #ca8a04; } /* Adjusted yellow for better contrast */
        .badge-green { background-color: #16a34a; }

        .word-draggable {
            padding: 8px 16px; background-color: #4B5563; border-radius: 6px; cursor: grab; 
            transition: all 0.2s ease-in-out; user-select: none; border-bottom: 3px solid #374151;
        }
        .word-draggable:active { cursor: grabbing; transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .word-draggable.dragging { opacity: 0.4; transform: scale(0.95); }
        .word-draggable.correct { background-color: #166534; border-color: #14532d; cursor: default; }
        #jumbled-drop-zone.drag-over { border-color: #8B5CF6; background-color: #374151; }
        .word-translation { display: block; font-size: 0.75rem; color: #a5b4fc; margin-top: 2px; font-style: italic; }

        #quiz-timer-container {
            width: 100%; background-color: #374151; border-radius: 9999px; overflow: hidden;
            height: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        #quiz-timer-bar {
            height: 100%; border-radius: 9999px; transition: width 1s linear, background-color 0.5s;
        }
        .quiz-option-btn {
            width: 100%; text-align: left; padding: 10px 16px; background-color: #4b5563; border-radius: 8px; 
            font-weight: 600; transition: all 0.2s ease-in-out; border-left: 5px solid transparent;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);
        }
        .quiz-option-btn:not(:disabled):hover { background-color: #6b7280; transform: translateY(-2px); border-left-color: #8B5CF6; }
        .quiz-option-btn:disabled { opacity: 0.7; }
        .quiz-option-btn.correct-answer { background-color: #16a34a; border-left-color: #bbf7d0; color: white; animation: pulse-correct 0.8s; }
        .quiz-option-btn.wrong-answer { background-color: #dc2626; border-left-color: #fecaca; color: white; animation: shake 0.5s; }
        @keyframes pulse-correct { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        #memory-grid {
            display: grid;
            gap: 0.75rem; 
            grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
            perspective: 1000px;
        }
        .memory-card {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        
        }
        .memory-card.is-flipped { transform: rotateY(180deg); }
        .memory-card.is-matched { cursor: default; animation: vanish-effect 0.6s ease-in 0.2s forwards; }
        @keyframes vanish-effect { to { opacity: 0; transform: scale(0.9); } }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 0.75rem; box-shadow: 0 4px 10px rgba(0,0,0,0.4); overflow: hidden;
        }
        .card-front { background: linear-gradient(135deg, #4f46e5, #8b5cf6); display: flex; align-items: center; justify-content: center; }
        .card-front-icon { width: 50%; height: 50%; color: rgba(255,255,255,0.8); }
        .card-back { background-color: #374151; transform: rotateY(180deg); display: flex; flex-direction: column; }
        .card-back-image { height: 80%; width: 100%; object-fit: cover; }
        .card-back-text-container {
            height: 20%; padding: 4px; display: flex; flex-direction: column; 
            justify-content: center; text-align: center; background-color: #1f2937;
        }
        .card-back-word { font-size: 0.8rem; font-weight: 700; line-height: 1.1; color: #e5e7eb; }
        .card-back-translation { font-size: 0.65rem; color: #a5b4fc; font-style: italic; }
        
        .letter-slot {
            width: 40px; height: 50px; background-color: #1f2937; border-bottom: 3px solid #4b5563; border-radius: 6px;
            display: inline-flex; justify-content: center; align-items: center; font-size: 1.5rem;
            font-weight: 700; text-transform: uppercase; transition: all 0.2s ease-in-out; user-select: none;
        }
        #fill-blanks-word-container.correct .letter-slot { background-color: #166534; border-color: #14532d; color: #dcfce7; }
        .letter-choice {
            width: 45px; height: 45px; background-color: #4b5563; border-radius: 8px;
            border-bottom: 3px solid #374151; font-weight: 600; font-size: 1.1rem; transition: all 0.15s ease-in-out;
        }
        .letter-choice:not(:disabled):hover { background-color: #6b7280; transform: translateY(-2px); }
        .letter-choice:disabled { opacity: 0.3; background-color: #374151; border-bottom-width: 1px; }
        #fill-blanks-delete-btn { padding: 0.5rem 1rem; background-color: #be123c; border-radius: 8px; font-weight: 600; }

        /* Estilos para el mini-juego de deletreo en el modal */
        .spelling-slot {
            width: 35px; height: 45px; background-color: #1f2937; border-bottom: 3px solid #4b5563; border-radius: 6px;
            display: inline-flex; justify-content: center; align-items: center; font-size: 1.5rem;
            font-weight: 700; text-transform: uppercase; transition: all 0.2s ease-in-out; user-select: none;
        }
        .spelling-choices button {
            width: 40px; height: 40px; background-color: #4b5563; border-radius: 8px;
            border-bottom: 3px solid #374151; font-weight: 600; font-size: 1.1rem; transition: all 0.15s ease-in-out;
        }
        .spelling-choices button:not(:disabled):hover {
            background-color: #6b7280; transform: translateY(-2px);
        }
        .spelling-choices button:disabled {
            opacity: 0.3; background-color: #374151; border-bottom-width: 1px;
        }

        #word-modal-spelling-slots.correct .spelling-slot {
            background-color: #166534; border-color: #14532d; color: #dcfce7;
        }

        /* Estilo para palabras aprendidas en la historia */
        .word.learned-word {
            background-color: rgba(250, 204, 21, 0.2);
            color: #facc15;
            border-radius: 4px;
            padding: 2px 4px;
        }

        
        @keyframes ken-burns-effect {
          0% { transform: scale(1.1) translate(0, 0); transform-origin: 50% 50%; }
          25% { transform: scale(1.15) translate(2%, -2%); transform-origin: top left; }
          50% { transform: scale(1.1) translate(-2%, 3%); transform-origin: bottom right; }
          75% { transform: scale(1.2) translate(3%, -1%); transform-origin: top right; }
          100% { transform: scale(1.1) translate(0, 0); transform-origin: 50% 50%; }
        }
        #story-image { animation: ken-burns-effect 30s ease-in-out infinite alternate; }

        @media (max-width: 640px) {
            #game-modal-title { font-size: 1.125rem; }
            #game-modal-subtitle { font-size: 0.75rem; }
            #memory-grid { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 0.4rem; }
            .card-back-word { font-size: 0.7rem; }
            .card-back-translation { font-size: 0.6rem; }
            .letter-slot { width: 32px; height: 40px; font-size: 1.25rem; }
            .letter-choice { width: 38px; height: 38px; font-size: 1rem; }
            #fill-blanks-sentence { font-size: 2.1rem; }
        }
    </style>
</head>
<body class="text-white bg-gray-900">

    <audio id="story-audio"></audio>
    
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-40 hidden"></div>
    <div id="modal-container" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 w-11/12 max-w-lg p-4 sm:p-6 hidden flex-col max-h-[85vh]">
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <h3 id="modal-title" class="text-xl font-bold text-white"></h3>
            <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div id="modal-content" class="flex-grow overflow-y-auto pr-2 text-gray-300"></div>
        <div class="mt-6 text-right flex-shrink-0">
            <button id="modal-ok-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">OK</button>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div id="settings-modal-container" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 w-11/12 max-w-sm p-4 sm:p-6 hidden flex-col">
        <div class="flex items-center justify-between mb-6 flex-shrink-0">
            <h3 class="text-xl font-bold text-white">Configuración</h3>
            <button id="settings-modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div class="flex-grow space-y-6">
            <div class="flex items-center justify-between">
                <label class="text-gray-300 font-semibold">Tamaño de letra</label>
                <div class="flex items-center gap-2 bg-gray-900 rounded-full p-1">
                    <button id="decrease-font-btn" class="w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center text-lg font-bold">-</button>
                    <span id="font-size-display" class="w-16 text-center font-mono text-indigo-300">100%</span>
                    <button id="increase-font-btn" class="w-8 h-8 rounded-full bg-indigo-600 hover:bg-indigo-700 flex items-center justify-center text-lg font-bold">+</button>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <label for="autoplay-toggle" class="text-gray-300 font-semibold">Reproducción Automática</label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
            </div>
            <!-- Aquí se pueden agregar más opciones de configuración en el futuro -->
        </div>
    </div>
    
    <div id="word-modal-container" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-[60] hidden items-center justify-center p-4">
        <div id="word-modal-content" class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-sm flex flex-col text-white max-h-[90vh]">
            <!-- Contenido principal del modal que puede hacer scroll -->
            <div id="word-modal-main-content" class="p-4 sm:p-5 flex-grow overflow-y-auto">
                <!-- Vista por Defecto: Título, Traducción, Imagen -->
                <div id="word-modal-default-view">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 id="word-modal-title" class="text-2xl font-bold text-indigo-400"></h3>
                        <span id="word-modal-pos" class="text-xs font-semibold px-2 py-0.5 bg-gray-600 text-gray-200 rounded-full"></span>
                    </div>
                    <p id="word-modal-translation" class="text-lg text-gray-300 mb-3"></p>
                    <div id="word-modal-breakdown" class="hidden py-3 border-t border-b border-gray-700 mb-3"></div>
                    <div class="p-2 h-48 flex items-center justify-center bg-gray-900 rounded-lg">
                        <img id="word-modal-image" src="" alt="Word image" class="max-w-full max-h-full object-contain rounded-md hidden">
                        <p id="word-modal-image-loader" class="text-gray-400 animate-pulse">Buscando imagen...</p>
                    </div>
                </div>
    
                <!-- Vista del Juego de Deletreo (Aparece aquí cuando se activa) -->
                <div id="word-modal-spelling-view" class="hidden flex flex-col items-center justify-center gap-4 text-center">
                    <div class="w-full mb-4">
                        <div class="p-2 h-40 bg-gray-900 rounded-lg flex items-center justify-center">
                            <img id="word-modal-spelling-image" src="" alt="Word image" class="max-w-full max-h-full object-contain rounded-md hidden">
                        </div>
                        <p id="word-modal-spelling-translation" class="text-lg text-center text-gray-300 mt-2 font-semibold"></p>
                    </div>
                    <p class="text-sm text-gray-400 font-semibold">Completa la palabra:</p>
                    <div id="word-modal-spelling-slots" class="flex flex-wrap justify-center gap-2"></div>
                    <div id="word-modal-spelling-choices" class="spelling-choices max-w-xs w-full flex flex-wrap justify-center items-center gap-2 mt-4"></div>
                    <button id="word-modal-spelling-delete-btn" class="w-24 mt-2 flex items-center justify-center gap-2 py-2 px-4 bg-red-700 hover:bg-red-800 rounded-lg">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        <span>Borrar</span>
                    </button>
                </div>
            </div>
    
            <!-- Botones (Footer) -->
            <div id="word-modal-footer" class="grid grid-cols-2 gap-2 p-2 bg-gray-800/50 flex-shrink-0 border-t border-gray-700">
                 <button id="word-modal-listen-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a1 1 0 011 1v8a1 1 0 11-2 0V5a1 1 0 011-1zM13 4a1 1 0 011 1v8a1 1 0 11-2 0V5a1 1 0 011-1z"></path><path fill-rule="evenodd" d="M2 8a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm15 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zM5 8a1 1 0 011-1h1a1 1 0 110 2H6a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>Escuchar</button>
                 <button id="word-modal-continue-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-green-600 hover:bg-green-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>Continuar</button>
                 <button id="word-modal-learn-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg>Aprender</button>
                 <button id="word-modal-ok-btn" class="w-full text-sm font-semibold py-2.5 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors">OK</button>
            </div>
        </div>
    </div>
        
    <template id="jumbled-sentence-template">
        <div class="h-full flex flex-col text-center gap-6">
            <div class="flex-shrink-0">
                <p class="text-base text-gray-300 mb-1">Ordena las palabras para formar la oración correcta:</p>
                <p id="jumbled-progress" class="font-mono text-indigo-300 text-sm"></p>
            </div>
<div id="jumbled-drop-zone" class="min-h-[100px] w-full max-w-3xl mx-auto bg-gray-900/50 border-2 border-dashed border-gray-600 rounded-lg p-3 flex flex-wrap items-center justify-start gap-2 transition-colors"></div>
            <div class="flex-grow flex items-center justify-center">
                <div id="jumbled-word-bank" class="max-w-3xl mx-auto flex flex-wrap items-center justify-center gap-4"></div>
            </div>
            <div id="jumbled-feedback" class="h-10 flex items-center justify-center"></div>
            <div class="flex-shrink-0 flex items-center justify-center gap-4 mt-auto">
                <button id="jumbled-check-btn" class="px-8 py-3 text-lg bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Comprobar</button>
                <button id="jumbled-next-btn" class="hidden px-8 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>
    <template id="quiz-game-template">
        <div class="h-full max-w-2xl mx-auto flex flex-col justify-between gap-2">
            <div class="flex-shrink-0 space-y-3">
                <div id="quiz-timer-container"><div id="quiz-timer-bar"></div></div>
                <div>
                    <p id="quiz-progress" class="text-center font-mono text-indigo-300 text-sm mb-2"></p>
<h3 id="quiz-question" class="text-3xl md:text-4xl font-bold text-center text-white"></h3>
                    <p id="quiz-question-sub" class="text-center text-gray-400 mt-1"></p>
                </div>
            </div>
             <div id="quiz-options" class="flex-grow flex flex-col justify-center items-center gap-2 sm:gap-3 py-2"></div>
            <div class="flex-shrink-0 h-16 flex flex-col items-center justify-center gap-2">
                <div id="quiz-feedback" class="h-6"></div>
                <button id="quiz-next-btn" class="hidden px-10 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>
    <template id="memory-game-template">
        <div class="h-full flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center mb-4 text-sm font-mono">
                <span>Pares: <span id="memory-pairs-found">0</span>/<span id="memory-total-pairs">0</span></span>
                <span>Fallos: <span id="memory-mismatches">0</span></span>
            </div>
            <div id="memory-loading-overlay" class="absolute inset-0 bg-gray-800/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center">
                <svg class="animate-spin h-10 w-10 text-indigo-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="text-lg font-semibold">Cargando imágenes...</p>
                <p class="text-sm text-gray-400" id="memory-loading-progress">0%</p>
            </div>
            <div id="memory-grid" class="flex-grow"></div>
        </div>
    </template>
    <template id="fill-blanks-template">
        <div class="h-full flex flex-col text-center gap-4">
            <div class="flex-shrink-0">
                <p id="fill-blanks-progress" class="font-mono text-indigo-300 text-sm mb-4"></p>
                <p id="fill-blanks-sentence" class="text-xl md:text-2xl leading-relaxed text-gray-300"></p>
                <p id="fill-blanks-translation" class="hidden mt-2 text-base italic text-gray-400 p-2 bg-black/20 rounded-lg"></p>
            </div>
            <div class="flex-grow flex flex-col items-center justify-center gap-4 py-2">
                <div id="fill-blanks-choices" class="max-w-md w-full flex flex-wrap justify-center items-center gap-2"></div>
                <button id="fill-blanks-delete-btn" class="w-24 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    <span>Borrar</span>
                </button>
            </div>
            <div class="flex-shrink-0 h-20 flex flex-col items-center justify-center gap-2">
                <div id="fill-blanks-feedback" class="h-6"></div>
                <button id="fill-blanks-next-btn" class="hidden px-10 py-3 text-lg bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-all">Siguiente &rarr;</button>
            </div>
        </div>
    </template>

    <div id="app-container" class="w-full h-screen bg-gray-800 md:max-w-3xl md:h-[90vh] md:max-h-[850px] md:rounded-2xl md:shadow-2xl md:border md:border-gray-700 relative overflow-hidden transition-all duration-300">
        <div id="main-menu" class="h-full flex flex-col bg-gray-900">
    <div class="w-full p-4 md:p-6 flex flex-col flex-grow min-h-0">
                <header class="text-center mb-6 relative"> <!-- Añadido relative -->
                    <!-- Botón de Descarga PWA -->
                    <button id="install-app-btn" class="absolute top-0 right-0 bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 text-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span>Descargar App</span>
                    </button>
                    
                    <img src="banner.png" alt="Story Books Banner" class="mx-auto mb-2 w-full max-w-[7rem]">
                    <p class="text-gray-400 mt-1">Select a story to begin</p>
                </header>
<div id="filter-container" class="flex flex-wrap justify-center gap-2 md:gap-3 mb-8">
                    <button data-filter="todos" class="filter-btn active px-4 py-2 text-sm font-semibold bg-gray-800 rounded-full hover:bg-gray-700">Todos</button>
                    <button data-filter="fundamental" class="filter-btn px-4 py-2 text-sm font-semibold bg-gray-800 rounded-full hover:bg-gray-700">Fundamental</button>
                    <button data-filter="básico" class="filter-btn px-4 py-2 text-sm font-semibold bg-gray-800 rounded-full hover:bg-gray-700">Básico</button>
                    <button data-filter="intermedio" class="filter-btn px-4 py-2 text-sm font-semibold bg-gray-800 rounded-full hover:bg-gray-700">Intermedio</button>
                    <button data-filter="avanzado" class="filter-btn px-4 py-2 text-sm font-semibold bg-gray-800 rounded-full hover:bg-gray-700">Avanzado</button>
                </div>
                <main id="story-list" class="flex flex-col gap-6 overflow-y-auto pb-24 flex-grow"></main>
                <p id="loading-stories" class="text-center text-gray-400">Loading stories...</p>
            </div>
            <footer id="main-menu-footer" class="absolute bottom-0 left-0 right-0 bg-gray-900 bg-opacity-70 backdrop-blur-sm border-t border-gray-700 z-10">
                <div class="max-w-xl mx-auto p-2 flex items-center justify-around text-center text-xs text-gray-400">
                    <a href="https://chat.whatsapp.com/FjsQxrL3qnu32P8mdZHY0C" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center gap-1 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Comunidad</span></a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=URL_DE_TU_APP" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center gap-1 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367 2.684z"></path></svg><span>Compartir</span></a>
                    <a href="https://youtu.be/ujZtS_EEVgA" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center gap-1 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Tutorial</span></a>
                    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
                        <input type="hidden" name="cmd" value="_s-xclick" /><input type="hidden" name="hosted_button_id" value="NXEPDCBPD64S2" /><input type="hidden" name="currency_code" value="USD" />
                        <button type="submit" class="flex flex-col items-center gap-1 hover:text-white transition-colors text-xs text-gray-400"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg><span>Donar</span></button>
                    </form>
                </div>
            </footer>
        </div>

        <div id="story-view" class="hidden h-full flex-col">
            <div class="h-1/2 relative overflow-hidden">
                <header class="absolute top-0 left-0 right-0 z-20 p-2 sm:p-4 flex items-center justify-between gap-2 sm:gap-4 bg-gradient-to-b from-black/60 to-transparent">
                    <button id="back-btn" class="flex-shrink-0 p-2 bg-gradient-to-br from-gray-700 to-gray-800 backdrop-blur-sm rounded-full hover:from-gray-600 hover:to-gray-700 transition-colors shadow-lg"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                    <div class="flex items-center gap-2">
                        <button id="activities-btn" class="flex-shrink-0 flex items-center gap-1.5 px-3 py-[0.2rem] text-[0.6rem] font-bold tracking-wider uppercase bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-full hover:opacity-90 transition-opacity shadow-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg><span>Actividades</span></button>
                        <button id="settings-btn" class="flex-shrink-0 p-1.5 bg-gray-700/50 backdrop-blur-sm rounded-full hover:bg-gray-600/70 transition-colors shadow-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                    </div>
                </header>
                <video id="story-video" class="w-full h-full object-cover hidden" autoplay loop muted playsinline></video>
                <img id="story-image" src="" alt="Story image" class="w-full h-full object-cover">
                <div class="absolute bottom-0 left-0 right-0 p-2 sm:p-4 flex flex-col items-start gap-3 bg-gradient-to-t from-black/70 to-transparent">
                    <div id="karaoke-display" class="w-full text-center h-10 flex items-center justify-center"><span id="karaoke-word" class="text-white text-2xl font-semibold px-4 py-1 bg-black/50 rounded-lg transition-opacity duration-150 ease-in-out opacity-0"></span></div>
                    <div class="flex flex-wrap items-center justify-start gap-2">
                        <button id="grammar-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border border-white/20 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg><span>Gramática</span></button>
                        <button id="vocabulary-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border border-white/20 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"></path></svg><span>Vocabulario</span></button>
                        <button id="translation-btn" class="flex items-center gap-1.5 text-[0.6rem] font-bold tracking-wider uppercase bg-black/30 text-white px-3 py-[0.2rem] rounded-full backdrop-blur-md hover:bg-black/50 border border-white/20 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13-4-4-4 4M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Traducción</span></button>
                    </div>
                </div>
            </div>
            <div id="text-container" class="h-1/2 flex-1 bg-gray-800 overflow-y-auto p-4 sm:p-6 pb-32 relative z-10">
                <h2 id="story-title-view" class="text-center text-[0.8rem] font-bold text-indigo-400 uppercase tracking-widest mb-2"></h2>
                <p id="story-text-en" class="leading-relaxed text-gray-300"></p>
            </div>
            <footer class="absolute bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-sm border-t border-white/10 z-30">
                <div class="w-full max-w-xl mx-auto p-3 sm:p-4 flex flex-col items-center justify-center gap-3 relative">
                    <div id="speed-tooltip" class="absolute bottom-full mb-2 bg-gray-900 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none"></div>
                    <div class="w-full relative h-5 bg-black/30 rounded-full overflow-hidden border border-white/20">
                        <div id="progress-bar-fill" class="absolute top-0 left-0 h-full bg-indigo-500 transition-all duration-300 ease-linear"></div>
                        <div id="story-progress-text" class="absolute inset-0 flex items-center justify-center text-[0.6rem] font-bold text-shadow"></div>
                    </div>
                    <div class="w-full flex items-center justify-between">
                        <div class="w-1/4 flex justify-start"><button id="prev-page-btn" class="hover:text-white transition-colors p-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.5L2.5 12L12 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21.5 2.5L12 12L21.5 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                        <div class="flex-1 flex items-center justify-center gap-4">
                            <button id="decrease-speed-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Más lento"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
                            <button id="play-pause-btn" class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-14 h-14 sm:w-16 sm:h-16 rounded-full shadow-lg play-button-shadow transform hover:scale-105 transition-transform flex items-center justify-center" disabled><svg id="play-icon" class="w-7 h-7 sm:w-8 sm:h-8 ml-1" viewBox="0 0 24 24" fill="currentColor"><path d="M6.3 20.7c-.4 0-.8-.1-1.1-.4-.6-.5-.9-1.2-.9-1.9V5.6c0-.7.3-1.4.9-1.9.6-.5 1.4-.6 2.1-.3l12.4 7.2c.7.4 1.1 1.1 1.1 1.9s-.4 1.5-1.1 1.9L7.3 20.4c-.3.2-.7.3-1 .3Z"/></svg><svg id="pause-icon" class="w-7 h-7 sm:w-8 sm:h-8 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M8 4h2v16H8V4zm6 0h2v16h-2V4z"/></svg></button>
                            <button id="increase-speed-btn" class="p-2 bg-black/30 rounded-full hover:bg-black/50 transition-colors" title="Más rápido"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m-6-6h12"></path></svg></button>
                        </div>
                        <div class="w-1/4 flex justify-end"><button id="next-page-btn" class="hover:text-white transition-colors p-1"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.5L21.5 12L12 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2.5 2.5L12 12L2.5 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div>
                    </div>
                </div>
            </footer>
        </div>

        <div id="activities-view" class="hidden h-full flex flex-col bg-gray-900">
            <header class="p-4 flex-shrink-0 bg-gray-800 border-b border-gray-700 flex items-center gap-4 z-10 shadow-md">
                <button id="activities-back-btn" class="p-2 hover:bg-gray-700 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div>
                    <h2 id="activities-title" class="text-xl font-bold text-white">Actividades</h2>
                    <p id="activities-subtitle" class="text-sm text-gray-400"></p>
                </div>
            </header>
            <main id="activities-list" class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-4"></main>
        </div>

        <div id="game-view" class="hidden h-full flex flex-col bg-gray-900">
            <header class="flex items-center justify-between p-3 border-b border-gray-700 flex-shrink-0 bg-gray-800 z-10 shadow-md">
                <div class="flex items-center gap-2">
                     <button id="game-back-btn" class="p-2 hover:bg-gray-700 rounded-full transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div>
                        <h2 id="game-view-title" class="text-lg font-bold text-indigo-400"></h2>
                        <p id="game-view-subtitle" class="text-xs text-gray-400"></p>
                    </div>
                </div>
                <div id="game-score-display" class="text-base font-bold text-white"></div>
            </header>
            <main id="game-area" class="flex-grow p-4 sm:p-6 overflow-y-auto relative"></main>
        </div>
    </div>
    
<script src="games.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- LÓGICA PARA PWA ---
    // 1. Registrar el Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('Service Worker registrado con éxito:', registration);
            }).catch(error => {
                console.log('Fallo en el registro del Service Worker:', error);
            });
        });
    }

    // 2. Lógica para el botón de instalación
    let deferredPrompt;
    const installBtn = document.getElementById('install-app-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Previene que el mini-infobar aparezca en Chrome
        e.preventDefault();
        // Guarda el evento para que pueda ser disparado más tarde.
        deferredPrompt = e;
        // Muestra nuestro botón de instalación personalizado.
        installBtn.style.display = 'flex';
    });

    installBtn.addEventListener('click', async () => {
        // Oculta nuestro botón, ya que el diálogo del navegador aparecerá.
        installBtn.style.display = 'none';
        // Muestra el diálogo de instalación.
        deferredPrompt.prompt();
        // Espera a que el usuario responda.
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`Respuesta del usuario: ${outcome}`);
        // Ya no necesitamos el evento.
        deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => {
        // Si la app se instala, oculta el botón y limpia la referencia.
        installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('App instalada con éxito!');
    });
    // --- FIN LÓGICA PWA ---


    const App = {
        // ... (todo el SoundManager, config, state, elements se mantiene igual)
        SoundManager: {
            sounds: {},
            isMuted: false,
            init() {
                const soundFiles = ['click.mp3', 'congrats.flac', 'ok.mp3', 'select.wav', 'wrong.wav'];
                soundFiles.forEach(file => {
                    const name = file.split('.')[0];
                    this.sounds[name] = new Audio(`sounds/${file}`);
                    this.sounds[name].preload = 'auto';
                });
            },
            play(name) {
                const sound = this.sounds[name];
                if (sound && !this.isMuted) {
                    sound.pause();
                    sound.currentTime = 0;
                    sound.play().catch(e => console.error(`Error playing sound '${name}':`, e));
                }
            }
        },

        config: {
            API_BASE_URL: 'https://narrion.saturninocok.workers.dev',
            PEXELS_WORKER_URL: 'https://px.saturninocok.workers.dev',
            STORAGE_KEY: 'storyProgressData_v2',
            SETTINGS_KEY: 'storyAppSettings_v1', // Nueva clave para la configuración
            PLAYBACK_SPEEDS: [0.75, 1.0, 1.25, 1.5],
        },

        state: {
            allStories: [],
            currentStory: null,
            currentPageIndex: 0,
            marksData: [],
            glossary: new Map(),
            phrasalVerbMap: new Map(),
            currentWordIndex: -1,
            isPlaying: false,
            animationFrameId: null,
            storyWords: [],
            pageWordStartIndices: [],
            learningList: [],
            currentSpeedIndex: 1,
            activeGame: null, 
            fontSizeMultiplier: 1.0,
            learnedWords: {},
            isAutoplayEnabled: false,
        },

        elements: {},
        
        init() {
            this.cacheDomElements();
            this.SoundManager.init();
            this.SettingsManager.init(this); 
            this.SpellingGame.init(this);
            this.bindEventListeners();
            this.fetchStories();
        },

        cacheDomElements() {
            this.elements = {
                mainMenu: document.getElementById('main-menu'),
                storyView: document.getElementById('story-view'),
                activitiesView: document.getElementById('activities-view'),
                gameView: document.getElementById('game-view'),
                storyListContainer: document.getElementById('story-list'),
                loadingStoriesEl: document.getElementById('loading-stories'),
                filterContainer: document.getElementById('filter-container'),
                backBtn: document.getElementById('back-btn'),
                storyProgressTextEl: document.getElementById('story-progress-text'),
                progressBarFillEl: document.getElementById('progress-bar-fill'),
                storyImageEl: document.getElementById('story-image'),
                storyVideoEl: document.getElementById('story-video'),
                storyTextEnEl: document.getElementById('story-text-en'),
                storyAudio: document.getElementById('story-audio'),
                playPauseBtn: document.getElementById('play-pause-btn'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                prevPageBtn: document.getElementById('prev-page-btn'),
                nextPageBtn: document.getElementById('next-page-btn'),
                decreaseSpeedBtn: document.getElementById('decrease-speed-btn'),
                increaseSpeedBtn: document.getElementById('increase-speed-btn'),
                speedTooltip: document.getElementById('speed-tooltip'),
                storyTitleViewEl: document.getElementById('story-title-view'),
                karaokeWordEl: document.getElementById('karaoke-word'),
                grammarBtn: document.getElementById('grammar-btn'),
                vocabularyBtn: document.getElementById('vocabulary-btn'),
                translationBtn: document.getElementById('translation-btn'),
                activitiesBtn: document.getElementById('activities-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                activitiesList: document.getElementById('activities-list'),
                activitiesTitle: document.getElementById('activities-title'),
                activitiesSubtitle: document.getElementById('activities-subtitle'),
                activitiesBackBtn: document.getElementById('activities-back-btn'),
                gameArea: document.getElementById('game-area'),
                gameBackBtn: document.getElementById('game-back-btn'),
                modalOverlay: document.getElementById('modal-overlay'),
                modalContainer: document.getElementById('modal-container'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                modalOkBtn: document.getElementById('modal-ok-btn'),
                settingsModalContainer: document.getElementById('settings-modal-container'),
                settingsModalCloseBtn: document.getElementById('settings-modal-close-btn'),
                increaseFontBtn: document.getElementById('increase-font-btn'),
                decreaseFontBtn: document.getElementById('decrease-font-btn'),
                fontSizeDisplay: document.getElementById('font-size-display'),
                autoplayToggle: document.getElementById('autoplay-toggle'),
                wordModalContainer: document.getElementById('word-modal-container'),
                wordModalDefaultView: document.getElementById('word-modal-default-view'),
                wordModalSpellingView: document.getElementById('word-modal-spelling-view'),
                wordModalTitle: document.getElementById('word-modal-title'),
                wordModalTranslation: document.getElementById('word-modal-translation'),
                wordModalImage: document.getElementById('word-modal-image'),
                wordModalImageLoader: document.getElementById('word-modal-image-loader'),
                wordModalPos: document.getElementById('word-modal-pos'),
            };
        },

        bindEventListeners() {
            this.elements.playPauseBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.state.isPlaying ? this.AudioPlayer.pause() : this.AudioPlayer.play(); });
            this.elements.backBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showScreen('main'); });
            this.elements.activitiesBackBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showScreen('story'); });
            this.elements.gameBackBtn.addEventListener('click', () => {
                this.SoundManager.play('click');
                if (this.state.activeGame && typeof this.state.activeGame.close === 'function') {
                    this.state.activeGame.close();
                } else {
                    this.showScreen('activities');
                }
            });
            
            // Listeners para modales
            const closeGenericModal = () => { this.SoundManager.play('click'); this.Modals.closeGeneric(); };
            const closeSettingsModal = () => { this.SoundManager.play('click'); this.Modals.closeSettings(); };
            this.elements.modalOverlay.addEventListener('click', () => { closeGenericModal(); closeSettingsModal(); });
            this.elements.modalCloseBtn.addEventListener('click', closeGenericModal);
            this.elements.modalOkBtn.addEventListener('click', () => { this.SoundManager.play('ok'); closeGenericModal(); });
            this.elements.settingsModalCloseBtn.addEventListener('click', closeSettingsModal);
            
            // Listeners de botones de la historia
            this.elements.settingsBtn.addEventListener('click', () => { this.SoundManager.play('select'); this.Modals.openSettings(); });
            this.elements.activitiesBtn.addEventListener('click', () => { this.SoundManager.play('select'); this.ActivityManager.showActivitiesView(); });
            this.elements.grammarBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showGrammar(); });
            this.elements.vocabularyBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showVocabulary(); });
            this.elements.translationBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.showTranslation(); });
            
            // Listeners del reproductor
            this.elements.storyAudio.addEventListener('ended', () => this.handlePageEnd());
            this.elements.nextPageBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.changePage(1); });
            this.elements.prevPageBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.changePage(-1); });
            this.elements.decreaseSpeedBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.AudioPlayer.changeSpeed(-1); });
            this.elements.increaseSpeedBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.AudioPlayer.changeSpeed(1); });
            
            // Listeners de configuración
            this.elements.decreaseFontBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.SettingsManager.changeFontSize(-1); });
            this.elements.increaseFontBtn.addEventListener('click', () => { this.SoundManager.play('click'); this.SettingsManager.changeFontSize(1); });
            this.elements.autoplayToggle.addEventListener('change', () => this.SettingsManager.toggleAutoplay());

            // Listener del filtro
            this.elements.filterContainer.addEventListener('click', (e) => {
                if (e.target.matches('.filter-btn')) {
                    this.SoundManager.play('click');
                    this.elements.filterContainer.querySelector('.filter-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    this.renderStories(e.target.dataset.filter);
                }
            });
        },
        
        handlePageEnd() {
            if (this.state.animationFrameId) {
                cancelAnimationFrame(this.state.animationFrameId);
                this.state.animationFrameId = null;
            }

            if (this.state.isAutoplayEnabled) {
                const isLastPage = this.state.currentPageIndex === this.state.currentStory.p.length - 1;
                if (!isLastPage) {
                    this.changePage(1);
                } else {
                    this.AudioPlayer.stop();
                }
            } else {
                this.AudioPlayer.stop();
            }
        },

        showScreen(name) {
            const screens = ['mainMenu', 'storyView', 'activitiesView', 'gameView'];
            screens.forEach(screen => this.elements[screen]?.classList.add('hidden'));
            
            let targetScreen;
            switch(name) {
                case 'main': targetScreen = this.elements.mainMenu; break;
                case 'story': targetScreen = this.elements.storyView; break;
                case 'activities': targetScreen = this.elements.activitiesView; break;
                case 'game': targetScreen = this.elements.gameView; break;
            }
            targetScreen?.classList.remove('hidden');

            if (name === 'main') {
                this.AudioPlayer.stop(true);
                this.state.currentStory = null; 
                this.state.currentSpeedIndex = 1;
                this.renderStories();
            }
        },
        
        async fetchStories() {
            try {
                const response = await fetch(`${this.config.API_BASE_URL}/data`, { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                this.state.allStories = Array.isArray(data.story) ? data.story : [];

                this.elements.loadingStoriesEl.classList.add('hidden');
                this.renderStories();

            } catch (e) {
                this.elements.loadingStoriesEl.textContent = 'Error al cargar las historias.';
                this.elements.loadingStoriesEl.classList.add('text-red-400');
                console.error("Fetch stories failed:", e);
            }
        },

        async fetchAndShowStory(storyId) {
            this.SoundManager.play('select');
            this.showScreen('story');
            
            this.elements.activitiesBtn.disabled = true;
            this.elements.grammarBtn.disabled = true;
            this.elements.vocabularyBtn.disabled = true;
            this.elements.translationBtn.disabled = true;
            this.elements.playPauseBtn.disabled = true;
            this.elements.storyTextEnEl.innerHTML = '<p class="text-center text-gray-400 animate-pulse">Cargando historia...</p>';
            this.elements.storyTitleViewEl.textContent = 'Cargando...';

            try {
                const storySummary = this.state.allStories.find(s => s.id == storyId);
                if (!storySummary) throw new Error("Story not found in list.");
                
                const response = await fetch(`${this.config.API_BASE_URL}/stories/${storyId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const storyDataObject = Array.isArray(data.story) ? data.story[0] : data.story;
                if (!storyDataObject) throw new Error("Invalid story data from API.");

                this.state.currentStory = { ...storySummary, ...storyDataObject };
                
                if (storyDataObject.meta && storyDataObject.meta.assetType) {
                    this.state.currentStory.assetType = storyDataObject.meta.assetType;
                }

                if (this.state.currentStory.g) {
                    this.ProgressManager.setTotalGames(storyId, this.state.currentStory.g.length);
                }
                
                const storyTitle = storyDataObject.meta && storyDataObject.meta.t ? storyDataObject.meta.t : storySummary.title;
                const { t: title } = this.Utils.parseTitle(storyTitle);
                this.state.currentStory.cleanTitle = title;
                
                this.createGlossary(this.state.currentStory.gloss_str);
                this.createPhrasalVerbMap(this.state.currentStory.ph_str);

                try {
                    const marksResponse = await fetch(`./data/${title}/m/marks.json`);
                    this.state.marksData = await marksResponse.json();
                    this.elements.storyAudio.src = `./data/${title}/m/speech.mp3`;
                    this.processAudioMarkers();
                    this.elements.playPauseBtn.disabled = false;
                } catch (e) {
                    this.state.marksData = [];
                    this.elements.playPauseBtn.disabled = true;
                    console.error("Error loading audio data:", e);
                }
                
                this.state.currentPageIndex = 0;
                this.state.currentSpeedIndex = 1;
                this.elements.storyAudio.playbackRate = this.config.PLAYBACK_SPEEDS[this.state.currentSpeedIndex];
                this.AudioPlayer.updateSpeedButtons();
                this.renderCurrentPage();

                this.elements.activitiesBtn.disabled = false;
                this.elements.grammarBtn.disabled = false;
                this.elements.vocabularyBtn.disabled = false;
                this.elements.translationBtn.disabled = false;

            } catch (error) {
                console.error("Failed to fetch story:", error);
                this.showScreen('main');
            }
        },
        
        ProgressManager: {
            _parent: null,
            init(parent) { this._parent = parent; },
            getAllProgress() { try { const data = localStorage.getItem(this._parent.config.STORAGE_KEY); return data ? JSON.parse(data) : {}; } catch (e) { console.error("Error reading progress", e); return {}; } },
            saveAllProgress(data) { try { localStorage.setItem(this._parent.config.STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("Error saving progress", e); } },
            setTotalGames(storyId, total) { const allProgress = this.getAllProgress(); if (!allProgress[storyId]) { allProgress[storyId] = { activities: {} }; } allProgress[storyId].totalGames = total; this.saveAllProgress(allProgress); },
            getProgress(storyId, gameId = null) { const allProgress = this.getAllProgress(); const storyProgress = allProgress[storyId]; if (!storyProgress) return null; return gameId ? (storyProgress.activities ? storyProgress.activities[gameId] : null) : storyProgress; },
            saveProgress(storyId, gameId, progress, errors) {
                const allProgress = this.getAllProgress();
                if (!allProgress[storyId]) { allProgress[storyId] = { activities: {} }; }
                if (!allProgress[storyId].activities) { allProgress[storyId].activities = {}; }
                const oldData = allProgress[storyId].activities[gameId] || { progress: 0, errors: 0 };
                if (progress >= oldData.progress) { allProgress[storyId].activities[gameId] = { progress, errors }; }
                this.checkAndCalculateFinalScore(storyId, allProgress);
                this.saveAllProgress(allProgress);
                if (!this._parent.elements.activitiesView.classList.contains('hidden') && this._parent.state.currentStory.id == storyId) {
                    this._parent.ActivityManager.showActivitiesView();
                }
            },
            checkAndCalculateFinalScore(storyId, allProgress) {
                const storyData = this._parent.state.allStories.find(s => s.id == storyId);
                const storyProgress = allProgress[storyId];
                if (!storyProgress || !storyProgress.activities) return;
                const totalGames = storyProgress.totalGames || (storyData && storyData.g ? storyData.g.length : 0);
                if (totalGames === 0) return;
                const completedActivities = Object.values(storyProgress.activities).filter(a => a.progress === 100);
                if (completedActivities.length === totalGames) {
                    const totalErrors = Object.values(storyProgress.activities).reduce((sum, activity) => sum + (activity.errors || 0), 0);
                    storyProgress.finalPoints = Math.max(0, 100 - (totalErrors * 5));
                } else {
                    delete storyProgress.finalPoints;
                }
            },
            computeStoryOverallProgress(storyId) {
                const storyProgress = this.getProgress(storyId);
                if (!storyProgress || !storyProgress.activities) return 0;
                const totalGamesInStory = storyProgress.totalGames || 0;
                if (totalGamesInStory === 0) return 0;
                const progressSum = Object.values(storyProgress.activities).reduce((sum, activity) => sum + (activity.progress || 0), 0);
                return Math.round(progressSum / totalGamesInStory);
            }
        },

        renderStories(filter = 'todos') {
            const filtered = this.state.allStories.filter(s => filter === 'todos' || s.difficulty === filter);
            if (filtered.length === 0 && this.state.allStories.length > 0) {
                this.elements.storyListContainer.innerHTML = `<p class="text-gray-400 text-center">No hay historias en esta categoría.</p>`;
                return;
            }
            const difficultyColors = { fundamental: 'bg-blue-600', básico: 'bg-green-600', intermedio: 'bg-yellow-600', avanzado: 'bg-red-600', otros: 'bg-purple-600' };
            
            this.elements.storyListContainer.innerHTML = filtered.map(story => {
                const { t: title, s: subtitle } = this.Utils.parseTitle(story.title);
                const placeholderPath = `https://placehold.co/224x224/1f2937/ffffff?text=No+Img`;

                let imagePath;
                if (story.assetType === 'video') {
                    imagePath = `./data/${title}/vd/1.jpg`;
                } else {
                    imagePath = `./data/${title}/img/1.jpg`;
                }

                const storyProgress = this.ProgressManager.getProgress(story.id);
                const overallProgress = this.ProgressManager.computeStoryOverallProgress(story.id);
                let statusBadgeHTML = '';
                if (storyProgress && storyProgress.finalPoints !== undefined) {
                    statusBadgeHTML = `<div class="story-status-badge badge-green">Completado: ${storyProgress.finalPoints}/100 pts</div>`;
                } else if (overallProgress > 0) {
                    statusBadgeHTML = `<div class="story-status-badge badge-yellow">${overallProgress}%</div>`;
                } else {
                    statusBadgeHTML = `<div class="story-status-badge badge-gray">No iniciado</div>`;
                }

                return `<div class="story-card bg-gray-800 rounded-lg overflow-hidden flex cursor-pointer transition-all duration-300 flex-shrink-0" data-story-id="${story.id}">
                            <div class="flex-shrink-0 w-28 relative">
                                <img src="${imagePath}" alt="${title}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='${placeholderPath}';">
                                ${statusBadgeHTML}
                            </div>
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold text-white">${title}</h3>
                                <p class="text-sm text-gray-400 mb-3">${subtitle}</p>
                                <div class="flex items-center gap-x-3 gap-y-1 flex-wrap mt-auto pt-2">
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${difficultyColors[story.difficulty] || 'bg-gray-600'}">${story.difficulty}</span>
                                    <span class="text-xs text-gray-300 bg-gray-700 px-3 py-1 rounded-full">Tema: ${story.theme}</span>
                                </div>
                            </div>
                        </div>`;
            }).join('');
            
            this.elements.storyListContainer.querySelectorAll('.story-card').forEach(card => 
                card.addEventListener('click', () => this.fetchAndShowStory(card.dataset.storyId))
            );
        },
        
       AudioPlayer: {
             _parent: null,
             init(parent) { this._parent = parent; },
             async play() {
                if (this._parent.state.marksData.length === 0 || !this._parent.state.currentStory) return;

                const audioEl = this._parent.elements.storyAudio;
                const currentPageIndex = this._parent.state.currentPageIndex;
                const pageWordStartIndex = this._parent.state.pageWordStartIndices[currentPageIndex];
                
                const isLastPage = currentPageIndex === this._parent.state.currentStory.p.length - 1;
                const pageWordEndIndex = isLastPage 
                    ? this._parent.state.marksData.length - 1 
                    : this._parent.state.pageWordStartIndices[currentPageIndex + 1] - 1;

                const startOfPageTime = this._parent.state.marksData[pageWordStartIndex]?.start;
                const endOfPageTime = this._parent.state.marksData[pageWordEndIndex]?.end;
                
                // If playback is finished for the current page, reset to the beginning of the page
                if (!this._parent.state.isPlaying && endOfPageTime && audioEl.currentTime >= endOfPageTime - 0.1) {
                    audioEl.currentTime = startOfPageTime;
                }

                try {
                    await audioEl.play();
                    this._parent.state.isPlaying = true;
                    this._parent.elements.playIcon.classList.add('hidden');
                    this._parent.elements.pauseIcon.classList.remove('hidden');
                    this._parent.state.animationFrameId = requestAnimationFrame(() => this._parent.updateHighlight());
                } catch (error) {
                    if (error.name !== 'AbortError') console.error("Error al reproducir audio:", error);
                }
             },
             pause() { 
                this._parent.elements.storyAudio.pause(); 
                this._parent.state.isPlaying = false; 
                this._parent.elements.playIcon.classList.remove('hidden'); 
                this._parent.elements.pauseIcon.classList.add('hidden'); 
                if (this._parent.state.animationFrameId) cancelAnimationFrame(this._parent.state.animationFrameId); 
             },
             stop(resetTime = false) { 
                this.pause(); 
                if (resetTime && this._parent.elements.storyAudio.duration) this._parent.elements.storyAudio.currentTime = 0; 
                const activeWord = document.querySelector('.word.active'); 
                if (activeWord) activeWord.classList.remove('active'); 
                this._parent.elements.karaokeWordEl.style.opacity = '0'; 
                this._parent.state.currentWordIndex = -1; 
             },
             playWord(globalWordIndex, endGlobalWordIndex = -1) {
                const startMark = this._parent.state.marksData[globalWordIndex];
                if (!startMark) return;
                const endMark = (endGlobalWordIndex !== -1 && endGlobalWordIndex < this._parent.state.marksData.length) ? this._parent.state.marksData[endGlobalWordIndex] : startMark;
                this.pause();
                setTimeout(() => { 
                    this._parent.elements.storyAudio.currentTime = startMark.start;
                    const playPromise = this._parent.elements.storyAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            if (error.name !== 'AbortError') console.error("Error al reproducir audio de palabra:", error);
                        });
                    }
                    const duration = (endMark.end - startMark.start) * 1000; 
                    setTimeout(() => { if (!this._parent.state.isPlaying) this._parent.elements.storyAudio.pause(); }, duration + 100); 
                }, 50);
            },
            changeSpeed(direction) { 
                const newIndex = this._parent.state.currentSpeedIndex + direction; 
                if (newIndex >= 0 && newIndex < this._parent.config.PLAYBACK_SPEEDS.length) { 
                    this._parent.state.currentSpeedIndex = newIndex; 
                    const newSpeed = this._parent.config.PLAYBACK_SPEEDS[newIndex];
                    this._parent.elements.storyAudio.playbackRate = newSpeed; 
                    this.updateSpeedButtons(); 
                    const message = `Velocidad: ${newSpeed.toFixed(2)}x`;
                    this._parent.Utils.showSpeedTooltip(message);
                } 
            },
            updateSpeedButtons() { 
                this._parent.elements.decreaseSpeedBtn.disabled = this._parent.state.currentSpeedIndex === 0; 
                this._parent.elements.increaseSpeedBtn.disabled = this._parent.state.currentSpeedIndex === this._parent.config.PLAYBACK_SPEEDS.length - 1; 
            },
        },
        
        renderCurrentPage() {
            if (!this.state.currentStory) return;
            this.AudioPlayer.stop();
            this.elements.karaokeWordEl.textContent = '';
            this.elements.karaokeWordEl.style.opacity = '0';
            const pageData = this.state.currentStory.p[this.state.currentPageIndex];
            const enText = pageData.c.split('||')[0].replace(/\[\[|\]\]/g, '');

            if (this.state.currentStory.assetType === 'video') {
                this.elements.storyImageEl.classList.add('hidden');
                this.elements.storyVideoEl.classList.remove('hidden');
                const videoSrc = `./data/${this.state.currentStory.cleanTitle}/vd/${this.state.currentPageIndex + 1}.mp4`;
                if (this.elements.storyVideoEl.src !== videoSrc) this.elements.storyVideoEl.src = videoSrc;
            } else {
                this.elements.storyVideoEl.classList.add('hidden');
                this.elements.storyImageEl.classList.remove('hidden');
                this.elements.storyImageEl.src = `./data/${this.state.currentStory.cleanTitle}/img/${this.state.currentPageIndex + 1}.jpg`;
                this.elements.storyImageEl.onerror = () => this.elements.storyImageEl.src = `https://placehold.co/800x800/1e293b/ffffff?text=No+Image`;
            }

            this.elements.storyTitleViewEl.textContent = this.state.currentStory.cleanTitle;
            this.wrapWordsInSpans(enText.trim(), this.state.currentPageIndex);
            document.getElementById('text-container').scrollTop = 0;
            const totalPages = this.state.currentStory.p.length;
            const progressPercentage = ((this.state.currentPageIndex + 1) / totalPages) * 100;
            this.elements.storyProgressTextEl.textContent = `Página ${this.state.currentPageIndex + 1} de ${totalPages}`;
            this.elements.progressBarFillEl.style.width = `${progressPercentage}%`;
            this.elements.prevPageBtn.disabled = this.state.currentPageIndex === 0;
            this.elements.nextPageBtn.disabled = this.state.currentPageIndex === totalPages - 1;
        },

        changePage(direction) {
            const totalPages = this.state.currentStory.p.length;
            const newIndex = this.state.currentPageIndex + direction;
            if (newIndex >= 0 && newIndex < totalPages) {
                this.state.currentPageIndex = newIndex;
                this.renderCurrentPage();
                const firstWordIndex = this.state.pageWordStartIndices[this.state.currentPageIndex] || 0;
                if (this.state.marksData.length > 0 && this.state.marksData[firstWordIndex]) {
                    this.elements.storyAudio.currentTime = this.state.marksData[firstWordIndex].start;
                    this.AudioPlayer.play();
                }
            }
        },

        createGlossary(glossStr = '') {
            const baseGlossary = new Map([
                ['a', { translation: 'un / una', pos: 'det' }], ['an', { translation: 'un / una', pos: 'det' }],
                ['the', { translation: 'el / la / los / las', pos: 'det' }], ['is', { translation: 'es / está', pos: 'v' }],
                ['are', { translation: 'son / están', pos: 'v' }], ['was', { translation: 'fue / era / estaba', pos: 'v' }],
                ['were', { translation: 'fueron / eran / estaban', pos: 'v' }], ['i', { translation: 'yo', pos: 'pron' }],
                ['you', { translation: 'tú / usted / ustedes', pos: 'pron' }], ['he', { translation: 'él', pos: 'pron' }],
                ['she', { translation: 'ella', pos: 'pron' }], ['it', { translation: 'ello / eso', pos: 'pron' }],
                ['we', { translation: 'nosotros', pos: 'pron' }], ['they', { translation: 'ellos / ellas', pos: 'pron' }],
                ['in', { translation: 'en / dentro de', pos: 'prep' }], ['on', { translation: 'en / sobre', pos: 'prep' }],
                ['at', { translation: 'en / a', pos: 'prep' }], ['to', { translation: 'a / para', pos: 'prep' }],
                ['of', { translation: 'de', pos: 'prep' }], ['for', { translation: 'para / por', pos: 'prep' }],
                ['and', { translation: 'y', pos: 'conj' }], ['but', { translation: 'pero', pos: 'conj' }],
                ['or', { translation: 'o', pos: 'conj' }], ['not', { translation: 'no', pos: 'adv' }],
                ['with', { translation: 'con', pos: 'prep' }], ['from', { translation: 'de / desde', pos: 'prep' }]
            ]);
            const storyGlossary = new Map();
            if (glossStr) {
                glossStr.split('|').forEach(p => {
                    const [en, es, pos] = p.split(':');
                    if (en && es) storyGlossary.set(en.trim().toLowerCase(), { translation: es.trim(), pos: pos ? pos.trim() : '' });
                });
            }
            this.state.glossary = new Map([...baseGlossary, ...storyGlossary]);
        },

        createPhrasalVerbMap(phrasalStr = '') {
            this.state.phrasalVerbMap.clear();
            if (!phrasalStr) return;
            phrasalStr.split('|').forEach(p => {
                const parts = p.split(':');
                if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                    this.state.phrasalVerbMap.set(parts[0].trim().toLowerCase(), { translation: parts[1].trim() });
                }
            });
        },
        processAudioMarkers() {
            if (!this.state.currentStory || !this.state.marksData || this.state.marksData.length === 0) {
                this.state.storyWords = [];
                this.state.pageWordStartIndices = [];
                return;
            }
            const allTextTokens = [];
            this.state.currentStory.p.forEach(page => {
                const cleanText = page.c.split('||')[0].replace(/\[\[|\]\]/g, '');
                const pageTokens = cleanText.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(part => part.trim() !== '' && /[\p{L}\p{N}']+/u.test(part));
                allTextTokens.push(...pageTokens);
            });
            const finalAlignedMarks = [];
            let markIndex = 0; 
            const rawMarks = this.state.marksData;
            const cleanForCompare = (str) => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f'’]/g, "");
            for (const textToken of allTextTokens) {
                if (markIndex >= rawMarks.length) {
                    console.warn("Se acabaron los marcadores de audio, pero aún hay texto.", { textToken });
                    break;
                }
                const firstMarkInGroup = rawMarks[markIndex];
                let lastMarkInGroup = firstMarkInGroup;
                let builtWordFromMarks = firstMarkInGroup.word;
                let marksConsumed = 1;
                const cleanTextToken = cleanForCompare(textToken);
                while (true) {
                    const nextMarkIndex = markIndex + marksConsumed;
                    if (nextMarkIndex >= rawMarks.length) break; 
                    const potentialNextWord = builtWordFromMarks + rawMarks[nextMarkIndex].word;
                    const cleanPotential = cleanForCompare(potentialNextWord);
                    if (!cleanTextToken.startsWith(cleanPotential)) break; 
                    builtWordFromMarks = potentialNextWord;
                    lastMarkInGroup = rawMarks[nextMarkIndex];
                    marksConsumed++;
                    if (cleanPotential === cleanTextToken) break;
                }
                finalAlignedMarks.push({
                    word: textToken, 
                    start: firstMarkInGroup.start, 
                    end: lastMarkInGroup.end,      
                });
                markIndex += marksConsumed;
            }
            if (markIndex < rawMarks.length) console.warn("Sobraron marcadores de audio después de procesar todo el texto.");
            this.state.marksData = finalAlignedMarks;
            this.state.storyWords = this.state.marksData.map(m => m.word);
            this.state.pageWordStartIndices = [];
            let globalWordCount = 0;
            this.state.currentStory.p.forEach(page => {
                this.state.pageWordStartIndices.push(globalWordCount);
                const cleanText = page.c.split('||')[0].replace(/\[\[|\]\]/g, '');
                const pageTokens = cleanText.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(part => part.trim() !== '' && /[\p{L}\p{N}']+/u.test(part));
                globalWordCount += pageTokens.length;
            });
        },
        wrapWordsInSpans(text, pageIndex) {
            this.elements.storyTextEnEl.innerHTML = '';
            const sortedPVs = Array.from(this.state.phrasalVerbMap.keys()).sort((a, b) => b.split(' ').length - a.split(' ').length);
            const tokens = text.split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(Boolean);
            const isTokenConsumed = new Array(tokens.length).fill(false);
            let localWordCounter = 0;
            for (let i = 0; i < tokens.length; i++) {
                if (isTokenConsumed[i]) continue;
                let matchFound = false;
                if (/[\p{L}\p{N}']+/u.test(tokens[i])) {
                    for (const pv of sortedPVs) {
                        const pvWords = pv.split(' '); let tempTokenIndex = i; let tempPvWordIndex = 0; const matchedTokensIndices = [];
                        while (tempTokenIndex < tokens.length && tempPvWordIndex < pvWords.length) {
                            if (isTokenConsumed[tempTokenIndex]) break;
                            if (/[\p{L}\p{N}']+/u.test(tokens[tempTokenIndex])) { if (tokens[tempTokenIndex].toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '') === pvWords[tempPvWordIndex]) { matchedTokensIndices.push(tempTokenIndex); tempPvWordIndex++; } else break; }
                            tempTokenIndex++;
                        }
                        if (tempPvWordIndex === pvWords.length) {
                            matchFound = true; const span = document.createElement('span');
                            const firstTokenIndex = matchedTokensIndices[0]; const lastTokenIndex = matchedTokensIndices[matchedTokensIndices.length - 1];
                            span.textContent = tokens.slice(firstTokenIndex, lastTokenIndex + 1).join('');
                            span.className = 'word phrasal-verb'; span.dataset.text = pv;
                            const startGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter;
                            localWordCounter += pvWords.length;
                            const endGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter - 1;
                            span.dataset.startGlobalIndex = startGlobalIndex; span.dataset.endGlobalIndex = endGlobalIndex;
                            span.addEventListener('click', (e) => this.handleWordClick(e));
                            span.addEventListener('mouseenter', (event) => { const phrasalData = this.state.phrasalVerbMap.get(pv.toLowerCase()); if (phrasalData && phrasalData.translation) this.Utils.showDynamicTooltip(event.target, phrasalData.translation); });
                            this.elements.storyTextEnEl.appendChild(span);
                            for (let j = firstTokenIndex; j <= lastTokenIndex; j++) isTokenConsumed[j] = true;
                            i = lastTokenIndex; break;
                        }
                    }
                }
                if (!matchFound) {
                    const part = tokens[i]; isTokenConsumed[i] = true;
                    if (/[\p{L}\p{N}']+/u.test(part)) {
                        const span = document.createElement('span'); span.textContent = part; span.className = 'word';
                        const startGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter;
                        span.dataset.startGlobalIndex = startGlobalIndex; localWordCounter++;
                        const endGlobalIndex = (this.state.pageWordStartIndices[pageIndex] || 0) + localWordCounter - 1;
                        span.dataset.endGlobalIndex = endGlobalIndex;
                        const cleanWord = part.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '');
                        const learnedWordsForStory = this.state.learnedWords[this.state.currentStory?.id] || [];
                        if (learnedWordsForStory.includes(cleanWord)) {
                            span.classList.add('learned-word');
                        }
                        span.addEventListener('click', (e) => this.handleWordClick(e));
                        span.addEventListener('mouseenter', (event) => { const glossData = this.state.glossary.get(cleanWord); if (glossData && glossData.translation) this.Utils.showDynamicTooltip(event.target, glossData.translation); });
                        this.elements.storyTextEnEl.appendChild(span);
                    } else this.elements.storyTextEnEl.appendChild(document.createTextNode(part));
                }
            }
        },

        handleWordClick(event) {
            const wordEl = event.target.closest('.word'); if (!wordEl) return; 
            this.AudioPlayer.pause();
            const startGlobalIndex = parseInt(wordEl.dataset.startGlobalIndex, 10);
            const endGlobalIndex = parseInt(wordEl.dataset.endGlobalIndex, 10) || startGlobalIndex;
            
            this.AudioPlayer.playWord(startGlobalIndex, endGlobalIndex); 

            if (wordEl.classList.contains('phrasal-verb')) {
                const phrasalText = wordEl.dataset.text;
                const phrasalData = this.state.phrasalVerbMap.get(phrasalText.toLowerCase());
                const breakdown = phrasalText.split(' ').map(word => { const cleanWord = word.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, ''); const glossData = this.state.glossary.get(cleanWord); return { word: word, translation: glossData ? glossData.translation : '...' }; });
                this.Modals.openWord(phrasalText, phrasalData.translation, 'ph. v.', startGlobalIndex, endGlobalIndex, breakdown, wordEl);
            } else {
                const wordText = wordEl.textContent;
                const cleanWord = wordText.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '');
                const glossData = this.state.glossary.get(cleanWord);
                this.Modals.openWord(wordText, glossData ? glossData.translation : 'Traducción no encontrada', glossData ? glossData.pos : '', startGlobalIndex, endGlobalIndex, null, wordEl);
            }
        },

        updateHighlight() {
            if (!this.state.isPlaying) return;
            const currentTime = this.elements.storyAudio.currentTime;
            const newWordIndex = this.state.marksData.findIndex(mark => currentTime >= mark.start && currentTime < mark.end);
            if (newWordIndex !== -1 && this.state.storyWords[newWordIndex]) { const currentWordText = this.state.storyWords[newWordIndex]; if (this.elements.karaokeWordEl.textContent !== currentWordText) { this.elements.karaokeWordEl.textContent = currentWordText; this.elements.karaokeWordEl.style.opacity = '1'; } } else { this.elements.karaokeWordEl.style.opacity = '0'; }
            if (newWordIndex !== -1 && newWordIndex !== this.state.currentWordIndex) {
                document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
                const isOnCurrentPage = newWordIndex >= this.state.pageWordStartIndices[this.state.currentPageIndex] && (this.state.currentPageIndex === this.state.currentStory.p.length - 1 || newWordIndex < this.state.pageWordStartIndices[this.state.currentPageIndex + 1]);
                if (isOnCurrentPage) {
                    let newWordEl = null;
                    for (const wordSpan of this.elements.storyTextEnEl.querySelectorAll('.word')) { const start = parseInt(wordSpan.dataset.startGlobalIndex, 10); const end = parseInt(wordSpan.dataset.endGlobalIndex, 10) || start; if (newWordIndex >= start && newWordIndex <= end) { newWordEl = wordSpan; break; } }
                    if (newWordEl) {
                        newWordEl.classList.add('active');
                        newWordEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => { if (!this.state.isPlaying || !newWordEl.classList.contains('active')) return; if (newWordEl.classList.contains('phrasal-verb')) { const phrasalData = this.state.phrasalVerbMap.get(newWordEl.dataset.text.toLowerCase()); if (phrasalData?.translation) this.Utils.showDynamicTooltip(newWordEl, phrasalData.translation); } else { const cleanWord = this.state.storyWords[newWordIndex].toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, ''); const glossData = this.state.glossary.get(cleanWord); if (glossData?.translation) this.Utils.showDynamicTooltip(newWordEl, glossData.translation); } }, 250);
                    }
                }
                this.state.currentWordIndex = newWordIndex;
            }
            const lastWordOfPageGlobalIndex = (this.state.pageWordStartIndices[this.state.currentPageIndex + 1] || this.state.marksData.length) - 1;
            if (lastWordOfPageGlobalIndex >= 0 && currentTime >= (this.state.marksData[lastWordOfPageGlobalIndex]?.end || 0)) { 
                this.handlePageEnd();
            } else { 
                this.state.animationFrameId = requestAnimationFrame(() => this.updateHighlight()); 
            }
        },
        
        showGrammar() { if (!this.state.currentStory) return; const pageData = this.state.currentStory.p[this.state.currentPageIndex]; const grammarHTML = pageData.grammar || '<p>No hay notas de gramática para esta página.</p>'; this.Modals.openGeneric('Notas de Gramática', grammarHTML); },
        
        showVocabulary() {
            if (!this.state.currentStory) return;
            const pageData = this.state.currentStory.p[this.state.currentPageIndex];
            if (!pageData.voca) { this.Modals.openGeneric('Vocabulario', '<p>No hay vocabulario para esta página.</p>'); return; }
            const vocabList = pageData.voca.split('|').map(item => { const [en, es] = item.split(':'); return { en: en.trim(), es: es.trim() }; });
            
            let imageSrc = '';
            if (this.state.currentStory.assetType !== 'video') {
                imageSrc = this.elements.storyImageEl.src;
            }

            let contentHTML = imageSrc ? `<img src="${imageSrc}" alt="Story thumbnail" class="w-full h-32 object-cover rounded-lg mb-4">` : '';
            contentHTML += `<div id="vocab-list-container" class="space-y-2 max-h-64 overflow-y-auto pr-2">`;
            vocabList.forEach(item => { 
                contentHTML += `<div class="flex justify-between items-center bg-gray-700 p-2 rounded-md text-sm cursor-pointer hover:bg-gray-600 transition-colors vocab-item" data-word="${item.en}">
                                    <span class="font-semibold text-white pointer-events-none">${item.en}</span>
                                    <span class="text-gray-400 pointer-events-none">${item.es}</span>
                                </div>`; 
            });
            contentHTML += '</div>';
            this.Modals.openGeneric('Vocabulario del Párrafo', contentHTML);
        },

        showTranslation() {
            if (!this.state.currentStory) return;
            const pageData = this.state.currentStory.p[this.state.currentPageIndex];
            const [enText, esText] = pageData.c.split('||');
            if (!esText) { this.Modals.openGeneric('Traducción', '<p>La traducción para esta página no está disponible.</p>'); return; }
            let finalHTML = `<div class="mb-4"><h4 class="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-2">Traducción Completa</h4><p class="text-base italic text-gray-400 p-3 bg-black/20 rounded-lg max-h-48 overflow-y-auto pr-2">${esText.trim()}</p></div>`;
            finalHTML += '<h4 class="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-2">Palabra por Palabra</h4><div class="flex flex-wrap gap-2 max-h-60 overflow-y-auto pr-2">';
            const words = enText.replace(/\[\[|\]\]/g, '').split(/(\s+|(?<!\d)\.(?!\d)|[,;!?:“”"])/).filter(part => part.trim() !== '');
            words.forEach(word => { const cleanWord = word.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, ''); const glossData = this.state.glossary.get(cleanWord); if (glossData) { finalHTML += `<div class="bg-gray-700 rounded-md py-1 px-3 text-center shadow"><div class="font-semibold text-white text-sm">${word}</div><div class="text-indigo-300 italic -mt-1" style="font-size: 0.7rem; line-height: 0.9rem;">${glossData.translation}</div></div>`; } });
            finalHTML += '</div>';
            this.Modals.openGeneric('Traducción del Párrafo', finalHTML);
        },
        
        Utils: {
            parseTitle: (s) => { const match = s.match(/^(.*?)<(.*?)>$/); return match ? {t: match[1].trim(), s: match[2].trim()} : {t: s.trim(), s: ''}; },
            getFullPartOfSpeech: (shortPos) => ({ 'n': 'Sustantivo', 'v': 'Verbo', 'adj': 'Adjetivo', 'adv': 'Adverbio', 'prep': 'Preposición', 'conj': 'Conjunción', 'det': 'Determinante', 'pron': 'Pronombre', 'int': 'Interjección', 'ph. v.': 'Verbo Frasal' }[shortPos.toLowerCase()] || shortPos.toUpperCase()),
            showDynamicTooltip(targetElement, text) {
                let existingTooltip = document.querySelector('.dynamic-tooltip');
                if(existingTooltip) existingTooltip.remove();
                const tooltip = document.createElement('div'); tooltip.className = 'dynamic-tooltip'; tooltip.textContent = text; document.body.appendChild(tooltip);
                const rect = targetElement.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 + (window.scrollX || 0)}px`;
                tooltip.style.top = `${rect.top + (window.scrollY || 0)}px`;
                requestAnimationFrame(() => tooltip.classList.add('visible'));
                const removeTooltip = () => { tooltip.classList.remove('visible'); setTimeout(() => tooltip.parentNode?.removeChild(tooltip), 300); };
                targetElement.addEventListener('mouseleave', removeTooltip, { once: true });
                setTimeout(removeTooltip, 2000);
            },
            speedTooltipTimeout: null,
            showSpeedTooltip(message) {
                const tooltip = App.elements.speedTooltip; 
                if (!tooltip) return;
                if (this.speedTooltipTimeout) clearTimeout(this.speedTooltipTimeout);
                tooltip.textContent = message;
                tooltip.classList.remove('opacity-0');
                this.speedTooltipTimeout = setTimeout(() => {
                    tooltip.classList.add('opacity-0');
                }, 1500);
            },
        },

        Modals: {
            _parent: null,
            _vocabClickHandler: null,
            init(parent) { this._parent = parent; },
            openGeneric(title, contentHTML) { 
                this._parent.AudioPlayer.pause(); 
                this._parent.elements.modalTitle.textContent = title; 
                this._parent.elements.modalContent.innerHTML = contentHTML; 

                if (title === 'Vocabulario del Párrafo') {
                    const vocabContainer = this._parent.elements.modalContent.querySelector('#vocab-list-container');
                    if (vocabContainer) {
                        this._vocabClickHandler = this._handleVocabItemClick.bind(this);
                        vocabContainer.addEventListener('click', this._vocabClickHandler);
                    }
                }

                this._parent.elements.modalOverlay.classList.remove('hidden'); 
                this._parent.elements.modalContainer.classList.remove('hidden');
                this._parent.elements.modalContainer.classList.add('flex');
            },
            closeGeneric() { 
                this._parent.elements.modalOverlay.classList.add('hidden'); 
                this._parent.elements.modalContainer.classList.add('hidden');
                this._parent.elements.modalContainer.classList.remove('flex');
                
                if (this._vocabClickHandler) {
                    const vocabContainer = this._parent.elements.modalContent.querySelector('#vocab-list-container');
                    if (vocabContainer) {
                        vocabContainer.removeEventListener('click', this._vocabClickHandler);
                    }
                    this._vocabClickHandler = null;
                }
            },
            _handleVocabItemClick(e) {
                const vocabItem = e.target.closest('.vocab-item');
                if (!vocabItem) return;

                this._parent.SoundManager.play('click');
                const wordToFind = vocabItem.dataset.word.toLowerCase();
                const wordSpans = this._parent.elements.storyTextEnEl.querySelectorAll('.word');
                
                let targetSpan = null;
                for (const span of wordSpans) {
                    const spanText = span.textContent.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '');
                    if (spanText === wordToFind) {
                        targetSpan = span;
                        break;
                    }
                }

                if (targetSpan) {
                    this.closeGeneric(); 
                    setTimeout(() => {
                        this._parent.handleWordClick({ target: targetSpan });
                    }, 150);
                } else {
                    console.warn(`Word span for "${wordToFind}" not found on the current page.`);
                    this._parent.SoundManager.play('wrong');
                    vocabItem.classList.add('shake');
                    setTimeout(() => vocabItem.classList.remove('shake'), 800);
                }
            },
            openSettings() {
                this._parent.AudioPlayer.pause();
                this._parent.elements.modalOverlay.classList.remove('hidden');
                this._parent.elements.settingsModalContainer.classList.remove('hidden');
                this._parent.elements.settingsModalContainer.classList.add('flex');
            },
            closeSettings() {
                this._parent.elements.modalOverlay.classList.add('hidden');
                this._parent.elements.settingsModalContainer.classList.add('hidden');
                this._parent.elements.settingsModalContainer.classList.remove('flex');
            },
            async openWord(word, translation, pos, startGlobalIndex, endGlobalIndex, breakdown, wordEl) {
                this._parent.elements.wordModalTitle.textContent = word;
                this._parent.elements.wordModalTranslation.textContent = translation;
                this._parent.elements.wordModalContainer.classList.add('flex');
                this._parent.elements.wordModalContainer.classList.remove('hidden');
                if (pos) { this._parent.elements.wordModalPos.textContent = this._parent.Utils.getFullPartOfSpeech(pos); this._parent.elements.wordModalPos.classList.remove('hidden'); }
                else { this._parent.elements.wordModalPos.classList.add('hidden'); }
                const breakdownContainer = document.getElementById('word-modal-breakdown');
                if (breakdown && breakdown.length > 0) { breakdownContainer.classList.remove('hidden'); breakdownContainer.innerHTML = '<div class="space-y-1.5">' + breakdown.map(item => `<div class="flex justify-between items-baseline text-sm"><span class="font-semibold text-gray-200">${item.word}</span><span class="text-indigo-300 italic">${item.translation}</span></div>`).join('') + '</div>'; } else { breakdownContainer.classList.add('hidden'); breakdownContainer.innerHTML = ''; }
                this._parent.elements.wordModalImage.classList.add('hidden'); this._parent.elements.wordModalImage.src = '';
                this._parent.elements.wordModalImageLoader.classList.remove('hidden'); this._parent.elements.wordModalImageLoader.textContent = 'Buscando imagen...';
                
                const cleanAndGetBtn = (id) => { const oldBtn = document.getElementById(id); const newBtn = oldBtn.cloneNode(true); oldBtn.parentNode.replaceChild(newBtn, oldBtn); return newBtn; };
                cleanAndGetBtn('word-modal-ok-btn').addEventListener('click', () => { this._parent.SoundManager.play('ok'); this.closeWord(); });
                cleanAndGetBtn('word-modal-learn-btn').addEventListener('click', () => { 
                    this._parent.SoundManager.play('click');
                    this._parent.SpellingGame.start(word, wordEl, startGlobalIndex, endGlobalIndex);
                });
                cleanAndGetBtn('word-modal-continue-btn').addEventListener('click', () => { this._parent.SoundManager.play('ok'); this.closeWord(); if (this._parent.state.marksData[startGlobalIndex]) { this._parent.elements.storyAudio.currentTime = this._parent.state.marksData[startGlobalIndex].start; this._parent.AudioPlayer.play(); } });
                cleanAndGetBtn('word-modal-listen-btn').addEventListener('click', () => { this._parent.SoundManager.play('click'); this._parent.AudioPlayer.playWord(startGlobalIndex, endGlobalIndex); });

                const imageUrl = await this._parent.fetchPexelsImage(word);
                if (imageUrl) { this._parent.elements.wordModalImage.src = imageUrl; this._parent.elements.wordModalImage.onload = () => { this._parent.elements.wordModalImage.classList.remove('hidden'); this._parent.elements.wordModalImageLoader.classList.add('hidden'); }; }
                else { this._parent.elements.wordModalImageLoader.textContent = 'Imagen no encontrada.'; }
            },
            closeWord() { 
                this._parent.elements.wordModalContainer.classList.add('hidden');
                this._parent.SpellingGame.cleanup();
            },
        },
        
        SpellingGame: {
            _parent: null,
            init(parent) { this._parent = parent; },
            currentTargetWord: '',
            targetWordEl: null,
            startGlobalIndex: -1,
            endGlobalIndex: -1,
            userInput: [],
            hintIndices: [],

            start(word, wordEl, startGlobalIndex, endGlobalIndex) {
                this._parent.elements.wordModalDefaultView.classList.add('hidden');
                
                // Populate the spelling view with image and translation from the default view
                const mainImageEl = this._parent.elements.wordModalImage;
                const mainTranslationEl = this._parent.elements.wordModalTranslation;
                
                const spellingImageEl = document.getElementById('word-modal-spelling-image');
                const spellingTranslationEl = document.getElementById('word-modal-spelling-translation');

                if (mainImageEl.src && !mainImageEl.classList.contains('hidden')) {
                    spellingImageEl.src = mainImageEl.src;
                    spellingImageEl.classList.remove('hidden');
                } else {
                    spellingImageEl.classList.add('hidden');
                    spellingImageEl.src = '';
                }
                spellingTranslationEl.textContent = mainTranslationEl.textContent;

                this._parent.elements.wordModalSpellingView.classList.remove('hidden');
                
                this.currentTargetWord = word.replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '');
                this.targetWordEl = wordEl;
                this.startGlobalIndex = startGlobalIndex;
                this.endGlobalIndex = endGlobalIndex;

                // Lógica para las pistas (letras pre-rellenadas)
                let hintIndices = new Set();
                if (this.currentTargetWord.length > 3) { // Solo dar pistas para palabras más largas
                    while (hintIndices.size < 2) {
                        hintIndices.add(Math.floor(Math.random() * this.currentTargetWord.length));
                    }
                }
                this.hintIndices = Array.from(hintIndices);

                // Inicializar la entrada del usuario con las pistas
                this.userInput = new Array(this.currentTargetWord.length).fill(null);
                this.hintIndices.forEach(index => {
                    this.userInput[index] = this.currentTargetWord[index].toUpperCase();
                });
                
                this.createSlots();
                this.createChoices();
                this.bindGameListeners();
            },

            createSlots() {
                const slotsContainer = document.getElementById('word-modal-spelling-slots');
                slotsContainer.innerHTML = '';
                slotsContainer.classList.remove('correct', 'shake');
                for (let i = 0; i < this.currentTargetWord.length; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'spelling-slot';
                    if (this.hintIndices.includes(i)) {
                        slot.textContent = this.currentTargetWord[i].toUpperCase();
                        slot.classList.add('text-indigo-400', 'border-indigo-500'); // Estilo para pistas
                    }
                    slotsContainer.appendChild(slot);
                }
            },

            createChoices() {
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                choicesContainer.innerHTML = '';
                const wordLetters = this.currentTargetWord.toLowerCase().split('');

                // Crear una copia de las letras para poder modificarlas
                let lettersForChoices = [...wordLetters];
                
                // Quitar las letras de las pistas del pool de opciones
                this.hintIndices.forEach(index => {
                    const hintLetter = this.currentTargetWord[index].toLowerCase();
                    const indexToRemove = lettersForChoices.indexOf(hintLetter);
                    if (indexToRemove > -1) {
                        lettersForChoices.splice(indexToRemove, 1);
                    }
                });

                const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                const distractors = [];
                // Añadir letras distractoras
                while (distractors.length < 4 && distractors.length < 12 - lettersForChoices.length) {
                    const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)];
                    if (!wordLetters.includes(randomLetter) && !distractors.includes(randomLetter)) {
                        distractors.push(randomLetter);
                    }
                }
                const choices = [...lettersForChoices, ...distractors];
                // Barajar las opciones
                for (let i = choices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [choices[i], choices[j]] = [choices[j], choices[i]];
                }

                choices.forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter.toUpperCase();
                    choicesContainer.appendChild(button);
                });
            },
            
            bindGameListeners() {
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                choicesContainer.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
                        this.handleLetterChoice(e.target);
                    }
                };
                const deleteBtn = document.getElementById('word-modal-spelling-delete-btn');
                const newDeleteBtn = deleteBtn.cloneNode(true);
                deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
                newDeleteBtn.onclick = () => this.handleDelete();
            },

            handleLetterChoice(button) {
                // Contar cuántas letras ha introducido el usuario (excluyendo pistas)
                const userFilledSlots = this.userInput.filter(l => l !== null).length;

                if (userFilledSlots < this.currentTargetWord.length) {
                    let nextEmptyIndex = this.userInput.findIndex(slot => slot === null);
                    if (nextEmptyIndex !== -1) {
                        this.userInput[nextEmptyIndex] = button.textContent;
                        button.disabled = true;
                        this.updateSlots();
                        if (this.userInput.filter(l => l).length === this.currentTargetWord.length) {
                            this.checkWord();
                        }
                    }
                }
            },

            handleDelete() {
                let lastFilledIndex = -1;
                // Encontrar el último índice que fue llenado por el usuario (no una pista)
                for (let i = this.userInput.length - 1; i >= 0; i--) {
                    if (this.userInput[i] !== null && !this.hintIndices.includes(i)) {
                        lastFilledIndex = i;
                        break;
                    }
                }

                if (lastFilledIndex !== -1) {
                    const letterToRemove = this.userInput[lastFilledIndex];
                    this.userInput[lastFilledIndex] = null;
                    
                    const choicesContainer = document.getElementById('word-modal-spelling-choices');
                    const buttonToEnable = Array.from(choicesContainer.children).find(btn => btn.textContent === letterToRemove && btn.disabled);
                    if (buttonToEnable) buttonToEnable.disabled = false;
                    
                    this.updateSlots();
                }
            },

            updateSlots() {
                const slots = document.getElementById('word-modal-spelling-slots').children;
                for (let i = 0; i < slots.length; i++) {
                    // Solo actualizar los slots que no son pistas
                    if (!this.hintIndices.includes(i)) {
                        slots[i].textContent = this.userInput[i] || '';
                    }
                }
            },

            checkWord() {
                const isCorrect = this.userInput.join('').toLowerCase() === this.currentTargetWord.toLowerCase();
                const slotsContainer = document.getElementById('word-modal-spelling-slots');
                
                if (isCorrect) {
                    this._parent.SoundManager.play('congrats');
                    slotsContainer.classList.add('correct');
                    this._parent.SettingsManager.addLearnedWord(this._parent.state.currentStory.id, this.currentTargetWord);
                    this.targetWordEl.classList.add('learned-word');
                    setTimeout(() => this.highlightAndSpeak(), 500);
                    setTimeout(() => this._parent.Modals.closeWord(), 1800);
                } else {
                    this._parent.SoundManager.play('wrong');
                    slotsContainer.classList.add('shake');
                    setTimeout(() => {
                        slotsContainer.classList.remove('shake');
                        this.resetGame();
                    }, 800);
                }
            },
            
            highlightAndSpeak() {
                this.targetWordEl.style.transition = 'background-color 0.2s, transform 0.2s';
                this.targetWordEl.style.backgroundColor = 'rgba(79, 70, 229, 0.5)';
                this.targetWordEl.style.transform = 'scale(1.1)';
                this._parent.AudioPlayer.playWord(this.startGlobalIndex, this.endGlobalIndex);
                setTimeout(() => {
                    this.targetWordEl.style.backgroundColor = '';
                    this.targetWordEl.style.transform = '';
                }, 800);
            },

            resetGame() {
                // Solo limpiar las letras que el usuario introdujo
                this.userInput.forEach((letter, index) => {
                    if (!this.hintIndices.includes(index)) {
                        this.userInput[index] = null;
                    }
                });

                this.updateSlots();
                const choicesContainer = document.getElementById('word-modal-spelling-choices');
                Array.from(choicesContainer.children).forEach(btn => btn.disabled = false);
            },

            cleanup() {
                this._parent.elements.wordModalDefaultView.classList.remove('hidden');
                this._parent.elements.wordModalSpellingView.classList.add('hidden');

                // Clean up game elements
                document.getElementById('word-modal-spelling-slots').innerHTML = '';
                document.getElementById('word-modal-spelling-choices').innerHTML = '';
                document.getElementById('word-modal-spelling-image').src = '';
                document.getElementById('word-modal-spelling-image').classList.add('hidden');
                document.getElementById('word-modal-spelling-translation').textContent = '';

                // Reset state
                this.currentTargetWord = '';
                this.targetWordEl = null;
                this.startGlobalIndex = -1;
                this.endGlobalIndex = -1;
                this.userInput = [];
                this.hintIndices = [];
            }
        },

        SettingsManager: {
            _parent: null,
            init(parent) {
                this._parent = parent;
                this.loadSettings();
            },
            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem(this._parent.config.SETTINGS_KEY));
                    if (settings) {
                        this._parent.state.fontSizeMultiplier = settings.fontSizeMultiplier || 1.0;
                        this._parent.state.learnedWords = settings.learnedWords || {};
                        this._parent.state.isAutoplayEnabled = settings.isAutoplayEnabled || false;
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                    this._parent.state.fontSizeMultiplier = 1.0;
                    this._parent.state.learnedWords = {};
                    this._parent.state.isAutoplayEnabled = false;
                }
                this.applyFontSize();
                this.applyAutoplaySetting();
            },
            saveSettings() {
                try {
                    const settings = {
                        fontSizeMultiplier: this._parent.state.fontSizeMultiplier,
                        learnedWords: this._parent.state.learnedWords,
                        isAutoplayEnabled: this._parent.state.isAutoplayEnabled
                    };
                    localStorage.setItem(this._parent.config.SETTINGS_KEY, JSON.stringify(settings));
                } catch (e) {
                    console.error("Error saving settings:", e);
                }
            },
            addLearnedWord(storyId, word) {
                if (!this._parent.state.learnedWords[storyId]) {
                    this._parent.state.learnedWords[storyId] = [];
                }
                const cleanWord = word.toLowerCase().replace(/^[.,;!?:“”"]+|[.,;!?:“”"]+$/g, '');
                if (!this._parent.state.learnedWords[storyId].includes(cleanWord)) {
                    this._parent.state.learnedWords[storyId].push(cleanWord);
                    this.saveSettings();
                }
            },
            changeFontSize(direction) {
                let newSize = this._parent.state.fontSizeMultiplier + (direction * 0.1);
                newSize = Math.max(0.7, Math.min(1.5, newSize));
                this._parent.state.fontSizeMultiplier = newSize;
                this.applyFontSize();
                this.saveSettings();
            },
            applyFontSize() {
                const multiplier = this._parent.state.fontSizeMultiplier;
                document.documentElement.style.setProperty('--story-font-size-multiplier', multiplier);
                this._parent.elements.fontSizeDisplay.textContent = `${Math.round(multiplier * 100)}%`;
            },
            toggleAutoplay() {
                this._parent.SoundManager.play('click');
                this._parent.state.isAutoplayEnabled = this._parent.elements.autoplayToggle.checked;
                this.saveSettings();
            },
            applyAutoplaySetting() {
                if (this._parent.elements.autoplayToggle) {
                    this._parent.elements.autoplayToggle.checked = this._parent.state.isAutoplayEnabled;
                }
            }
        },

        async fetchPexelsImage(word) { try { const response = await fetch(`${this.config.PEXELS_WORKER_URL}/search?query=${encodeURIComponent(word)}&per_page=1`); if (!response.ok) throw new Error(`Error from Pexels worker: ${response.statusText}`); const data = await response.json(); return data.photos && data.photos.length > 0 ? data.photos[0].src.medium : null; } catch (error) { console.error("Error fetching image from Pexels:", error); return null; } },

        ActivityManager: {
            _parent: null,
            init(parent) { this._parent = parent; },
            _getBadgeForScore(score) {
                if (score === null || score === undefined || score < 1) return '<span class="activity-progress-badge badge-gray">No iniciado</span>';
                if (score < 100) return `<span class="activity-progress-badge badge-yellow">${score}%</span>`;
                return `<span class="activity-progress-badge badge-green">Completado</span>`;
            },
            showActivitiesView() {
                const currentStory = this._parent.state.currentStory;
                if (!currentStory || !currentStory.g || currentStory.g.length === 0) { this._parent.Modals.openGeneric('Actividades', '<p>No hay actividades disponibles para esta historia.</p>'); return; }
                this._parent.AudioPlayer.pause();
                const { t: title } = this._parent.Utils.parseTitle(currentStory.meta.t);
                this._parent.elements.activitiesSubtitle.textContent = title;
                let contentHTML = '';
                currentStory.g.forEach(game => {
                    const { t: gameTitle } = this._parent.Utils.parseTitle(game.t);
                    const activityData = this._parent.ProgressManager.getProgress(currentStory.id, game.id);
                    const progress = activityData ? activityData.progress : 0;
                    const badgeHTML = this._getBadgeForScore(progress);
                    const descriptions = { 1: "Ordena las palabras para formar frases de la historia.", 2: "Pon a prueba tu comprensión con estas preguntas.", 3: "Encuentra los pares de palabras y sus traducciones.", 4: "Usa las letras para rellenar el espacio en blanco." };
                    contentHTML += `<div class="p-4 bg-gray-800 border border-gray-700 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors game-selector relative shadow-lg" data-game-id="${game.id}">
                                        <div class="flex justify-between items-start gap-4"><h4 class="font-bold text-white text-lg">${gameTitle}</h4>${badgeHTML}</div>
                                        <p class="text-sm text-gray-400 mt-2">${descriptions[game.id] || "Un nuevo desafío te espera."}</p>
                                    </div>`;
                });
                this._parent.elements.activitiesList.innerHTML = contentHTML;
                this._parent.elements.activitiesList.querySelectorAll('.game-selector').forEach(el => { el.onclick = () => { const gameId = parseInt(el.dataset.gameId, 10); this.startGame(gameId); }; });
                this._parent.showScreen('activities');
            },
            startGame(gameId) {
                this._parent.SoundManager.play('select');
                const gameData = this._parent.state.currentStory.g.find(g => g.id === gameId);
                if (!gameData) { console.error(`Juego con id ${gameId} no encontrado.`); return; }
                this._parent.showScreen('game');
                
                const dependencies = {
                    saveProgress: (storyId, gameId, progress, errors) => this._parent.ProgressManager.saveProgress(storyId, gameId, progress, errors),
                    fetchPexels: (word) => this._parent.fetchPexelsImage(word),
                    onClose: () => { this._parent.state.activeGame = null; this._parent.ActivityManager.showActivitiesView(); },
                    playSound: (name) => this._parent.SoundManager.play(name)
                };

                const storyId = this._parent.state.currentStory.id;
                const glossary = this._parent.state.glossary;
                let gameModule;
                switch(gameId) {
                    case 1: gameModule = JumbledSentencesGame; break;
                    case 2: gameModule = QuizGame; break;
                    case 3: gameModule = MemoryCardsGame; break;
                    case 4: gameModule = FillTheBlanksGame; break;
                    default: 
                        this._parent.Modals.openGeneric('Próximamente', '<p>Este juego aún no está implementado.</p>');
                        this._parent.showScreen('activities');
                        return;
                }
                this._parent.state.activeGame = gameModule;
                if (gameId === 1) { gameModule.init(gameData, glossary, storyId, dependencies); } 
                else { gameModule.init(gameData, storyId, dependencies); }
            }
        }
    };
    
    App.ProgressManager.init(App);
    App.AudioPlayer.init(App);
    App.Modals.init(App);
    App.ActivityManager.init(App);
    App.init();
    window.App = App;
});
</script>
</body>
</html>

